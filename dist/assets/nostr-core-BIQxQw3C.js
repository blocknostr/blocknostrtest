var Vo=Object.defineProperty;var Zo=(r,e,t)=>e in r?Vo(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var y=(r,e,t)=>Zo(r,typeof e!="symbol"?e+"":e,t);import{j as H,I as Mn,Z as _n,S as In,W as Go,L as Jo,T as Yo,C as Qo,a as Xo}from"./ui-components-D19htCb-.js";import{r as K}from"./react-vendor-CGP8wbrH.js";const es=10*60*1e3,ei=7*24*60*60*1e3,Bt={EVENTS:"nostr_cached_events",PROFILES:"nostr_cached_profiles",FEEDS:"nostr_cached_feeds",MUTE_LIST:"nostr_mute_list",BLOCK_LIST:"nostr_block_list"};class Hr{constructor(e,t){y(this,"cache",new Map);y(this,"config");y(this,"storageKey");y(this,"offlineMode",!1);y(this,"maxStorageRetries",3);this.config=e,this.storageKey=t}setOfflineMode(e){this.offlineMode=e}cacheItem(e,t,n=!1){this.cache.set(e,{data:t,timestamp:Date.now(),important:n}),n&&this.storageKey&&this.persistToStorage()}getItem(e){const t=this.cache.get(e);if(!t)return null;const n=this.offlineMode||t.important?this.config.offlineExpiry:this.config.standardExpiry;return Date.now()-t.timestamp>n?(!this.offlineMode&&!t.important&&this.cache.delete(e),this.offlineMode?t.data:null):t.data}cleanupExpiredEntries(){const e=Date.now();this.cache.forEach((t,n)=>{const s=this.offlineMode||t.important?this.config.offlineExpiry:this.config.standardExpiry;e-t.timestamp>s&&!this.offlineMode&&this.cache.delete(n)})}clear(){if(this.cache.clear(),this.storageKey)try{localStorage.removeItem(this.storageKey)}catch(e){console.warn(`Error clearing storage for ${this.storageKey}:`,e)}}persistToStorage(){if(this.storageKey)try{const e=Array.from(this.cache.entries()).filter(([t,n])=>n.important).reduce((t,[n,s])=>(t[n]=s,t),{});Object.keys(e).length>0&&this.attemptStorageSave(e)}catch(e){console.error(`Failed to persist ${this.storageKey} to storage:`,e)}}attemptStorageSave(e,t=0){var n,s;try{const o=JSON.stringify(e);return localStorage.setItem(this.storageKey,o),!0}catch(o){if(o.name==="QuotaExceededError"||(n=o.message)!=null&&n.includes("quota")||(s=o.message)!=null&&s.includes("storage")){if(t>=this.maxStorageRetries)return console.warn(`Storage quota exceeded for ${this.storageKey}, giving up after ${t} retries`),!1;const i=Object.entries(e),a=i.slice(0,Math.floor(i.length/2));if(a.length>0){const c=a.reduce((l,[h,u])=>(l[h]=u,l),{});return console.warn(`Storage quota exceeded. Retrying with ${a.length} items (reduced from ${i.length})`),this.attemptStorageSave(c,t+1)}return!1}return console.error(`Error saving to storage: ${o.message}`),!1}}loadFromStorage(){if(this.storageKey)try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);Object.entries(t).forEach(([n,s])=>{this.cache.set(n,s)})}}catch(e){console.error(`Failed to load ${this.storageKey} from storage:`,e)}}}class ur{static filterByAuthors(e,t){if(!t||t.length===0)return[];const n=new Set(t);return e.filter(s=>s.pubkey&&n.has(s.pubkey))}static filterByHashtag(e,t){if(!t)return e;const n=t.toLowerCase();return e.filter(s=>s.content&&s.content.toLowerCase().includes(`#${n}`)?!0:Array.isArray(s.tags)?s.tags.some(o=>Array.isArray(o)&&o.length>=2&&o[0]==="t"&&o[1].toLowerCase()===n):!1)}static filterByTimeRange(e,t,n){return e.filter(s=>!(t&&s.created_at<t||n&&s.created_at>n))}static applyFilters(e,t){let n=[...e];return t.authorPubkeys&&t.authorPubkeys.length>0&&(n=this.filterByAuthors(n,t.authorPubkeys)),t.hashtag&&(n=this.filterByHashtag(n,t.hashtag)),n=this.filterByTimeRange(n,t.since,t.until),t.mediaOnly&&(n=this.filterMediaPosts(n)),n.sort((s,o)=>o.created_at-s.created_at),t.limit&&t.limit>0&&(n=n.slice(0,t.limit)),n}static filterMediaPosts(e){return e.filter(t=>t.content?/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|mov))/i.test(t.content)||/(https?:\/\/(?:i\.imgur\.com|i\.redd\.it|pbs\.twimg\.com|media\.tenor\.com|gfycat\.com|imgur\.com|giphy\.com|tenor\.com))/i.test(t.content)?!0:Array.isArray(t.tags)?t.tags.some(o=>Array.isArray(o)&&o.length>=2&&(o[0]==="image"||o[0]==="media")):!1:!1)}static generateFeedCacheKey(e){const t=[e.feedType];if(e.authorPubkeys&&e.authorPubkeys.length>0){const n=e.authorPubkeys.slice(0,3).join(",");t.push(`authors:${n}`)}if(e.hashtag&&t.push(`tag:${e.hashtag}`),e.since||e.until){const n=`time:${e.since||0}-${e.until||"now"}`;t.push(n)}return e.mediaOnly&&t.push("media-only"),t.join("::")}}class ti extends Hr{constructor(e){super(e,Bt.EVENTS),this.loadFromStorage()}cacheEvents(e,t=!1){const n=new Set([0,3,41]),s=new Map,o=[];e.forEach(i=>{var a;if(i.id)if(n.has(i.kind)){const c=`${i.pubkey}:${i.kind}`,l=s.get(c);(!l||i.created_at>l.created_at)&&s.set(c,i)}else if(i.kind>=1e4&&i.kind<2e4){const c=((a=i.tags.find(u=>u[0]==="d"))==null?void 0:a[1])||"",l=`${i.pubkey}:${i.kind}:${c}`,h=s.get(l);(!h||i.created_at>h.created_at)&&s.set(l,i)}else o.push(i)}),o.forEach(i=>{i.id&&this.cacheItem(i.id,i,t)}),s.forEach(i=>{i.id&&this.cacheItem(i.id,i,t)})}getAllEvents(){const e=[],t=Date.now(),n=this.offlineMode?this.config.offlineExpiry:this.config.standardExpiry;return this.cache.forEach(s=>{t-s.timestamp>n&&!this.offlineMode&&!s.important||e.push(s.data)}),e}getEventsByAuthors(e){const t=this.getAllEvents();return ur.filterByAuthors(t,e)}getEventsByHashtag(e){const t=this.getAllEvents();return ur.filterByHashtag(t,e)}getFilteredEvents(e){const t=this.getAllEvents();return ur.applyFilters(t,e)}}const Je=class Je{constructor(){y(this,"profileCache",new Map);y(this,"daoCache",new Map);y(this,"genericCache",new Map);y(this,"profileHotCache",new Map);y(this,"profileAccessCounts",new Map);y(this,"prefetchQueue",[]);y(this,"backgroundRefreshTimer",null);y(this,"offlineMode",!1);y(this,"defaultTTL",{profile:5*60*1e3,dao:3*60*1e3,generic:5*60*1e3});y(this,"HOT_CACHE_TTL",2*60*1e3);y(this,"FREQUENT_ACCESS_THRESHOLD",3);y(this,"PREFETCH_QUEUE_SIZE",20);y(this,"PREFETCH_BATCH_SIZE",5);this.startCacheCleanup(),this.startBackgroundRefresh()}static getInstance(){return Je.instance||(Je.instance=new Je),Je.instance}setOfflineMode(e){this.offlineMode=e,console.log(`[UnifiedCacheManager] Offline mode: ${e?"enabled":"disabled"}`)}isOffline(){return this.offlineMode}get(e,t="generic"){const n=this.getCacheForDomain(t),s=n.get(e);return s?Date.now()>s.expiresAt?(n.delete(e),null):s.data:null}set(e,t,n,s="generic"){const o=this.getCacheForDomain(s),i=Date.now(),a=i+(n||this.defaultTTL[s]);o.set(e,{data:t,timestamp:i,expiresAt:a})}has(e,t="generic"){const n=this.getCacheForDomain(t),s=n.get(e);return s?Date.now()>s.expiresAt?(n.delete(e),!1):!0:!1}delete(e,t="generic"){const n=this.getCacheForDomain(t);if(t==="profile"&&e.startsWith("profile:")){const s=e.replace("profile:","");this.profileHotCache.delete(s)}return n.delete(e)}clear(e){e?(this.getCacheForDomain(e).clear(),e==="profile"&&(this.profileHotCache.clear(),this.profileAccessCounts.clear(),this.prefetchQueue=[])):(this.profileCache.clear(),this.daoCache.clear(),this.genericCache.clear(),this.profileHotCache.clear(),this.profileAccessCounts.clear(),this.prefetchQueue=[])}getProfile(e){if(this.trackProfileAccess(e),this.profileHotCache.has(e))return this.profileHotCache.get(e);const t=this.get(`profile:${e}`,"profile");return t&&this.isFrequentlyAccessed(e)&&(this.profileHotCache.set(e,t),setTimeout(()=>{this.profileHotCache.delete(e)},this.HOT_CACHE_TTL)),t}setProfile(e,t,n){this.set(`profile:${e}`,t,n,"profile"),this.isFrequentlyAccessed(e)&&this.profileHotCache.set(e,t),this.queueRelatedProfilesForPrefetch(t)}cacheItem(e,t,n=!1){if(t)try{t&&!t._createdAt&&t.created_at&&(t._createdAt=t.created_at),this.setProfile(e,t)}catch(s){console.error(`Error caching profile for ${e}:`,s)}}getItem(e){return this.getProfile(e)}hasProfile(e){return this.profileHotCache.has(e)||this.has(`profile:${e}`,"profile")}deleteProfile(e){return this.profileHotCache.delete(e),this.profileAccessCounts.delete(e),this.delete(`profile:${e}`,"profile")}getProfileKeys(){const e=Array.from(this.profileCache.keys()).filter(n=>n.startsWith("profile:")).map(n=>n.replace("profile:","")),t=Array.from(this.profileHotCache.keys());return[...new Set([...e,...t])]}cleanupExpiredEntries(){this.cleanupExpiredEntriesInternal()}trackProfileAccess(e){const t=this.profileAccessCounts.get(e)||0;this.profileAccessCounts.set(e,t+1),this.profileAccessCounts.size>1e3&&this.normalizeAccessCounts()}isFrequentlyAccessed(e){return(this.profileAccessCounts.get(e)||0)>this.FREQUENT_ACCESS_THRESHOLD}normalizeAccessCounts(){this.profileAccessCounts.forEach((e,t)=>{this.profileAccessCounts.set(t,Math.max(1,Math.floor(e/2)))})}queueRelatedProfilesForPrefetch(e){if(!e)return;const t=[];e.about&&(e.about.match(/nostr:npub[a-z0-9]{59}/g)||[]).forEach(o=>{const i=o.replace("nostr:","");t.push(i)}),e.relatedProfiles&&Array.isArray(e.relatedProfiles)&&e.relatedProfiles.forEach(s=>{t.push(s)});const n=[...new Set(t)].slice(0,this.PREFETCH_BATCH_SIZE);this.prefetchQueue.push(...n),this.prefetchQueue.length>this.PREFETCH_QUEUE_SIZE&&(this.prefetchQueue=this.prefetchQueue.slice(-this.PREFETCH_QUEUE_SIZE))}startBackgroundRefresh(){this.backgroundRefreshTimer&&clearInterval(this.backgroundRefreshTimer),this.backgroundRefreshTimer=window.setInterval(()=>{this.processPrefetchQueue()},5*60*1e3)}processPrefetchQueue(){const e=this.prefetchQueue.splice(0,this.PREFETCH_BATCH_SIZE);e.length!==0&&console.log(`[UnifiedCacheManager] Background prefetching ${e.length} profiles`,e)}getAllDAOs(){return this.get("daos:all","dao")}setAllDAOs(e,t){this.set("daos:all",e,t,"dao")}getUserDAOs(e){return this.get(`daos:user:${e}`,"dao")}setUserDAOs(e,t,n){this.set(`daos:user:${e}`,t,n,"dao")}getTrendingDAOs(){return this.get("daos:trending","dao")}setTrendingDAOs(e,t){this.set("daos:trending",e,t,"dao")}getDAO(e){return this.get(`dao:${e}`,"dao")}setDAO(e,t,n){this.set(`dao:${e}`,t,n,"dao")}getDAOProposals(e){return this.get(`proposals:${e}`,"dao")}setDAOProposals(e,t,n){this.set(`proposals:${e}`,t,n,"dao")}invalidateDAO(e){this.delete(`dao:${e}`,"dao"),this.delete(`proposals:${e}`,"dao")}getKeysWithPrefix(e,t="generic"){const n=this.getCacheForDomain(t);return Array.from(n.keys()).filter(s=>s.startsWith(e))}deleteKeysWithPrefix(e,t="generic"){const n=this.getCacheForDomain(t);let s=0;for(const o of this.getKeysWithPrefix(e,t))n.delete(o)&&s++;return s}getStats(){const e=Date.now(),t=i=>{let a=0;return i.forEach(c=>{e>c.expiresAt&&a++}),{size:i.size,expired:a}},n=t(this.profileCache),s=t(this.daoCache),o=t(this.genericCache);return{profile:n,dao:s,generic:o,hotCache:{size:this.profileHotCache.size,expired:0},total:{size:n.size+s.size+o.size+this.profileHotCache.size,expired:n.expired+s.expired+o.expired}}}getCacheForDomain(e){switch(e){case"profile":return this.profileCache;case"dao":return this.daoCache;case"generic":return this.genericCache;default:return this.genericCache}}startCacheCleanup(){setInterval(()=>{this.cleanupExpiredEntriesInternal()},6e4)}cleanupExpiredEntriesInternal(){const e=Date.now();for(const[t,n]of this.profileCache.entries())e>n.expiresAt&&this.profileCache.delete(t);for(const[t,n]of this.daoCache.entries())e>n.expiresAt&&this.daoCache.delete(t);for(const[t,n]of this.genericCache.entries())e>n.expiresAt&&this.genericCache.delete(t)}dispose(){this.backgroundRefreshTimer&&(clearInterval(this.backgroundRefreshTimer),this.backgroundRefreshTimer=null),this.clear()}};y(Je,"instance");let Rr=Je;const it=Rr.getInstance();class ri extends Hr{constructor(e){super(e)}}class ni extends Hr{constructor(e){super(e,Bt.FEEDS),this.loadFromStorage()}cacheFeed(e,t,n,s=!1){const o=this.generateCacheKey(e,n);this.cacheItem(o,t,s)}getFeed(e,t){const n=this.generateCacheKey(e,t);return this.getItem(n)}clearFeed(e,t){const n=this.generateCacheKey(e,t);this.cache.delete(n),this.persistToStorage()}clearFeedType(e){const t=[];this.cache.forEach((n,s)=>{s.startsWith(e+"::")&&t.push(s)}),t.forEach(n=>this.cache.delete(n)),this.persistToStorage()}hasFeed(e,t){const n=this.generateCacheKey(e,t);return this.cache.has(n)}getRawEntry(e){return this.cache.has(e)&&this.cache.get(e)||null}generateCacheKey(e,t){const n=[e];if(t.authorPubkeys&&t.authorPubkeys.length>0){const s=[...t.authorPubkeys].sort(),o=s.slice(0,3).join(",");n.push(`authors:${o}`),s.length>3&&n.push(`author_count:${s.length}`)}if(t.hashtag&&n.push(`tag:${t.hashtag.toLowerCase()}`),t.hashtags&&t.hashtags.length>0){const s=[...t.hashtags].sort(),o=s.slice(0,5).map(i=>i.toLowerCase()).join(",");n.push(`tags:${o}`),s.length>5&&n.push(`tags_count:${s.length}`)}if(t.since||t.until){const s=`time:${t.since||0}-${t.until||"now"}`;n.push(s)}return t.mediaOnly&&n.push("media-only"),n.join("::")}}class Pn{constructor(e){y(this,"_list",null);y(this,"storageKey");this.storageKey=e}cacheList(e){this._list=e,localStorage.setItem(this.storageKey,JSON.stringify(e))}getList(){if(this._list)return this._list;const e=localStorage.getItem(this.storageKey);if(e)try{const t=JSON.parse(e);return this._list=t,t}catch(t){console.error(`Error parsing ${this.storageKey} from storage:`,t)}return null}clear(){this._list=null,localStorage.removeItem(this.storageKey)}}let si={data:""},oi=r=>typeof window=="object"?((r?r.querySelector("#_goober"):window._goober)||Object.assign((r||document.head).appendChild(document.createElement("style")),{innerHTML:" ",id:"_goober"})).firstChild:r||si,ii=/(?:([\u0080-\uFFFF\w-%@]+) *:? *([^{;]+?);|([^;}{]*?) *{)|(}\s*)/g,ai=/\/\*[^]*?\*\/|  +/g,kn=/\n+/g,De=(r,e)=>{let t="",n="",s="";for(let o in r){let i=r[o];o[0]=="@"?o[1]=="i"?t=o+" "+i+";":n+=o[1]=="f"?De(i,o):o+"{"+De(i,o[1]=="k"?"":e)+"}":typeof i=="object"?n+=De(i,e?e.replace(/([^,])+/g,a=>o.replace(/([^,]*:\S+\([^)]*\))|([^,])+/g,c=>/&/.test(c)?c.replace(/&/g,a):a?a+" "+c:c)):o):i!=null&&(o=/^--/.test(o)?o:o.replace(/[A-Z]/g,"-$&").toLowerCase(),s+=De.p?De.p(o,i):o+":"+i+";")}return t+(e&&s?e+"{"+s+"}":s)+n},Te={},ts=r=>{if(typeof r=="object"){let e="";for(let t in r)e+=t+ts(r[t]);return e}return r},ci=(r,e,t,n,s)=>{let o=ts(r),i=Te[o]||(Te[o]=(c=>{let l=0,h=11;for(;l<c.length;)h=101*h+c.charCodeAt(l++)>>>0;return"go"+h})(o));if(!Te[i]){let c=o!==r?r:(l=>{let h,u,f=[{}];for(;h=ii.exec(l.replace(ai,""));)h[4]?f.shift():h[3]?(u=h[3].replace(kn," ").trim(),f.unshift(f[0][u]=f[0][u]||{})):f[0][h[1]]=h[2].replace(kn," ").trim();return f[0]})(r);Te[i]=De(s?{["@keyframes "+i]:c}:c,t?"":"."+i)}let a=t&&Te.g?Te.g:null;return t&&(Te.g=Te[i]),((c,l,h,u)=>{u?l.data=l.data.replace(u,c):l.data.indexOf(c)===-1&&(l.data=h?c+l.data:l.data+c)})(Te[i],e,n,a),i},li=(r,e,t)=>r.reduce((n,s,o)=>{let i=e[o];if(i&&i.call){let a=i(t),c=a&&a.props&&a.props.className||/^go/.test(a)&&a;i=c?"."+c:a&&typeof a=="object"?a.props?"":De(a,""):a===!1?"":a}return n+s+(i??"")},"");function Vt(r){let e=this||{},t=r.call?r(e.p):r;return ci(t.unshift?t.raw?li(t,[].slice.call(arguments,1),e.p):t.reduce((n,s)=>Object.assign(n,s&&s.call?s(e.p):s),{}):t,oi(e.target),e.g,e.o,e.k)}let rs,Tr,Cr;Vt.bind({g:1});let Ie=Vt.bind({k:1});function ui(r,e,t,n){De.p=e,rs=r,Tr=t,Cr=n}function je(r,e){let t=this||{};return function(){let n=arguments;function s(o,i){let a=Object.assign({},o),c=a.className||s.className;t.p=Object.assign({theme:Tr&&Tr()},a),t.o=/ *go\d+/.test(c),a.className=Vt.apply(t,n)+(c?" "+c:"");let l=r;return r[0]&&(l=a.as||r,delete a.as),Cr&&l[0]&&Cr(a),rs(l,a)}return s}}var hi=r=>typeof r=="function",Dt=(r,e)=>hi(r)?r(e):r,fi=(()=>{let r=0;return()=>(++r).toString()})(),ns=(()=>{let r;return()=>{if(r===void 0&&typeof window<"u"){let e=matchMedia("(prefers-reduced-motion: reduce)");r=!e||e.matches}return r}})(),di=20,ss=(r,e)=>{switch(e.type){case 0:return{...r,toasts:[e.toast,...r.toasts].slice(0,di)};case 1:return{...r,toasts:r.toasts.map(o=>o.id===e.toast.id?{...o,...e.toast}:o)};case 2:let{toast:t}=e;return ss(r,{type:r.toasts.find(o=>o.id===t.id)?1:0,toast:t});case 3:let{toastId:n}=e;return{...r,toasts:r.toasts.map(o=>o.id===n||n===void 0?{...o,dismissed:!0,visible:!1}:o)};case 4:return e.toastId===void 0?{...r,toasts:[]}:{...r,toasts:r.toasts.filter(o=>o.id!==e.toastId)};case 5:return{...r,pausedAt:e.time};case 6:let s=e.time-(r.pausedAt||0);return{...r,pausedAt:void 0,toasts:r.toasts.map(o=>({...o,pauseDuration:o.pauseDuration+s}))}}},Nt=[],Qe={toasts:[],pausedAt:void 0},rt=r=>{Qe=ss(Qe,r),Nt.forEach(e=>{e(Qe)})},gi={blank:4e3,error:4e3,success:2e3,loading:1/0,custom:4e3},pi=(r={})=>{let[e,t]=K.useState(Qe),n=K.useRef(Qe);K.useEffect(()=>(n.current!==Qe&&t(Qe),Nt.push(t),()=>{let o=Nt.indexOf(t);o>-1&&Nt.splice(o,1)}),[]);let s=e.toasts.map(o=>{var i,a,c;return{...r,...r[o.type],...o,removeDelay:o.removeDelay||((i=r[o.type])==null?void 0:i.removeDelay)||(r==null?void 0:r.removeDelay),duration:o.duration||((a=r[o.type])==null?void 0:a.duration)||(r==null?void 0:r.duration)||gi[o.type],style:{...r.style,...(c=r[o.type])==null?void 0:c.style,...o.style}}});return{...e,toasts:s}},yi=(r,e="blank",t)=>({createdAt:Date.now(),visible:!0,dismissed:!1,type:e,ariaProps:{role:"status","aria-live":"polite"},message:r,pauseDuration:0,...t,id:(t==null?void 0:t.id)||fi()}),Mt=r=>(e,t)=>{let n=yi(e,r,t);return rt({type:2,toast:n}),n.id},se=(r,e)=>Mt("blank")(r,e);se.error=Mt("error");se.success=Mt("success");se.loading=Mt("loading");se.custom=Mt("custom");se.dismiss=r=>{rt({type:3,toastId:r})};se.remove=r=>rt({type:4,toastId:r});se.promise=(r,e,t)=>{let n=se.loading(e.loading,{...t,...t==null?void 0:t.loading});return typeof r=="function"&&(r=r()),r.then(s=>{let o=e.success?Dt(e.success,s):void 0;return o?se.success(o,{id:n,...t,...t==null?void 0:t.success}):se.dismiss(n),s}).catch(s=>{let o=e.error?Dt(e.error,s):void 0;o?se.error(o,{id:n,...t,...t==null?void 0:t.error}):se.dismiss(n)}),r};var mi=(r,e)=>{rt({type:1,toast:{id:r,height:e}})},wi=()=>{rt({type:5,time:Date.now()})},xt=new Map,bi=1e3,vi=(r,e=bi)=>{if(xt.has(r))return;let t=setTimeout(()=>{xt.delete(r),rt({type:4,toastId:r})},e);xt.set(r,t)},Ei=r=>{let{toasts:e,pausedAt:t}=pi(r);K.useEffect(()=>{if(t)return;let o=Date.now(),i=e.map(a=>{if(a.duration===1/0)return;let c=(a.duration||0)+a.pauseDuration-(o-a.createdAt);if(c<0){a.visible&&se.dismiss(a.id);return}return setTimeout(()=>se.dismiss(a.id),c)});return()=>{i.forEach(a=>a&&clearTimeout(a))}},[e,t]);let n=K.useCallback(()=>{t&&rt({type:6,time:Date.now()})},[t]),s=K.useCallback((o,i)=>{let{reverseOrder:a=!1,gutter:c=8,defaultPosition:l}=i||{},h=e.filter(g=>(g.position||l)===(o.position||l)&&g.height),u=h.findIndex(g=>g.id===o.id),f=h.filter((g,m)=>m<u&&g.visible).length;return h.filter(g=>g.visible).slice(...a?[f+1]:[0,f]).reduce((g,m)=>g+(m.height||0)+c,0)},[e]);return K.useEffect(()=>{e.forEach(o=>{if(o.dismissed)vi(o.id,o.removeDelay);else{let i=xt.get(o.id);i&&(clearTimeout(i),xt.delete(o.id))}})},[e]),{toasts:e,handlers:{updateHeight:mi,startPause:wi,endPause:n,calculateOffset:s}}},xi=Ie`
from {
  transform: scale(0) rotate(45deg);
	opacity: 0;
}
to {
 transform: scale(1) rotate(45deg);
  opacity: 1;
}`,Ai=Ie`
from {
  transform: scale(0);
  opacity: 0;
}
to {
  transform: scale(1);
  opacity: 1;
}`,Si=Ie`
from {
  transform: scale(0) rotate(90deg);
	opacity: 0;
}
to {
  transform: scale(1) rotate(90deg);
	opacity: 1;
}`,Ri=je("div")`
  width: 20px;
  opacity: 0;
  height: 20px;
  border-radius: 10px;
  background: ${r=>r.primary||"#ff4b4b"};
  position: relative;
  transform: rotate(45deg);

  animation: ${xi} 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
  animation-delay: 100ms;

  &:after,
  &:before {
    content: '';
    animation: ${Ai} 0.15s ease-out forwards;
    animation-delay: 150ms;
    position: absolute;
    border-radius: 3px;
    opacity: 0;
    background: ${r=>r.secondary||"#fff"};
    bottom: 9px;
    left: 4px;
    height: 2px;
    width: 12px;
  }

  &:before {
    animation: ${Si} 0.15s ease-out forwards;
    animation-delay: 180ms;
    transform: rotate(90deg);
  }
`,Ti=Ie`
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
`,Ci=je("div")`
  width: 12px;
  height: 12px;
  box-sizing: border-box;
  border: 2px solid;
  border-radius: 100%;
  border-color: ${r=>r.secondary||"#e0e0e0"};
  border-right-color: ${r=>r.primary||"#616161"};
  animation: ${Ti} 1s linear infinite;
`,Mi=Ie`
from {
  transform: scale(0) rotate(45deg);
	opacity: 0;
}
to {
  transform: scale(1) rotate(45deg);
	opacity: 1;
}`,_i=Ie`
0% {
	height: 0;
	width: 0;
	opacity: 0;
}
40% {
  height: 0;
	width: 6px;
	opacity: 1;
}
100% {
  opacity: 1;
  height: 10px;
}`,Ii=je("div")`
  width: 20px;
  opacity: 0;
  height: 20px;
  border-radius: 10px;
  background: ${r=>r.primary||"#61d345"};
  position: relative;
  transform: rotate(45deg);

  animation: ${Mi} 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
  animation-delay: 100ms;
  &:after {
    content: '';
    box-sizing: border-box;
    animation: ${_i} 0.2s ease-out forwards;
    opacity: 0;
    animation-delay: 200ms;
    position: absolute;
    border-right: 2px solid;
    border-bottom: 2px solid;
    border-color: ${r=>r.secondary||"#fff"};
    bottom: 6px;
    left: 6px;
    height: 10px;
    width: 6px;
  }
`,Pi=je("div")`
  position: absolute;
`,ki=je("div")`
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  min-width: 20px;
  min-height: 20px;
`,$i=Ie`
from {
  transform: scale(0.6);
  opacity: 0.4;
}
to {
  transform: scale(1);
  opacity: 1;
}`,Ni=je("div")`
  position: relative;
  transform: scale(0.6);
  opacity: 0.4;
  min-width: 20px;
  animation: ${$i} 0.3s 0.12s cubic-bezier(0.175, 0.885, 0.32, 1.275)
    forwards;
`,Li=({toast:r})=>{let{icon:e,type:t,iconTheme:n}=r;return e!==void 0?typeof e=="string"?K.createElement(Ni,null,e):e:t==="blank"?null:K.createElement(ki,null,K.createElement(Ci,{...n}),t!=="loading"&&K.createElement(Pi,null,t==="error"?K.createElement(Ri,{...n}):K.createElement(Ii,{...n})))},Oi=r=>`
0% {transform: translate3d(0,${r*-200}%,0) scale(.6); opacity:.5;}
100% {transform: translate3d(0,0,0) scale(1); opacity:1;}
`,Ui=r=>`
0% {transform: translate3d(0,0,-1px) scale(1); opacity:1;}
100% {transform: translate3d(0,${r*-150}%,-1px) scale(.6); opacity:0;}
`,Bi="0%{opacity:0;} 100%{opacity:1;}",Di="0%{opacity:1;} 100%{opacity:0;}",Fi=je("div")`
  display: flex;
  align-items: center;
  background: #fff;
  color: #363636;
  line-height: 1.3;
  will-change: transform;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1), 0 3px 3px rgba(0, 0, 0, 0.05);
  max-width: 350px;
  pointer-events: auto;
  padding: 8px 10px;
  border-radius: 8px;
`,Hi=je("div")`
  display: flex;
  justify-content: center;
  margin: 4px 10px;
  color: inherit;
  flex: 1 1 auto;
  white-space: pre-line;
`,Ki=(r,e)=>{let t=r.includes("top")?1:-1,[n,s]=ns()?[Bi,Di]:[Oi(t),Ui(t)];return{animation:e?`${Ie(n)} 0.35s cubic-bezier(.21,1.02,.73,1) forwards`:`${Ie(s)} 0.4s forwards cubic-bezier(.06,.71,.55,1)`}},Wi=K.memo(({toast:r,position:e,style:t,children:n})=>{let s=r.height?Ki(r.position||e||"top-center",r.visible):{opacity:0},o=K.createElement(Li,{toast:r}),i=K.createElement(Hi,{...r.ariaProps},Dt(r.message,r));return K.createElement(Fi,{className:r.className,style:{...s,...t,...r.style}},typeof n=="function"?n({icon:o,message:i}):K.createElement(K.Fragment,null,o,i))});ui(K.createElement);var qi=({id:r,className:e,style:t,onHeightUpdate:n,children:s})=>{let o=K.useCallback(i=>{if(i){let a=()=>{let c=i.getBoundingClientRect().height;n(r,c)};a(),new MutationObserver(a).observe(i,{subtree:!0,childList:!0,characterData:!0})}},[r,n]);return K.createElement("div",{ref:o,className:e,style:t},s)},ji=(r,e)=>{let t=r.includes("top"),n=t?{top:0}:{bottom:0},s=r.includes("center")?{justifyContent:"center"}:r.includes("right")?{justifyContent:"flex-end"}:{};return{left:0,right:0,display:"flex",position:"absolute",transition:ns()?void 0:"all 230ms cubic-bezier(.21,1.02,.73,1)",transform:`translateY(${e*(t?1:-1)}px)`,...n,...s}},zi=Vt`
  z-index: 9999;
  > * {
    pointer-events: auto;
  }
`,It=16,If=({reverseOrder:r,position:e="top-center",toastOptions:t,gutter:n,children:s,containerStyle:o,containerClassName:i})=>{let{toasts:a,handlers:c}=Ei(t);return K.createElement("div",{id:"_rht_toaster",style:{position:"fixed",zIndex:9999,top:It,left:It,right:It,bottom:It,pointerEvents:"none",...o},className:i,onMouseEnter:c.startPause,onMouseLeave:c.endPause},a.map(l=>{let h=l.position||e,u=c.calculateOffset(l,{reverseOrder:r,gutter:n,defaultPosition:e}),f=ji(h,u);return K.createElement(qi,{id:l.id,key:l.id,onHeightUpdate:c.updateHeight,className:l.visible?zi:"",style:f},l.type==="custom"?Dt(l.message,l):s?s(l):K.createElement(Wi,{toast:l,position:h}))}))},q=se;const Vi=r=>{switch(r){case"success":return Xo;case"error":return Qo;case"warning":return Yo;case"info":return Mn;case"loading":return Jo;case"nostr":return In;case"crypto":return _n;case"relay":return Go;case"auth":return In;case"zap":return _n;default:return Mn}},Zi=r=>{switch(r){case"success":return{bg:"bg-emerald-500/10 dark:bg-emerald-400/10",border:"border-emerald-500/20 dark:border-emerald-400/20",icon:"text-emerald-600 dark:text-emerald-400",text:"text-emerald-900 dark:text-emerald-100"};case"error":return{bg:"bg-red-500/10 dark:bg-red-400/10",border:"border-red-500/20 dark:border-red-400/20",icon:"text-red-600 dark:text-red-400",text:"text-red-900 dark:text-red-100"};case"warning":return{bg:"bg-amber-500/10 dark:bg-amber-400/10",border:"border-amber-500/20 dark:border-amber-400/20",icon:"text-amber-600 dark:text-amber-400",text:"text-amber-900 dark:text-amber-100"};case"info":return{bg:"bg-blue-500/10 dark:bg-blue-400/10",border:"border-blue-500/20 dark:border-blue-400/20",icon:"text-blue-600 dark:text-blue-400",text:"text-blue-900 dark:text-blue-100"};case"loading":return{bg:"bg-slate-500/10 dark:bg-slate-400/10",border:"border-slate-500/20 dark:border-slate-400/20",icon:"text-slate-600 dark:text-slate-400",text:"text-slate-900 dark:text-slate-100"};case"nostr":return{bg:"bg-purple-500/10 dark:bg-purple-400/10",border:"border-purple-500/20 dark:border-purple-400/20",icon:"text-purple-600 dark:text-purple-400",text:"text-purple-900 dark:text-purple-100"};case"crypto":return{bg:"bg-orange-500/10 dark:bg-orange-400/10",border:"border-orange-500/20 dark:border-orange-400/20",icon:"text-orange-600 dark:text-orange-400",text:"text-orange-900 dark:text-orange-100"};case"relay":return{bg:"bg-cyan-500/10 dark:bg-cyan-400/10",border:"border-cyan-500/20 dark:border-cyan-400/20",icon:"text-cyan-600 dark:text-cyan-400",text:"text-cyan-900 dark:text-cyan-100"};case"auth":return{bg:"bg-indigo-500/10 dark:bg-indigo-400/10",border:"border-indigo-500/20 dark:border-indigo-400/20",icon:"text-indigo-600 dark:text-indigo-400",text:"text-indigo-900 dark:text-indigo-100"};case"zap":return{bg:"bg-yellow-500/10 dark:bg-yellow-400/10",border:"border-yellow-500/20 dark:border-yellow-400/20",icon:"text-yellow-600 dark:text-yellow-400",text:"text-yellow-900 dark:text-yellow-100"};default:return{bg:"bg-slate-500/10 dark:bg-slate-400/10",border:"border-slate-500/20 dark:border-slate-400/20",icon:"text-slate-600 dark:text-slate-400",text:"text-slate-900 dark:text-slate-100"}}},ve=({message:r,description:e,type:t,onClose:n})=>{const s=Vi(t),o=Zi(t);return H.jsxs("div",{className:`
      flex items-start gap-3 p-4 rounded-lg border backdrop-blur-sm
      ${o.bg} ${o.border}
      shadow-lg max-w-md w-full
      transform transition-all duration-300
    `,children:[H.jsx("div",{className:`flex-shrink-0 mt-0.5 ${o.icon}`,children:H.jsx(s,{className:`h-4 w-4 ${t==="loading"?"animate-spin":""}`})}),H.jsxs("div",{className:"flex-1 min-w-0",children:[H.jsx("div",{className:`text-sm font-medium ${o.text}`,children:r}),e&&H.jsx("div",{className:`text-xs mt-1 opacity-75 ${o.text}`,children:e})]}),H.jsx("button",{onClick:n,className:`flex-shrink-0 text-xs opacity-50 hover:opacity-100 transition-opacity ${o.text}`,children:"×"})]})},ce={success:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"success",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),error:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"error",onClose:()=>q.dismiss(t.id)}),{duration:6e3}),warning:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"warning",onClose:()=>q.dismiss(t.id)}),{duration:5e3}),info:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"info",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),loading:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"loading",onClose:()=>q.dismiss(t.id)}),{duration:1/0}),nostr:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"nostr",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),crypto:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"crypto",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),relay:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"relay",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),auth:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"auth",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),zap:(r,e)=>q.custom(t=>H.jsx(ve,{message:r,description:e,type:"zap",onClose:()=>q.dismiss(t.id)}),{duration:4e3}),promise:(r,{loading:e,success:t,error:n})=>q.promise(r,{loading:e,success:t,error:n}),dismiss:r=>{q.dismiss(r)},remove:r=>{q.remove(r)}},ct={success:(r,e)=>ce.success(r,e==null?void 0:e.description),error:(r,e)=>ce.error(r,e==null?void 0:e.description),warning:(r,e)=>ce.warning(r,e==null?void 0:e.description),info:(r,e)=>ce.info(r,e==null?void 0:e.description),loading:(r,e)=>ce.loading(r,e==null?void 0:e.description),nostr:(r,e)=>ce.nostr(r,e==null?void 0:e.description),crypto:(r,e)=>ce.crypto(r,e==null?void 0:e.description),relay:(r,e)=>ce.relay(r,e==null?void 0:e.description),auth:(r,e)=>ce.auth(r,e==null?void 0:e.description),zap:(r,e)=>ce.zap(r,e==null?void 0:e.description),promise:ce.promise,dismiss:ce.dismiss,remove:ce.remove},Et={isStorageAPISupported(){return"storage"in navigator&&"estimate"in navigator.storage},async getEstimate(){if(!this.isStorageAPISupported())return console.warn("Storage API not supported in this browser"),null;try{const r=await navigator.storage.estimate(),e=r.quota||0,t=r.usage||0,n=e-t,s=e>0?t/e*100:0;return{quota:e,usage:t,available:n,percentUsed:s}}catch(r){return console.error("Error estimating storage quota:",r),null}},async isApproachingQuota(r=80){const e=await this.getEstimate();return e?e.percentUsed>r:!1},safeSetItem(r,e,t=localStorage){try{return t.setItem(r,e),!0}catch(n){return n.name==="QuotaExceededError"||n.code===22||n.code===1014||n.message&&n.message.includes("quota")?(console.warn(`Storage quota exceeded when setting ${r}`),this.clearSpace(t),ct.warning("Storage space is limited. Some cached data was cleared."),!1):(console.error(`Error setting ${r} in storage:`,n),!1)}},clearSpace(r=localStorage){const e=[];for(let n=0;n<r.length;n++){const s=r.key(n);s&&(s.includes("user_")||s.includes("preferences_")||s.includes("settings_")||s.includes("auth_")||(s.includes("cache_")||s.includes("temp_")||s.includes("events_")||s.includes("feed_"))&&e.push(s))}const t=Math.ceil(e.length*.5);e.sort((n,s)=>{const o=n.match(/(\d+)/),i=s.match(/(\d+)/);return o&&i?Number(o[1])-Number(i[1]):0}),e.slice(0,t).forEach(n=>{try{r.removeItem(n),console.log(`Removed cached item: ${n}`)}catch(s){console.error(`Failed to remove ${n}:`,s)}}),console.log(`Cleared ${t}/${e.length} cache items`)},async logStorageMetrics(){const r=await this.getEstimate();r?console.log("Storage metrics:",{quota:this.formatBytes(r.quota),usage:this.formatBytes(r.usage),available:this.formatBytes(r.available),percentUsed:`${r.percentUsed.toFixed(1)}%`}):(console.log("Storage metrics not available"),console.log(`LocalStorage items: ${localStorage.length}`))},formatBytes(r){if(r===0)return"0 Bytes";const e=["Bytes","KB","MB","GB"],t=Math.floor(Math.log(r)/Math.log(1024));return parseFloat((r/Math.pow(1024,t)).toFixed(2))+" "+e[t]}};class Gi{constructor(){y(this,"eventCache");y(this,"threadCache");y(this,"_feedCache");y(this,"muteListCache");y(this,"blockListCache");y(this,"offlineMode",!1);const e={standardExpiry:es,offlineExpiry:ei};this.eventCache=new ti(e),this.threadCache=new ri(e),this._feedCache=new ni(e),this.muteListCache=new Pn(Bt.MUTE_LIST),this.blockListCache=new Pn(Bt.BLOCK_LIST),window.addEventListener("online",()=>{this.offlineMode=!1,this.updateOfflineMode(),console.log("App is online - using standard caching policy")}),window.addEventListener("offline",()=>{this.offlineMode=!0,this.updateOfflineMode(),console.log("App is offline - using extended caching policy")}),this.offlineMode=!navigator.onLine,this.updateOfflineMode(),setTimeout(()=>{Et.logStorageMetrics()},1e3)}updateOfflineMode(){this.eventCache.setOfflineMode(this.offlineMode),it.setOfflineMode(this.offlineMode),this.threadCache.setOfflineMode(this.offlineMode),this._feedCache.setOfflineMode(this.offlineMode)}get feedCache(){return this._feedCache}cacheEvent(e,t=!1){e.id&&this.eventCache.cacheItem(e.id,e,t)}getEvent(e){return this.eventCache.getItem(e)}cacheEvents(e,t=!1){Et.isApproachingQuota(80).then(n=>{if(n&&e.length>10){console.warn("Approaching storage quota. Limiting batch size."),this.eventCache.cacheEvents(e.slice(0,10),t);return}const s=50,o=Math.ceil(e.length/s);for(let i=0;i<o;i++){const a=i*s,c=Math.min(a+s,e.length),l=e.slice(a,c);try{this.eventCache.cacheEvents(l,t)}catch(h){console.error(`Error caching events batch ${i+1}/${o}:`,h);break}}}).catch(n=>{console.error("Error checking storage quota:",n),this.eventCache.cacheEvents(e.slice(0,10),t)})}getEventsByAuthors(e){return this.eventCache.getEventsByAuthors(e)}cacheProfile(e,t,n=!1){if(t)try{t&&!t._createdAt&&t.created_at&&(t._createdAt=t.created_at),it.cacheItem(e,t,n)}catch(s){if(console.error(`Error caching profile for ${e}:`,s),s instanceof DOMException&&s.name==="QuotaExceededError"){this.cleanupExpiredEntries();try{const o={name:t.name,display_name:t.display_name,picture:t.picture,nip05:t.nip05,_createdAt:t._createdAt||t.created_at};it.cacheItem(e,o,n)}catch(o){console.error("Failed to cache profile even with reduced data:",o)}}}}getProfile(e){return it.getItem(e)}cacheThread(e,t,n=!1){try{this.threadCache.cacheItem(e,t,n)}catch(s){if(console.error(`Error caching thread ${e}:`,s),t.length>5)try{const o=t.slice(0,5);this.threadCache.cacheItem(e,o,n)}catch(o){console.error("Failed to cache thread with reduced data:",o)}}}getThread(e){return this.threadCache.getItem(e)}cacheFeed(e,t,n,s=!1){Et.isApproachingQuota(80).then(o=>{if(o){console.warn(`Approaching storage quota, limiting feed cache for ${e}`);try{const i=t.slice(0,10);this._feedCache.cacheFeed(e,i,n,s)}catch(i){console.error(`Error caching limited feed for ${e}:`,i)}return}try{this._feedCache.cacheFeed(e,t,n,s)}catch(i){if(console.error(`Error caching feed ${e}:`,i),this.cleanupExpiredEntries(),t.length>5){const a=t.slice(0,Math.floor(t.length/2));console.warn(`Retrying with ${a.length} events (reduced from ${t.length})`);try{this._feedCache.cacheFeed(e,a,n,!1)}catch(c){console.error("Failed to cache even with reduced events:",c)}}}}).catch(o=>{console.error("Error checking storage quota:",o);try{this._feedCache.cacheFeed(e,t.slice(0,5),n,!1)}catch(i){console.error("Fallback caching failed:",i)}})}getFeed(e,t){return this._feedCache.getFeed(e,t)}cacheMuteList(e){try{this.muteListCache.cacheList(e)}catch(t){console.error("Error caching mute list:",t)}}getMuteList(){return this.muteListCache.getList()}cacheBlockList(e){try{this.blockListCache.cacheList(e)}catch(t){console.error("Error caching block list:",t)}}getBlockList(){return this.blockListCache.getList()}cleanupExpiredEntries(){console.log("Cleaning up expired cache entries..."),this.eventCache.cleanupExpiredEntries(),it.cleanupExpiredEntries(),this.threadCache.cleanupExpiredEntries(),this._feedCache.cleanupExpiredEntries(),Et.logStorageMetrics()}clearAll(){this.eventCache.clear(),it.clear("profile"),this.threadCache.clear(),this._feedCache.clear(),this.muteListCache.clear(),this.blockListCache.clear()}isOffline(){return this.offlineMode}}const Ft=new Gi;setInterval(()=>{Ft.cleanupExpiredEntries()},Math.min(es,6e4));setInterval(()=>{Et.isApproachingQuota(85).then(r=>{r&&(console.warn("Storage quota approaching limit, running proactive cleanup"),Ft.cleanupExpiredEntries())}).catch(r=>{console.error("Error checking quota:",r)})},3e5);function $n(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function os(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function Ji(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");$n(r.outputLen),$n(r.blockLen)}function Ht(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Yi(r,e){os(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}const hr=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const is=r=>r instanceof Uint8Array,fr=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Ee=(r,e)=>r<<32-e|r>>>e,Qi=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Qi)throw new Error("Non little-endian hardware is not supported");function Xi(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Kr(r){if(typeof r=="string"&&(r=Xi(r)),!is(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function ea(...r){const e=new Uint8Array(r.reduce((n,s)=>n+s.length,0));let t=0;return r.forEach(n=>{if(!is(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}let as=class{clone(){return this._cloneInto()}};function ta(r){const e=n=>r().update(Kr(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function cs(r=32){if(hr&&typeof hr.getRandomValues=="function")return hr.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function ra(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+l,a,n)}let na=class extends as{constructor(e,t,n,s){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=fr(this.buffer)}update(e){Ht(this);const{view:t,buffer:n,blockLen:s}=this;e=Kr(e);const o=e.length;for(let i=0;i<o;){const a=Math.min(s-this.pos,o-i);if(a===s){const c=fr(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ht(this),Yi(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>s-i&&(this.process(n,0),i=0);for(let u=i;u<s;u++)t[u]=0;ra(n,s-8,BigInt(this.length*8),o),this.process(n,0);const a=fr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,h[u],o)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.length=s,e.pos=a,e.finished=o,e.destroyed=i,s%t&&e.buffer.set(n),e}};const sa=(r,e,t)=>r&e^~r&t,oa=(r,e,t)=>r&e^r&t^e&t,ia=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Le=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Oe=new Uint32Array(64);let aa=class extends na{constructor(){super(64,32,8,!1),this.A=Le[0]|0,this.B=Le[1]|0,this.C=Le[2]|0,this.D=Le[3]|0,this.E=Le[4]|0,this.F=Le[5]|0,this.G=Le[6]|0,this.H=Le[7]|0}get(){const{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)Oe[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){const f=Oe[u-15],g=Oe[u-2],m=Ee(f,7)^Ee(f,18)^f>>>3,d=Ee(g,17)^Ee(g,19)^g>>>10;Oe[u]=d+Oe[u-7]+m+Oe[u-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:l,H:h}=this;for(let u=0;u<64;u++){const f=Ee(a,6)^Ee(a,11)^Ee(a,25),g=h+f+sa(a,c,l)+ia[u]+Oe[u]|0,d=(Ee(n,2)^Ee(n,13)^Ee(n,22))+oa(n,s,o)|0;h=l,l=c,c=a,a=i+g|0,i=o,o=s,s=n,n=g+d|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,o,i,a,c,l,h)}roundClean(){Oe.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const Mr=ta(()=>new aa);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ls=BigInt(0),Zt=BigInt(1),ca=BigInt(2),Gt=r=>r instanceof Uint8Array,la=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function ut(r){if(!Gt(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=la[r[t]];return e}function us(r){const e=r.toString(16);return e.length&1?`0${e}`:e}function Wr(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return BigInt(r===""?"0":`0x${r}`)}function ht(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);const e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){const s=n*2,o=r.slice(s,s+2),i=Number.parseInt(o,16);if(Number.isNaN(i)||i<0)throw new Error("Invalid byte sequence");t[n]=i}return t}function ie(r){return Wr(ut(r))}function qr(r){if(!Gt(r))throw new Error("Uint8Array expected");return Wr(ut(Uint8Array.from(r).reverse()))}function We(r,e){return ht(r.toString(16).padStart(e*2,"0"))}function jr(r,e){return We(r,e).reverse()}function ua(r){return ht(us(r))}function ee(r,e,t){let n;if(typeof e=="string")try{n=ht(e)}catch(o){throw new Error(`${r} must be valid hex string, got "${e}". Cause: ${o}`)}else if(Gt(e))n=Uint8Array.from(e);else throw new Error(`${r} must be hex string or Uint8Array`);const s=n.length;if(typeof t=="number"&&s!==t)throw new Error(`${r} expected ${t} bytes, got ${s}`);return n}function et(...r){const e=new Uint8Array(r.reduce((n,s)=>n+s.length,0));let t=0;return r.forEach(n=>{if(!Gt(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}function ha(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function fa(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function da(r){let e;for(e=0;r>ls;r>>=Zt,e+=1);return e}function ga(r,e){return r>>BigInt(e)&Zt}const pa=(r,e,t)=>r|(t?Zt:ls)<<BigInt(e),zr=r=>(ca<<BigInt(r-1))-Zt,dr=r=>new Uint8Array(r),Nn=r=>Uint8Array.from(r);function hs(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=dr(r),s=dr(r),o=0;const i=()=>{n.fill(1),s.fill(0),o=0},a=(...u)=>t(s,n,...u),c=(u=dr())=>{s=a(Nn([0]),u),n=a(),u.length!==0&&(s=a(Nn([1]),u),n=a())},l=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let u=0;const f=[];for(;u<e;){n=a();const g=n.slice();f.push(g),u+=n.length}return et(...f)};return(u,f)=>{i(),c(u);let g;for(;!(g=f(l()));)c();return i(),g}}const ya={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||r instanceof Uint8Array,isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function _t(r,e,t={}){const n=(s,o,i)=>{const a=ya[o];if(typeof a!="function")throw new Error(`Invalid validator "${o}", expected function`);const c=r[s];if(!(i&&c===void 0)&&!a(c,r))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${o}`)};for(const[s,o]of Object.entries(e))n(s,o,!1);for(const[s,o]of Object.entries(t))n(s,o,!0);return r}const ma=Object.freeze(Object.defineProperty({__proto__:null,bitGet:ga,bitLen:da,bitMask:zr,bitSet:pa,bytesToHex:ut,bytesToNumberBE:ie,bytesToNumberLE:qr,concatBytes:et,createHmacDrbg:hs,ensureBytes:ee,equalBytes:ha,hexToBytes:ht,hexToNumber:Wr,numberToBytesBE:We,numberToBytesLE:jr,numberToHexUnpadded:us,numberToVarBytesBE:ua,utf8ToBytes:fa,validateObject:_t},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Y=BigInt(0),z=BigInt(1),Ze=BigInt(2),wa=BigInt(3),_r=BigInt(4),Ln=BigInt(5),On=BigInt(8);BigInt(9);BigInt(16);function X(r,e){const t=r%e;return t>=Y?t:e+t}function ba(r,e,t){if(t<=Y||e<Y)throw new Error("Expected power/modulo > 0");if(t===z)return Y;let n=z;for(;e>Y;)e&z&&(n=n*r%t),r=r*r%t,e>>=z;return n}function fe(r,e,t){let n=r;for(;e-- >Y;)n*=n,n%=t;return n}function Ir(r,e){if(r===Y||e<=Y)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=X(r,e),n=e,s=Y,o=z;for(;t!==Y;){const a=n/t,c=n%t,l=s-o*a;n=t,t=c,s=o,o=l}if(n!==z)throw new Error("invert: does not exist");return X(s,e)}function va(r){const e=(r-z)/Ze;let t,n,s;for(t=r-z,n=0;t%Ze===Y;t/=Ze,n++);for(s=Ze;s<r&&ba(s,e,r)!==r-z;s++);if(n===1){const i=(r+z)/_r;return function(c,l){const h=c.pow(l,i);if(!c.eql(c.sqr(h),l))throw new Error("Cannot find square root");return h}}const o=(t+z)/Ze;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,h=a.pow(a.mul(a.ONE,s),t),u=a.pow(c,o),f=a.pow(c,t);for(;!a.eql(f,a.ONE);){if(a.eql(f,a.ZERO))return a.ZERO;let g=1;for(let d=a.sqr(f);g<l&&!a.eql(d,a.ONE);g++)d=a.sqr(d);const m=a.pow(h,z<<BigInt(l-g-1));h=a.sqr(m),u=a.mul(u,m),f=a.mul(f,h),l=g}return u}}function Ea(r){if(r%_r===wa){const e=(r+z)/_r;return function(n,s){const o=n.pow(s,e);if(!n.eql(n.sqr(o),s))throw new Error("Cannot find square root");return o}}if(r%On===Ln){const e=(r-Ln)/On;return function(n,s){const o=n.mul(s,Ze),i=n.pow(o,e),a=n.mul(s,i),c=n.mul(n.mul(a,Ze),i),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),s))throw new Error("Cannot find square root");return l}}return va(r)}const xa=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Aa(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=xa.reduce((n,s)=>(n[s]="function",n),e);return _t(r,t)}function Sa(r,e,t){if(t<Y)throw new Error("Expected power > 0");if(t===Y)return r.ONE;if(t===z)return e;let n=r.ONE,s=e;for(;t>Y;)t&z&&(n=r.mul(n,s)),s=r.sqr(s),t>>=z;return n}function Ra(r,e){const t=new Array(e.length),n=e.reduce((o,i,a)=>r.is0(i)?o:(t[a]=o,r.mul(o,i)),r.ONE),s=r.inv(n);return e.reduceRight((o,i,a)=>r.is0(i)?o:(t[a]=r.mul(o,t[a]),r.mul(o,i)),s),t}function fs(r,e){const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function Ta(r,e,t=!1,n={}){if(r<=Y)throw new Error(`Expected Field ORDER > 0, got ${r}`);const{nBitLength:s,nByteLength:o}=fs(r,e);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const i=Ea(r),a=Object.freeze({ORDER:r,BITS:s,BYTES:o,MASK:zr(s),ZERO:Y,ONE:z,create:c=>X(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return Y<=c&&c<r},is0:c=>c===Y,isOdd:c=>(c&z)===z,neg:c=>X(-c,r),eql:(c,l)=>c===l,sqr:c=>X(c*c,r),add:(c,l)=>X(c+l,r),sub:(c,l)=>X(c-l,r),mul:(c,l)=>X(c*l,r),pow:(c,l)=>Sa(a,c,l),div:(c,l)=>X(c*Ir(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>Ir(c,r),sqrt:n.sqrt||(c=>i(a,c)),invertBatch:c=>Ra(a,c),cmov:(c,l,h)=>h?l:c,toBytes:c=>t?jr(c,o):We(c,o),fromBytes:c=>{if(c.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${c.length}`);return t?qr(c):ie(c)}});return Object.freeze(a)}function ds(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function gs(r){const e=ds(r);return e+Math.ceil(e/2)}function Ca(r,e,t=!1){const n=r.length,s=ds(e),o=gs(e);if(n<16||n<o||n>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${n}`);const i=t?ie(r):qr(r),a=X(i,e-z)+z;return t?jr(a,s):We(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ma=BigInt(0),gr=BigInt(1);function _a(r,e){const t=(s,o)=>{const i=o.negate();return s?i:o},n=s=>{const o=Math.ceil(e/s)+1,i=2**(s-1);return{windows:o,windowSize:i}};return{constTimeNegate:t,unsafeLadder(s,o){let i=r.ZERO,a=s;for(;o>Ma;)o&gr&&(i=i.add(a)),a=a.double(),o>>=gr;return i},precomputeWindow(s,o){const{windows:i,windowSize:a}=n(o),c=[];let l=s,h=l;for(let u=0;u<i;u++){h=l,c.push(h);for(let f=1;f<a;f++)h=h.add(l),c.push(h);l=h.double()}return c},wNAF(s,o,i){const{windows:a,windowSize:c}=n(s);let l=r.ZERO,h=r.BASE;const u=BigInt(2**s-1),f=2**s,g=BigInt(s);for(let m=0;m<a;m++){const d=m*c;let p=Number(i&u);i>>=g,p>c&&(p-=f,i+=gr);const w=d,x=d+Math.abs(p)-1,T=m%2!==0,M=p<0;p===0?h=h.add(t(T,o[w])):l=l.add(t(M,o[x]))}return{p:l,f:h}},wNAFCached(s,o,i,a){const c=s._WINDOW_SIZE||1;let l=o.get(s);return l||(l=this.precomputeWindow(s,c),c!==1&&o.set(s,a(l))),this.wNAF(c,l,i)}}}function ps(r){return Aa(r.Fp),_t(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...fs(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Ia(r){const e=ps(r);_t(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:t,Fp:n,a:s}=e;if(t){if(!n.eql(s,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:Pa,hexToBytes:ka}=ma,Xe={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(r){const{Err:e}=Xe;if(r.length<2||r[0]!==2)throw new e("Invalid signature integer tag");const t=r[1],n=r.subarray(2,t+2);if(!t||n.length!==t)throw new e("Invalid signature integer: wrong length");if(n[0]&128)throw new e("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:Pa(n),l:r.subarray(t+2)}},toSig(r){const{Err:e}=Xe,t=typeof r=="string"?ka(r):r;if(!(t instanceof Uint8Array))throw new Error("ui8a expected");let n=t.length;if(n<2||t[0]!=48)throw new e("Invalid signature tag");if(t[1]!==n-2)throw new e("Invalid signature: incorrect length");const{d:s,l:o}=Xe._parseInt(t.subarray(2)),{d:i,l:a}=Xe._parseInt(o);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:s,s:i}},hexFromSig(r){const e=l=>Number.parseInt(l[0],16)&8?"00"+l:l,t=l=>{const h=l.toString(16);return h.length&1?`0${h}`:h},n=e(t(r.s)),s=e(t(r.r)),o=n.length/2,i=s.length/2,a=t(o),c=t(i);return`30${t(i+o+4)}02${c}${s}02${a}${n}`}},Me=BigInt(0),de=BigInt(1);BigInt(2);const Un=BigInt(3);BigInt(4);function $a(r){const e=Ia(r),{Fp:t}=e,n=e.toBytes||((m,d,p)=>{const w=d.toAffine();return et(Uint8Array.from([4]),t.toBytes(w.x),t.toBytes(w.y))}),s=e.fromBytes||(m=>{const d=m.subarray(1),p=t.fromBytes(d.subarray(0,t.BYTES)),w=t.fromBytes(d.subarray(t.BYTES,2*t.BYTES));return{x:p,y:w}});function o(m){const{a:d,b:p}=e,w=t.sqr(m),x=t.mul(w,m);return t.add(t.add(x,t.mul(m,d)),p)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function i(m){return typeof m=="bigint"&&Me<m&&m<e.n}function a(m){if(!i(m))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(m){const{allowedPrivateKeyLengths:d,nByteLength:p,wrapPrivateKey:w,n:x}=e;if(d&&typeof m!="bigint"){if(m instanceof Uint8Array&&(m=ut(m)),typeof m!="string"||!d.includes(m.length))throw new Error("Invalid key");m=m.padStart(p*2,"0")}let T;try{T=typeof m=="bigint"?m:ie(ee("private key",m,p))}catch{throw new Error(`private key must be ${p} bytes, hex or bigint, not ${typeof m}`)}return w&&(T=X(T,x)),a(T),T}const l=new Map;function h(m){if(!(m instanceof u))throw new Error("ProjectivePoint expected")}class u{constructor(d,p,w){if(this.px=d,this.py=p,this.pz=w,d==null||!t.isValid(d))throw new Error("x required");if(p==null||!t.isValid(p))throw new Error("y required");if(w==null||!t.isValid(w))throw new Error("z required")}static fromAffine(d){const{x:p,y:w}=d||{};if(!d||!t.isValid(p)||!t.isValid(w))throw new Error("invalid affine point");if(d instanceof u)throw new Error("projective point not allowed");const x=T=>t.eql(T,t.ZERO);return x(p)&&x(w)?u.ZERO:new u(p,w,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(d){const p=t.invertBatch(d.map(w=>w.pz));return d.map((w,x)=>w.toAffine(p[x])).map(u.fromAffine)}static fromHex(d){const p=u.fromAffine(s(ee("pointHex",d)));return p.assertValidity(),p}static fromPrivateKey(d){return u.BASE.multiply(c(d))}_setWindowSize(d){this._WINDOW_SIZE=d,l.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!t.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:d,y:p}=this.toAffine();if(!t.isValid(d)||!t.isValid(p))throw new Error("bad point: x or y not FE");const w=t.sqr(p),x=o(d);if(!t.eql(w,x))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:d}=this.toAffine();if(t.isOdd)return!t.isOdd(d);throw new Error("Field doesn't support isOdd")}equals(d){h(d);const{px:p,py:w,pz:x}=this,{px:T,py:M,pz:k}=d,A=t.eql(t.mul(p,k),t.mul(T,x)),S=t.eql(t.mul(w,k),t.mul(M,x));return A&&S}negate(){return new u(this.px,t.neg(this.py),this.pz)}double(){const{a:d,b:p}=e,w=t.mul(p,Un),{px:x,py:T,pz:M}=this;let k=t.ZERO,A=t.ZERO,S=t.ZERO,C=t.mul(x,x),N=t.mul(T,T),P=t.mul(M,M),_=t.mul(x,T);return _=t.add(_,_),S=t.mul(x,M),S=t.add(S,S),k=t.mul(d,S),A=t.mul(w,P),A=t.add(k,A),k=t.sub(N,A),A=t.add(N,A),A=t.mul(k,A),k=t.mul(_,k),S=t.mul(w,S),P=t.mul(d,P),_=t.sub(C,P),_=t.mul(d,_),_=t.add(_,S),S=t.add(C,C),C=t.add(S,C),C=t.add(C,P),C=t.mul(C,_),A=t.add(A,C),P=t.mul(T,M),P=t.add(P,P),C=t.mul(P,_),k=t.sub(k,C),S=t.mul(P,N),S=t.add(S,S),S=t.add(S,S),new u(k,A,S)}add(d){h(d);const{px:p,py:w,pz:x}=this,{px:T,py:M,pz:k}=d;let A=t.ZERO,S=t.ZERO,C=t.ZERO;const N=e.a,P=t.mul(e.b,Un);let _=t.mul(p,T),L=t.mul(w,M),O=t.mul(x,k),D=t.add(p,w),b=t.add(T,M);D=t.mul(D,b),b=t.add(_,L),D=t.sub(D,b),b=t.add(p,x);let v=t.add(T,k);return b=t.mul(b,v),v=t.add(_,O),b=t.sub(b,v),v=t.add(w,x),A=t.add(M,k),v=t.mul(v,A),A=t.add(L,O),v=t.sub(v,A),C=t.mul(N,b),A=t.mul(P,O),C=t.add(A,C),A=t.sub(L,C),C=t.add(L,C),S=t.mul(A,C),L=t.add(_,_),L=t.add(L,_),O=t.mul(N,O),b=t.mul(P,b),L=t.add(L,O),O=t.sub(_,O),O=t.mul(N,O),b=t.add(b,O),_=t.mul(L,b),S=t.add(S,_),_=t.mul(v,b),A=t.mul(D,A),A=t.sub(A,_),_=t.mul(D,L),C=t.mul(v,C),C=t.add(C,_),new u(A,S,C)}subtract(d){return this.add(d.negate())}is0(){return this.equals(u.ZERO)}wNAF(d){return g.wNAFCached(this,l,d,p=>{const w=t.invertBatch(p.map(x=>x.pz));return p.map((x,T)=>x.toAffine(w[T])).map(u.fromAffine)})}multiplyUnsafe(d){const p=u.ZERO;if(d===Me)return p;if(a(d),d===de)return this;const{endo:w}=e;if(!w)return g.unsafeLadder(this,d);let{k1neg:x,k1:T,k2neg:M,k2:k}=w.splitScalar(d),A=p,S=p,C=this;for(;T>Me||k>Me;)T&de&&(A=A.add(C)),k&de&&(S=S.add(C)),C=C.double(),T>>=de,k>>=de;return x&&(A=A.negate()),M&&(S=S.negate()),S=new u(t.mul(S.px,w.beta),S.py,S.pz),A.add(S)}multiply(d){a(d);let p=d,w,x;const{endo:T}=e;if(T){const{k1neg:M,k1:k,k2neg:A,k2:S}=T.splitScalar(p);let{p:C,f:N}=this.wNAF(k),{p:P,f:_}=this.wNAF(S);C=g.constTimeNegate(M,C),P=g.constTimeNegate(A,P),P=new u(t.mul(P.px,T.beta),P.py,P.pz),w=C.add(P),x=N.add(_)}else{const{p:M,f:k}=this.wNAF(p);w=M,x=k}return u.normalizeZ([w,x])[0]}multiplyAndAddUnsafe(d,p,w){const x=u.BASE,T=(k,A)=>A===Me||A===de||!k.equals(x)?k.multiplyUnsafe(A):k.multiply(A),M=T(this,p).add(T(d,w));return M.is0()?void 0:M}toAffine(d){const{px:p,py:w,pz:x}=this,T=this.is0();d==null&&(d=T?t.ONE:t.inv(x));const M=t.mul(p,d),k=t.mul(w,d),A=t.mul(x,d);if(T)return{x:t.ZERO,y:t.ZERO};if(!t.eql(A,t.ONE))throw new Error("invZ was invalid");return{x:M,y:k}}isTorsionFree(){const{h:d,isTorsionFree:p}=e;if(d===de)return!0;if(p)return p(u,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:d,clearCofactor:p}=e;return d===de?this:p?p(u,this):this.multiplyUnsafe(e.h)}toRawBytes(d=!0){return this.assertValidity(),n(u,this,d)}toHex(d=!0){return ut(this.toRawBytes(d))}}u.BASE=new u(e.Gx,e.Gy,t.ONE),u.ZERO=new u(t.ZERO,t.ONE,t.ZERO);const f=e.nBitLength,g=_a(u,e.endo?Math.ceil(f/2):f);return{CURVE:e,ProjectivePoint:u,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:i}}function Na(r){const e=ps(r);return _t(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function La(r){const e=Na(r),{Fp:t,n}=e,s=t.BYTES+1,o=2*t.BYTES+1;function i(b){return Me<b&&b<t.ORDER}function a(b){return X(b,n)}function c(b){return Ir(b,n)}const{ProjectivePoint:l,normPrivateKeyToScalar:h,weierstrassEquation:u,isWithinCurveOrder:f}=$a({...e,toBytes(b,v,R){const I=v.toAffine(),E=t.toBytes(I.x),$=et;return R?$(Uint8Array.from([v.hasEvenY()?2:3]),E):$(Uint8Array.from([4]),E,t.toBytes(I.y))},fromBytes(b){const v=b.length,R=b[0],I=b.subarray(1);if(v===s&&(R===2||R===3)){const E=ie(I);if(!i(E))throw new Error("Point is not on curve");const $=u(E);let B=t.sqrt($);const U=(B&de)===de;return(R&1)===1!==U&&(B=t.neg(B)),{x:E,y:B}}else if(v===o&&R===4){const E=t.fromBytes(I.subarray(0,t.BYTES)),$=t.fromBytes(I.subarray(t.BYTES,2*t.BYTES));return{x:E,y:$}}else throw new Error(`Point of length ${v} was invalid. Expected ${s} compressed bytes or ${o} uncompressed bytes`)}}),g=b=>ut(We(b,e.nByteLength));function m(b){const v=n>>de;return b>v}function d(b){return m(b)?a(-b):b}const p=(b,v,R)=>ie(b.slice(v,R));class w{constructor(v,R,I){this.r=v,this.s=R,this.recovery=I,this.assertValidity()}static fromCompact(v){const R=e.nByteLength;return v=ee("compactSignature",v,R*2),new w(p(v,0,R),p(v,R,2*R))}static fromDER(v){const{r:R,s:I}=Xe.toSig(ee("DER",v));return new w(R,I)}assertValidity(){if(!f(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!f(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(v){return new w(this.r,this.s,v)}recoverPublicKey(v){const{r:R,s:I,recovery:E}=this,$=S(ee("msgHash",v));if(E==null||![0,1,2,3].includes(E))throw new Error("recovery id invalid");const B=E===2||E===3?R+e.n:R;if(B>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");const U=E&1?"03":"02",J=l.fromHex(U+g(B)),te=c(B),ae=a(-$*te),he=a(I*te),re=l.BASE.multiplyAndAddUnsafe(J,ae,he);if(!re)throw new Error("point at infinify");return re.assertValidity(),re}hasHighS(){return m(this.s)}normalizeS(){return this.hasHighS()?new w(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return ht(this.toDERHex())}toDERHex(){return Xe.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return ht(this.toCompactHex())}toCompactHex(){return g(this.r)+g(this.s)}}const x={isValidPrivateKey(b){try{return h(b),!0}catch{return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{const b=gs(e.n);return Ca(e.randomBytes(b),e.n)},precompute(b=8,v=l.BASE){return v._setWindowSize(b),v.multiply(BigInt(3)),v}};function T(b,v=!0){return l.fromPrivateKey(b).toRawBytes(v)}function M(b){const v=b instanceof Uint8Array,R=typeof b=="string",I=(v||R)&&b.length;return v?I===s||I===o:R?I===2*s||I===2*o:b instanceof l}function k(b,v,R=!0){if(M(b))throw new Error("first arg must be private key");if(!M(v))throw new Error("second arg must be public key");return l.fromHex(v).multiply(h(b)).toRawBytes(R)}const A=e.bits2int||function(b){const v=ie(b),R=b.length*8-e.nBitLength;return R>0?v>>BigInt(R):v},S=e.bits2int_modN||function(b){return a(A(b))},C=zr(e.nBitLength);function N(b){if(typeof b!="bigint")throw new Error("bigint expected");if(!(Me<=b&&b<C))throw new Error(`bigint expected < 2^${e.nBitLength}`);return We(b,e.nByteLength)}function P(b,v,R=_){if(["recovered","canonical"].some(oe=>oe in R))throw new Error("sign() legacy options not supported");const{hash:I,randomBytes:E}=e;let{lowS:$,prehash:B,extraEntropy:U}=R;$==null&&($=!0),b=ee("msgHash",b),B&&(b=ee("prehashed msgHash",I(b)));const J=S(b),te=h(v),ae=[N(te),N(J)];if(U!=null){const oe=U===!0?E(t.BYTES):U;ae.push(ee("extraEntropy",oe))}const he=et(...ae),re=J;function be(oe){const nt=A(oe);if(!f(nt))return;const Rn=c(nt),st=l.BASE.multiply(nt).toAffine(),ye=a(st.x);if(ye===Me)return;const ot=a(Rn*a(re+ye*te));if(ot===Me)return;let Tn=(st.x===ye?0:2)|Number(st.y&de),Cn=ot;return $&&m(ot)&&(Cn=d(ot),Tn^=1),new w(ye,Cn,Tn)}return{seed:he,k2sig:be}}const _={lowS:e.lowS,prehash:!1},L={lowS:e.lowS,prehash:!1};function O(b,v,R=_){const{seed:I,k2sig:E}=P(b,v,R),$=e;return hs($.hash.outputLen,$.nByteLength,$.hmac)(I,E)}l.BASE._setWindowSize(8);function D(b,v,R,I=L){var st;const E=b;if(v=ee("msgHash",v),R=ee("publicKey",R),"strict"in I)throw new Error("options.strict was renamed to lowS");const{lowS:$,prehash:B}=I;let U,J;try{if(typeof E=="string"||E instanceof Uint8Array)try{U=w.fromDER(E)}catch(ye){if(!(ye instanceof Xe.Err))throw ye;U=w.fromCompact(E)}else if(typeof E=="object"&&typeof E.r=="bigint"&&typeof E.s=="bigint"){const{r:ye,s:ot}=E;U=new w(ye,ot)}else throw new Error("PARSE");J=l.fromHex(R)}catch(ye){if(ye.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if($&&U.hasHighS())return!1;B&&(v=e.hash(v));const{r:te,s:ae}=U,he=S(v),re=c(ae),be=a(he*re),oe=a(te*re),nt=(st=l.BASE.multiplyAndAddUnsafe(J,be,oe))==null?void 0:st.toAffine();return nt?a(nt.x)===te:!1}return{CURVE:e,getPublicKey:T,getSharedSecret:k,sign:O,verify:D,ProjectivePoint:l,Signature:w,utils:x}}let ys=class extends as{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Ji(e);const n=Kr(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),o.fill(0)}update(e){return Ht(this),this.iHash.update(e),this}digestInto(e){Ht(this),os(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const ms=(r,e,t)=>new ys(r,e).update(t).digest();ms.create=(r,e)=>new ys(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Oa(r){return{hash:r,hmac:(e,...t)=>ms(r,e,ea(...t)),randomBytes:cs}}function Ua(r,e){const t=n=>La({...r,...Oa(n)});return Object.freeze({...t(e),create:t})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Jt=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Kt=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),ws=BigInt(1),Wt=BigInt(2),Bn=(r,e)=>(r+e/Wt)/e;function bs(r){const e=Jt,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,u=fe(h,t,e)*h%e,f=fe(u,t,e)*h%e,g=fe(f,Wt,e)*l%e,m=fe(g,s,e)*g%e,d=fe(m,o,e)*m%e,p=fe(d,a,e)*d%e,w=fe(p,c,e)*p%e,x=fe(w,a,e)*d%e,T=fe(x,t,e)*h%e,M=fe(T,i,e)*m%e,k=fe(M,n,e)*l%e,A=fe(k,Wt,e);if(!Pr.eql(Pr.sqr(A),r))throw new Error("Cannot find square root");return A}const Pr=Ta(Jt,void 0,void 0,{sqrt:bs}),pt=Ua({a:BigInt(0),b:BigInt(7),Fp:Pr,n:Kt,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{const e=Kt,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-ws*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=t,i=BigInt("0x100000000000000000000000000000000"),a=Bn(o*r,e),c=Bn(-n*r,e);let l=X(r-a*t-c*s,e),h=X(-a*n-c*o,e);const u=l>i,f=h>i;if(u&&(l=e-l),f&&(h=e-h),l>i||h>i)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:u,k1:l,k2neg:f,k2:h}}}},Mr),Yt=BigInt(0),vs=r=>typeof r=="bigint"&&Yt<r&&r<Jt,Ba=r=>typeof r=="bigint"&&Yt<r&&r<Kt,Dn={};function qt(r,...e){let t=Dn[r];if(t===void 0){const n=Mr(Uint8Array.from(r,s=>s.charCodeAt(0)));t=et(n,n),Dn[r]=t}return Mr(et(t,...e))}const Vr=r=>r.toRawBytes(!0).slice(1),kr=r=>We(r,32),pr=r=>X(r,Jt),St=r=>X(r,Kt),Zr=pt.ProjectivePoint,Da=(r,e,t)=>Zr.BASE.multiplyAndAddUnsafe(r,e,t);function $r(r){let e=pt.utils.normPrivateKeyToScalar(r),t=Zr.fromPrivateKey(e);return{scalar:t.hasEvenY()?e:St(-e),bytes:Vr(t)}}function Es(r){if(!vs(r))throw new Error("bad x: need 0 < x < p");const e=pr(r*r),t=pr(e*r+BigInt(7));let n=bs(t);n%Wt!==Yt&&(n=pr(-n));const s=new Zr(r,n,ws);return s.assertValidity(),s}function xs(...r){return St(ie(qt("BIP0340/challenge",...r)))}function Fa(r){return $r(r).bytes}function Ha(r,e,t=cs(32)){const n=ee("message",r),{bytes:s,scalar:o}=$r(e),i=ee("auxRand",t,32),a=kr(o^ie(qt("BIP0340/aux",i))),c=qt("BIP0340/nonce",a,s,n),l=St(ie(c));if(l===Yt)throw new Error("sign failed: k is zero");const{bytes:h,scalar:u}=$r(l),f=xs(h,s,n),g=new Uint8Array(64);if(g.set(h,0),g.set(kr(St(u+f*o)),32),!As(g,n,s))throw new Error("sign: Invalid signature produced");return g}function As(r,e,t){const n=ee("signature",r,64),s=ee("message",e),o=ee("publicKey",t,32);try{const i=Es(ie(o)),a=ie(n.subarray(0,32));if(!vs(a))return!1;const c=ie(n.subarray(32,64));if(!Ba(c))return!1;const l=xs(kr(a),Vr(i),s),h=Da(i,c,St(-l));return!(!h||!h.hasEvenY()||h.toAffine().x!==a)}catch{return!1}}const bt={getPublicKey:Fa,sign:Ha,verify:As,utils:{randomPrivateKey:pt.utils.randomPrivateKey,lift_x:Es,pointToBytes:Vr,numberToBytesBE:We,bytesToNumberBE:ie,taggedHash:qt,mod:X}},yr=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Gr=r=>r instanceof Uint8Array,mr=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),xe=(r,e)=>r<<32-e|r>>>e,Ka=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Ka)throw new Error("Non little-endian hardware is not supported");const Wa=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function ne(r){if(!Gr(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=Wa[r[t]];return e}function ft(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);const e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){const s=n*2,o=r.slice(s,s+2),i=Number.parseInt(o,16);if(Number.isNaN(i)||i<0)throw new Error("Invalid byte sequence");t[n]=i}return t}function qa(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Rt(r){if(typeof r=="string"&&(r=qa(r)),!Gr(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function Qt(...r){const e=new Uint8Array(r.reduce((n,s)=>n+s.length,0));let t=0;return r.forEach(n=>{if(!Gr(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}class Ss{clone(){return this._cloneInto()}}function Rs(r){const e=n=>r().update(Rt(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Ts(r=32){if(yr&&typeof yr.getRandomValues=="function")return yr.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function Nr(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function ja(r){if(typeof r!="boolean")throw new Error(`Expected boolean, not ${r}`)}function Cs(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function za(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Nr(r.outputLen),Nr(r.blockLen)}function Va(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Za(r,e){Cs(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}const Se={number:Nr,bool:ja,bytes:Cs,hash:za,exists:Va,output:Za};function Ga(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+l,a,n)}class Ja extends Ss{constructor(e,t,n,s){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=mr(this.buffer)}update(e){Se.exists(this);const{view:t,buffer:n,blockLen:s}=this;e=Rt(e);const o=e.length;for(let i=0;i<o;){const a=Math.min(s-this.pos,o-i);if(a===s){const c=mr(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Se.exists(this),Se.output(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>s-i&&(this.process(n,0),i=0);for(let u=i;u<s;u++)t[u]=0;Ga(n,s-8,BigInt(this.length*8),o),this.process(n,0);const a=mr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,h[u],o)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.length=s,e.pos=a,e.finished=o,e.destroyed=i,s%t&&e.buffer.set(n),e}}const Ya=(r,e,t)=>r&e^~r&t,Qa=(r,e,t)=>r&e^r&t^e&t,Xa=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ue=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Be=new Uint32Array(64);class Ms extends Ja{constructor(){super(64,32,8,!1),this.A=Ue[0]|0,this.B=Ue[1]|0,this.C=Ue[2]|0,this.D=Ue[3]|0,this.E=Ue[4]|0,this.F=Ue[5]|0,this.G=Ue[6]|0,this.H=Ue[7]|0}get(){const{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)Be[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){const f=Be[u-15],g=Be[u-2],m=xe(f,7)^xe(f,18)^f>>>3,d=xe(g,17)^xe(g,19)^g>>>10;Be[u]=d+Be[u-7]+m+Be[u-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:l,H:h}=this;for(let u=0;u<64;u++){const f=xe(a,6)^xe(a,11)^xe(a,25),g=h+f+Ya(a,c,l)+Xa[u]+Be[u]|0,d=(xe(n,2)^xe(n,13)^xe(n,22))+Qa(n,s,o)|0;h=l,l=c,c=a,a=i+g|0,i=o,o=s,s=n,n=g+d|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,o,i,a,c,l,h)}roundClean(){Be.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class ec extends Ms{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const yt=Rs(()=>new Ms);Rs(()=>new ec);/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function mt(r){if(!Number.isSafeInteger(r))throw new Error(`Wrong integer: ${r}`)}function ke(...r){const e=(s,o)=>i=>s(o(i)),t=Array.from(r).reverse().reduce((s,o)=>s?e(s,o.encode):o.encode,void 0),n=r.reduce((s,o)=>s?e(s,o.decode):o.decode,void 0);return{encode:t,decode:n}}function $e(r){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(t=>{if(mt(t),t<0||t>=r.length)throw new Error(`Digit index outside alphabet: ${t} (alphabet: ${r.length})`);return r[t]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(t=>{if(typeof t!="string")throw new Error(`alphabet.decode: not string element=${t}`);const n=r.indexOf(t);if(n===-1)throw new Error(`Unknown letter: "${t}". Allowed: ${r}`);return n})}}}function Ne(r=""){if(typeof r!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let t of e)if(typeof t!="string")throw new Error(`join.encode: non-string input=${t}`);return e.join(r)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(r)}}}function Xt(r,e="="){if(mt(r),typeof e!="string")throw new Error("padding chr should be string");return{encode(t){if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("padding.encode input should be array of strings");for(let n of t)if(typeof n!="string")throw new Error(`padding.encode: non-string input=${n}`);for(;t.length*r%8;)t.push(e);return t},decode(t){if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("padding.encode input should be array of strings");for(let s of t)if(typeof s!="string")throw new Error(`padding.decode: non-string input=${s}`);let n=t.length;if(n*r%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;n>0&&t[n-1]===e;n--)if(!((n-1)*r%8))throw new Error("Invalid padding: string has too much padding");return t.slice(0,n)}}}function _s(r){if(typeof r!="function")throw new Error("normalize fn should be function");return{encode:e=>e,decode:e=>r(e)}}function Fn(r,e,t){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(t<2)throw new Error(`convertRadix: wrong to=${t}, base cannot be less than 2`);if(!Array.isArray(r))throw new Error("convertRadix: data should be array");if(!r.length)return[];let n=0;const s=[],o=Array.from(r);for(o.forEach(i=>{if(mt(i),i<0||i>=e)throw new Error(`Wrong integer: ${i}`)});;){let i=0,a=!0;for(let c=n;c<o.length;c++){const l=o[c],h=e*i+l;if(!Number.isSafeInteger(h)||e*i/e!==i||h-l!==e*i)throw new Error("convertRadix: carry overflow");if(i=h%t,o[c]=Math.floor(h/t),!Number.isSafeInteger(o[c])||o[c]*t+i!==h)throw new Error("convertRadix: carry overflow");if(a)o[c]?a=!1:n=c;else continue}if(s.push(i),a)break}for(let i=0;i<r.length-1&&r[i]===0;i++)s.push(0);return s.reverse()}const Is=(r,e)=>e?Is(e,r%e):r,jt=(r,e)=>r+(e-Is(r,e));function Lr(r,e,t,n){if(!Array.isArray(r))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(t<=0||t>32)throw new Error(`convertRadix2: wrong to=${t}`);if(jt(e,t)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${t} carryBits=${jt(e,t)}`);let s=0,o=0;const i=2**t-1,a=[];for(const c of r){if(mt(c),c>=2**e)throw new Error(`convertRadix2: invalid data word=${c} from=${e}`);if(s=s<<e|c,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=t;o-=t)a.push((s>>o-t&i)>>>0);s&=2**o-1}if(s=s<<t-o&i,!n&&o>=e)throw new Error("Excess padding");if(!n&&s)throw new Error(`Non-zero padding: ${s}`);return n&&o>0&&a.push(s>>>0),a}function tc(r){return mt(r),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return Fn(Array.from(e),2**8,r)},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(Fn(e,r,2**8))}}}function ze(r,e=!1){if(mt(r),r<=0||r>32)throw new Error("radix2: bits should be in (0..32]");if(jt(8,r)>32||jt(r,8)>32)throw new Error("radix2: carry overflow");return{encode:t=>{if(!(t instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return Lr(Array.from(t),8,r,!e)},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(Lr(t,r,8,e))}}}function Hn(r){if(typeof r!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return r.apply(null,e)}catch{}}}const rc=ke(ze(4),$e("0123456789ABCDEF"),Ne("")),nc=ke(ze(5),$e("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),Xt(5),Ne(""));ke(ze(5),$e("0123456789ABCDEFGHIJKLMNOPQRSTUV"),Xt(5),Ne(""));ke(ze(5),$e("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),Ne(""),_s(r=>r.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const Pe=ke(ze(6),$e("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),Xt(6),Ne("")),sc=ke(ze(6),$e("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),Xt(6),Ne("")),Jr=r=>ke(tc(58),$e(r),Ne("")),Or=Jr("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");Jr("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");Jr("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const Kn=[0,2,3,5,6,7,9,10,11],oc={encode(r){let e="";for(let t=0;t<r.length;t+=8){const n=r.subarray(t,t+8);e+=Or.encode(n).padStart(Kn[n.length],"1")}return e},decode(r){let e=[];for(let t=0;t<r.length;t+=11){const n=r.slice(t,t+11),s=Kn.indexOf(n.length),o=Or.decode(n);for(let i=0;i<o.length-s;i++)if(o[i]!==0)throw new Error("base58xmr: wrong padding");e=e.concat(Array.from(o.slice(o.length-s)))}return Uint8Array.from(e)}},Ur=ke($e("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),Ne("")),Wn=[996825010,642813549,513874426,1027748829,705979059];function vt(r){const e=r>>25;let t=(r&33554431)<<5;for(let n=0;n<Wn.length;n++)(e>>n&1)===1&&(t^=Wn[n]);return t}function qn(r,e,t=1){const n=r.length;let s=1;for(let o=0;o<n;o++){const i=r.charCodeAt(o);if(i<33||i>126)throw new Error(`Invalid prefix (${r})`);s=vt(s)^i>>5}s=vt(s);for(let o=0;o<n;o++)s=vt(s)^r.charCodeAt(o)&31;for(let o of e)s=vt(s)^o;for(let o=0;o<6;o++)s=vt(s);return s^=t,Ur.encode(Lr([s%2**30],30,5,!1))}function Ps(r){const e=r==="bech32"?1:734539939,t=ze(5),n=t.decode,s=t.encode,o=Hn(n);function i(h,u,f=90){if(typeof h!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof h}`);if(!Array.isArray(u)||u.length&&typeof u[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof u}`);const g=h.length+7+u.length;if(f!==!1&&g>f)throw new TypeError(`Length ${g} exceeds limit ${f}`);return h=h.toLowerCase(),`${h}1${Ur.encode(u)}${qn(h,u,e)}`}function a(h,u=90){if(typeof h!="string")throw new Error(`bech32.decode input should be string, not ${typeof h}`);if(h.length<8||u!==!1&&h.length>u)throw new TypeError(`Wrong string length: ${h.length} (${h}). Expected (8..${u})`);const f=h.toLowerCase();if(h!==f&&h!==h.toUpperCase())throw new Error("String must be lowercase or uppercase");h=f;const g=h.lastIndexOf("1");if(g===0||g===-1)throw new Error('Letter "1" must be present between prefix and data only');const m=h.slice(0,g),d=h.slice(g+1);if(d.length<6)throw new Error("Data must be at least 6 characters long");const p=Ur.decode(d).slice(0,-6),w=qn(m,p,e);if(!d.endsWith(w))throw new Error(`Invalid checksum in ${h}: expected "${w}"`);return{prefix:m,words:p}}const c=Hn(a);function l(h){const{prefix:u,words:f}=a(h,!1);return{prefix:u,words:f,bytes:n(f)}}return{encode:i,decode:a,decodeToBytes:l,decodeUnsafe:c,fromWords:n,fromWordsUnsafe:o,toWords:s}}const dt=Ps("bech32");Ps("bech32m");const ic={encode:r=>new TextDecoder().decode(r),decode:r=>new TextEncoder().encode(r)},ac=ke(ze(4),$e("0123456789abcdef"),Ne(""),_s(r=>{if(typeof r!="string"||r.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof r} with length ${r.length}`);return r.toLowerCase()})),cc={utf8:ic,hex:ac,base16:rc,base32:nc,base64:Pe,base64url:sc,base58:Or,base58xmr:oc};`${Object.keys(cc).join(", ")}`;function wr(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`positive integer expected, not ${r}`)}function jn(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function ks(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function pe(r,...e){if(!ks(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function gt(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Yr(r,e){pe(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const V=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),lc=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),uc=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!uc)throw new Error("Non little-endian hardware is not supported");function Qr(r){if(typeof r!="string")throw new Error(`string expected, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function qe(r){if(typeof r=="string")r=Qr(r);else if(ks(r))r=r.slice();else throw new Error(`Uint8Array expected, got ${typeof r}`);return r}function hc(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function fc(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const dc=(r,e)=>(Object.assign(e,r),e),Ce=16,Xr=new Uint8Array(16),Ae=V(Xr),gc=225,pc=(r,e,t,n)=>{const s=n&1;return{s3:t<<31|n>>>1,s2:e<<31|t>>>1,s1:r<<31|e>>>1,s0:r>>>1^gc<<24&-(s&1)}},ge=r=>(r>>>0&255)<<24|(r>>>8&255)<<16|(r>>>16&255)<<8|r>>>24&255|0;function yc(r){r.reverse();const e=r[15]&1;let t=0;for(let n=0;n<r.length;n++){const s=r[n];r[n]=s>>>1|t,t=(s&1)<<7}return r[0]^=-e&225,r}const mc=r=>r>64*1024?8:r>1024?4:2;class $s{constructor(e,t){this.blockLen=Ce,this.outputLen=Ce,this.s0=0,this.s1=0,this.s2=0,this.s3=0,this.finished=!1,e=qe(e),pe(e,16);const n=lc(e);let s=n.getUint32(0,!1),o=n.getUint32(4,!1),i=n.getUint32(8,!1),a=n.getUint32(12,!1);const c=[];for(let m=0;m<128;m++)c.push({s0:ge(s),s1:ge(o),s2:ge(i),s3:ge(a)}),{s0:s,s1:o,s2:i,s3:a}=pc(s,o,i,a);const l=mc(t||1024);if(![1,2,4,8].includes(l))throw new Error(`ghash: wrong window size=${l}, should be 2, 4 or 8`);this.W=l;const u=128/l,f=this.windowSize=2**l,g=[];for(let m=0;m<u;m++)for(let d=0;d<f;d++){let p=0,w=0,x=0,T=0;for(let M=0;M<l;M++){if(!(d>>>l-M-1&1))continue;const{s0:A,s1:S,s2:C,s3:N}=c[l*m+M];p^=A,w^=S,x^=C,T^=N}g.push({s0:p,s1:w,s2:x,s3:T})}this.t=g}_updateBlock(e,t,n,s){e^=this.s0,t^=this.s1,n^=this.s2,s^=this.s3;const{W:o,t:i,windowSize:a}=this;let c=0,l=0,h=0,u=0;const f=(1<<o)-1;let g=0;for(const m of[e,t,n,s])for(let d=0;d<4;d++){const p=m>>>8*d&255;for(let w=8/o-1;w>=0;w--){const x=p>>>o*w&f,{s0:T,s1:M,s2:k,s3:A}=i[g*a+x];c^=T,l^=M,h^=k,u^=A,g+=1}}this.s0=c,this.s1=l,this.s2=h,this.s3=u}update(e){e=qe(e),gt(this);const t=V(e),n=Math.floor(e.length/Ce),s=e.length%Ce;for(let o=0;o<n;o++)this._updateBlock(t[o*4+0],t[o*4+1],t[o*4+2],t[o*4+3]);return s&&(Xr.set(e.subarray(n*Ce)),this._updateBlock(Ae[0],Ae[1],Ae[2],Ae[3]),Ae.fill(0)),this}destroy(){const{t:e}=this;for(const t of e)t.s0=0,t.s1=0,t.s2=0,t.s3=0}digestInto(e){gt(this),Yr(e,this),this.finished=!0;const{s0:t,s1:n,s2:s,s3:o}=this,i=V(e);return i[0]=t,i[1]=n,i[2]=s,i[3]=o,e}digest(){const e=new Uint8Array(Ce);return this.digestInto(e),this.destroy(),e}}class wc extends $s{constructor(e,t){e=qe(e);const n=yc(e.slice());super(n,t),n.fill(0)}update(e){e=qe(e),gt(this);const t=V(e),n=e.length%Ce,s=Math.floor(e.length/Ce);for(let o=0;o<s;o++)this._updateBlock(ge(t[o*4+3]),ge(t[o*4+2]),ge(t[o*4+1]),ge(t[o*4+0]));return n&&(Xr.set(e.subarray(s*Ce)),this._updateBlock(ge(Ae[3]),ge(Ae[2]),ge(Ae[1]),ge(Ae[0])),Ae.fill(0)),this}digestInto(e){gt(this),Yr(e,this),this.finished=!0;const{s0:t,s1:n,s2:s,s3:o}=this,i=V(e);return i[0]=t,i[1]=n,i[2]=s,i[3]=o,e.reverse()}}function Ns(r){const e=(n,s)=>r(s,n.length).update(qe(n)).digest(),t=r(new Uint8Array(16),0);return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=(n,s)=>r(n,s),e}Ns((r,e)=>new $s(r,e));Ns((r,e)=>new wc(r,e));const Ke=16,bc=283;function en(r){return r<<1^bc&-(r>>7)}function at(r,e){let t=0;for(;e>0;e>>=1)t^=r&-(e&1),r=en(r);return t}const Br=(()=>{let r=new Uint8Array(256);for(let t=0,n=1;t<256;t++,n^=en(n))r[t]=n;const e=new Uint8Array(256);e[0]=99;for(let t=0;t<255;t++){let n=r[255-t];n|=n<<8,e[r[t]]=(n^n>>4^n>>5^n>>6^n>>7^99)&255}return e})(),vc=Br.map((r,e)=>Br.indexOf(e)),Ec=r=>r<<24|r>>>8,br=r=>r<<8|r>>>24;function Ls(r,e){if(r.length!==256)throw new Error("Wrong sbox length");const t=new Uint32Array(256).map((l,h)=>e(r[h])),n=t.map(br),s=n.map(br),o=s.map(br),i=new Uint32Array(256*256),a=new Uint32Array(256*256),c=new Uint16Array(256*256);for(let l=0;l<256;l++)for(let h=0;h<256;h++){const u=l*256+h;i[u]=t[l]^n[h],a[u]=s[l]^o[h],c[u]=r[l]<<8|r[h]}return{sbox:r,sbox2:c,T0:t,T1:n,T2:s,T3:o,T01:i,T23:a}}const tn=Ls(Br,r=>at(r,3)<<24|r<<16|r<<8|at(r,2)),Os=Ls(vc,r=>at(r,11)<<24|at(r,13)<<16|at(r,9)<<8|at(r,14)),xc=(()=>{const r=new Uint8Array(16);for(let e=0,t=1;e<16;e++,t=en(t))r[e]=t;return r})();function Us(r){pe(r);const e=r.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:t}=tn,n=V(r),s=n.length,o=a=>Re(t,a,a,a,a),i=new Uint32Array(e+28);i.set(n);for(let a=s;a<i.length;a++){let c=i[a-1];a%s===0?c=o(Ec(c))^xc[a/s-1]:s>6&&a%s===4&&(c=o(c)),i[a]=i[a-s]^c}return i}function Ac(r){const e=Us(r),t=e.slice(),n=e.length,{sbox2:s}=tn,{T0:o,T1:i,T2:a,T3:c}=Os;for(let l=0;l<n;l+=4)for(let h=0;h<4;h++)t[l+h]=e[n-l-4+h];e.fill(0);for(let l=4;l<n-4;l++){const h=t[l],u=Re(s,h,h,h,h);t[l]=o[u&255]^i[u>>>8&255]^a[u>>>16&255]^c[u>>>24]}return t}function He(r,e,t,n,s,o){return r[t<<8&65280|n>>>8&255]^e[s>>>8&65280|o>>>24&255]}function Re(r,e,t,n,s){return r[e&255|t&65280]|r[n>>>16&255|s>>>16&65280]<<16}function zn(r,e,t,n,s){const{sbox2:o,T01:i,T23:a}=tn;let c=0;e^=r[c++],t^=r[c++],n^=r[c++],s^=r[c++];const l=r.length/4-2;for(let m=0;m<l;m++){const d=r[c++]^He(i,a,e,t,n,s),p=r[c++]^He(i,a,t,n,s,e),w=r[c++]^He(i,a,n,s,e,t),x=r[c++]^He(i,a,s,e,t,n);e=d,t=p,n=w,s=x}const h=r[c++]^Re(o,e,t,n,s),u=r[c++]^Re(o,t,n,s,e),f=r[c++]^Re(o,n,s,e,t),g=r[c++]^Re(o,s,e,t,n);return{s0:h,s1:u,s2:f,s3:g}}function Sc(r,e,t,n,s){const{sbox2:o,T01:i,T23:a}=Os;let c=0;e^=r[c++],t^=r[c++],n^=r[c++],s^=r[c++];const l=r.length/4-2;for(let m=0;m<l;m++){const d=r[c++]^He(i,a,e,s,n,t),p=r[c++]^He(i,a,t,e,s,n),w=r[c++]^He(i,a,n,t,e,s),x=r[c++]^He(i,a,s,n,t,e);e=d,t=p,n=w,s=x}const h=r[c++]^Re(o,e,s,n,t),u=r[c++]^Re(o,t,e,s,n),f=r[c++]^Re(o,n,t,e,s),g=r[c++]^Re(o,s,n,t,e);return{s0:h,s1:u,s2:f,s3:g}}function Bs(r,e){if(!e)return new Uint8Array(r);if(pe(e),e.length<r)throw new Error(`aes: wrong destination length, expected at least ${r}, got: ${e.length}`);return e}function Rc(r){if(pe(r),r.length%Ke!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${Ke}`)}function Tc(r,e,t){let n=r.length;const s=n%Ke;if(!e&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const o=V(r);if(e){let c=Ke-s;c||(c=Ke),n=n+c}const i=Bs(n,t),a=V(i);return{b:o,o:a,out:i}}function Cc(r,e){if(!e)return r;const t=r.length;if(!t)throw new Error("aes/pcks5: empty ciphertext not allowed");const n=r[t-1];if(n<=0||n>16)throw new Error(`aes/pcks5: wrong padding byte: ${n}`);const s=r.subarray(0,-n);for(let o=0;o<n;o++)if(r[t-o-1]!==n)throw new Error("aes/pcks5: wrong padding");return s}function Mc(r){const e=new Uint8Array(16),t=V(e);e.set(r);const n=Ke-r.length;for(let s=Ke-n;s<Ke;s++)e[s]=n;return t}const Ds=dc({blockSize:16,nonceLength:16},function(e,t,n={}){pe(e),pe(t,16);const s=!n.disablePadding;return{encrypt:(o,i)=>{const a=Us(e),{b:c,o:l,out:h}=Tc(o,s,i),u=V(t);let f=u[0],g=u[1],m=u[2],d=u[3],p=0;for(;p+4<=c.length;)f^=c[p+0],g^=c[p+1],m^=c[p+2],d^=c[p+3],{s0:f,s1:g,s2:m,s3:d}=zn(a,f,g,m,d),l[p++]=f,l[p++]=g,l[p++]=m,l[p++]=d;if(s){const w=Mc(o.subarray(p*4));f^=w[0],g^=w[1],m^=w[2],d^=w[3],{s0:f,s1:g,s2:m,s3:d}=zn(a,f,g,m,d),l[p++]=f,l[p++]=g,l[p++]=m,l[p++]=d}return a.fill(0),h},decrypt:(o,i)=>{Rc(o);const a=Ac(e),c=V(t),l=Bs(o.length,i),h=V(o),u=V(l);let f=c[0],g=c[1],m=c[2],d=c[3];for(let p=0;p+4<=h.length;){const w=f,x=g,T=m,M=d;f=h[p+0],g=h[p+1],m=h[p+2],d=h[p+3];const{s0:k,s1:A,s2:S,s3:C}=Sc(a,f,g,m,d);u[p++]=k^w,u[p++]=A^x,u[p++]=S^T,u[p++]=C^M}return a.fill(0),Cc(l,s)}}}),Q=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class _c{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=qe(e),pe(e,32);const t=Q(e,0),n=Q(e,2),s=Q(e,4),o=Q(e,6),i=Q(e,8),a=Q(e,10),c=Q(e,12),l=Q(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let h=0;h<8;h++)this.pad[h]=Q(e,16+2*h)}process(e,t,n=!1){const s=n?0:2048,{h:o,r:i}=this,a=i[0],c=i[1],l=i[2],h=i[3],u=i[4],f=i[5],g=i[6],m=i[7],d=i[8],p=i[9],w=Q(e,t+0),x=Q(e,t+2),T=Q(e,t+4),M=Q(e,t+6),k=Q(e,t+8),A=Q(e,t+10),S=Q(e,t+12),C=Q(e,t+14);let N=o[0]+(w&8191),P=o[1]+((w>>>13|x<<3)&8191),_=o[2]+((x>>>10|T<<6)&8191),L=o[3]+((T>>>7|M<<9)&8191),O=o[4]+((M>>>4|k<<12)&8191),D=o[5]+(k>>>1&8191),b=o[6]+((k>>>14|A<<2)&8191),v=o[7]+((A>>>11|S<<5)&8191),R=o[8]+((S>>>8|C<<8)&8191),I=o[9]+(C>>>5|s),E=0,$=E+N*a+P*(5*p)+_*(5*d)+L*(5*m)+O*(5*g);E=$>>>13,$&=8191,$+=D*(5*f)+b*(5*u)+v*(5*h)+R*(5*l)+I*(5*c),E+=$>>>13,$&=8191;let B=E+N*c+P*a+_*(5*p)+L*(5*d)+O*(5*m);E=B>>>13,B&=8191,B+=D*(5*g)+b*(5*f)+v*(5*u)+R*(5*h)+I*(5*l),E+=B>>>13,B&=8191;let U=E+N*l+P*c+_*a+L*(5*p)+O*(5*d);E=U>>>13,U&=8191,U+=D*(5*m)+b*(5*g)+v*(5*f)+R*(5*u)+I*(5*h),E+=U>>>13,U&=8191;let J=E+N*h+P*l+_*c+L*a+O*(5*p);E=J>>>13,J&=8191,J+=D*(5*d)+b*(5*m)+v*(5*g)+R*(5*f)+I*(5*u),E+=J>>>13,J&=8191;let te=E+N*u+P*h+_*l+L*c+O*a;E=te>>>13,te&=8191,te+=D*(5*p)+b*(5*d)+v*(5*m)+R*(5*g)+I*(5*f),E+=te>>>13,te&=8191;let ae=E+N*f+P*u+_*h+L*l+O*c;E=ae>>>13,ae&=8191,ae+=D*a+b*(5*p)+v*(5*d)+R*(5*m)+I*(5*g),E+=ae>>>13,ae&=8191;let he=E+N*g+P*f+_*u+L*h+O*l;E=he>>>13,he&=8191,he+=D*c+b*a+v*(5*p)+R*(5*d)+I*(5*m),E+=he>>>13,he&=8191;let re=E+N*m+P*g+_*f+L*u+O*h;E=re>>>13,re&=8191,re+=D*l+b*c+v*a+R*(5*p)+I*(5*d),E+=re>>>13,re&=8191;let be=E+N*d+P*m+_*g+L*f+O*u;E=be>>>13,be&=8191,be+=D*h+b*l+v*c+R*a+I*(5*p),E+=be>>>13,be&=8191;let oe=E+N*p+P*d+_*m+L*g+O*f;E=oe>>>13,oe&=8191,oe+=D*u+b*h+v*l+R*c+I*a,E+=oe>>>13,oe&=8191,E=(E<<2)+E|0,E=E+$|0,$=E&8191,E=E>>>13,B+=E,o[0]=$,o[1]=B,o[2]=U,o[3]=J,o[4]=te,o[5]=ae,o[6]=he,o[7]=re,o[8]=be,o[9]=oe}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let o=(s^1)-1;for(let a=0;a<10;a++)n[a]&=o;o=~o;for(let a=0;a<10;a++)e[a]=e[a]&o|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let i=e[0]+t[0];e[0]=i&65535;for(let a=1;a<8;a++)i=(e[a]+t[a]|0)+(i>>>16)|0,e[a]=i&65535}update(e){gt(this);const{buffer:t,blockLen:n}=this;e=qe(e);const s=e.length;for(let o=0;o<s;){const i=Math.min(n-this.pos,s-o);if(i===n){for(;n<=s-o;o+=n)this.process(e,o);continue}t.set(e.subarray(o,o+i),this.pos),this.pos+=i,o+=i,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){gt(this),Yr(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let o=0;for(let i=0;i<8;i++)e[o++]=n[i]>>>0,e[o++]=n[i]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function Ic(r){const e=(n,s)=>r(s).update(qe(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}Ic(r=>new _c(r));const Pc=Qr("expand 16-byte k"),kc=Qr("expand 32-byte k"),$c=V(Pc),Nc=V(kc);function F(r,e){return r<<e|r>>>32-e}function Dr(r){return r.byteOffset%4===0}const Pt=64,Lc=16,Fs=2**32-1,Vn=new Uint32Array;function Oc(r,e,t,n,s,o,i,a){const c=s.length,l=new Uint8Array(Pt),h=V(l),u=Dr(s)&&Dr(o),f=u?V(s):Vn,g=u?V(o):Vn;for(let m=0;m<c;i++){if(r(e,t,n,h,i,a),i>=Fs)throw new Error("arx: counter overflow");const d=Math.min(Pt,c-m);if(u&&d===Pt){const p=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let w=0,x;w<Lc;w++)x=p+w,g[x]=f[x]^h[w];m+=Pt;continue}for(let p=0,w;p<d;p++)w=m+p,o[w]=s[w]^l[p];m+=d}}function Uc(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:o,rounds:i}=hc({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return wr(s),wr(i),jn(o),jn(t),(a,c,l,h,u=0)=>{pe(a),pe(c),pe(l);const f=l.length;if(h||(h=new Uint8Array(f)),pe(h),wr(u),u<0||u>=Fs)throw new Error("arx: counter overflow");if(h.length<f)throw new Error(`arx: output (${h.length}) is shorter than data (${f})`);const g=[];let m=a.length,d,p;if(m===32)d=a.slice(),g.push(d),p=Nc;else if(m===16&&t)d=new Uint8Array(32),d.set(a),d.set(a,16),p=$c,g.push(d);else throw new Error(`arx: invalid 32-byte key, got length=${m}`);Dr(c)||(c=c.slice(),g.push(c));const w=V(d);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(p,w,V(c.subarray(0,16)),w),c=c.subarray(16)}const x=16-s;if(x!==c.length)throw new Error(`arx: nonce must be ${x} or 16 bytes`);if(x!==12){const M=new Uint8Array(12);M.set(c,o?0:12-c.length),c=M,g.push(c)}const T=V(c);for(Oc(r,p,w,T,l,h,u,i);g.length>0;)g.pop().fill(0);return h}}function Bc(r,e,t,n,s,o=20){let i=r[0],a=r[1],c=r[2],l=r[3],h=e[0],u=e[1],f=e[2],g=e[3],m=e[4],d=e[5],p=e[6],w=e[7],x=s,T=t[0],M=t[1],k=t[2],A=i,S=a,C=c,N=l,P=h,_=u,L=f,O=g,D=m,b=d,v=p,R=w,I=x,E=T,$=M,B=k;for(let J=0;J<o;J+=2)A=A+P|0,I=F(I^A,16),D=D+I|0,P=F(P^D,12),A=A+P|0,I=F(I^A,8),D=D+I|0,P=F(P^D,7),S=S+_|0,E=F(E^S,16),b=b+E|0,_=F(_^b,12),S=S+_|0,E=F(E^S,8),b=b+E|0,_=F(_^b,7),C=C+L|0,$=F($^C,16),v=v+$|0,L=F(L^v,12),C=C+L|0,$=F($^C,8),v=v+$|0,L=F(L^v,7),N=N+O|0,B=F(B^N,16),R=R+B|0,O=F(O^R,12),N=N+O|0,B=F(B^N,8),R=R+B|0,O=F(O^R,7),A=A+_|0,B=F(B^A,16),v=v+B|0,_=F(_^v,12),A=A+_|0,B=F(B^A,8),v=v+B|0,_=F(_^v,7),S=S+L|0,I=F(I^S,16),R=R+I|0,L=F(L^R,12),S=S+L|0,I=F(I^S,8),R=R+I|0,L=F(L^R,7),C=C+O|0,E=F(E^C,16),D=D+E|0,O=F(O^D,12),C=C+O|0,E=F(E^C,8),D=D+E|0,O=F(O^D,7),N=N+P|0,$=F($^N,16),b=b+$|0,P=F(P^b,12),N=N+P|0,$=F($^N,8),b=b+$|0,P=F(P^b,7);let U=0;n[U++]=i+A|0,n[U++]=a+S|0,n[U++]=c+C|0,n[U++]=l+N|0,n[U++]=h+P|0,n[U++]=u+_|0,n[U++]=f+L|0,n[U++]=g+O|0,n[U++]=m+D|0,n[U++]=d+b|0,n[U++]=p+v|0,n[U++]=w+R|0,n[U++]=x+I|0,n[U++]=T+E|0,n[U++]=M+$|0,n[U++]=k+B|0}const Hs=Uc(Bc,{counterRight:!1,counterLength:4,allowShortKeys:!1});class Ks extends Ss{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Se.hash(e);const n=Rt(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),o.fill(0)}update(e){return Se.exists(this),this.iHash.update(e),this}digestInto(e){Se.exists(this),Se.bytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const er=(r,e,t)=>new Ks(r,e).update(t).digest();er.create=(r,e)=>new Ks(r,e);function Dc(r,e,t){return Se.hash(r),er(r,Rt(t),Rt(e))}const vr=new Uint8Array([0]),Zn=new Uint8Array;function Fc(r,e,t,n=32){if(Se.hash(r),Se.number(n),n>255*r.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(n/r.outputLen);t===void 0&&(t=Zn);const o=new Uint8Array(s*r.outputLen),i=er.create(r,e),a=i._cloneInto(),c=new Uint8Array(i.outputLen);for(let l=0;l<s;l++)vr[0]=l+1,a.update(l===0?Zn:c).update(t).update(vr).digestInto(c),o.set(c,r.outputLen*l),i._cloneInto(a);return i.destroy(),a.destroy(),c.fill(0),vr.fill(0),o.slice(0,n)}var Hc=Object.defineProperty,W=(r,e)=>{for(var t in e)Hc(r,t,{get:e[t],enumerable:!0})},Ve=Symbol("verified"),Kc=r=>r instanceof Object;function Tt(r){if(!Kc(r)||typeof r.kind!="number"||typeof r.content!="string"||typeof r.created_at!="number"||typeof r.pubkey!="string"||!r.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(r.tags))return!1;for(let e=0;e<r.tags.length;e++){let t=r.tags[e];if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(typeof t[n]=="object")return!1}return!0}var Wc={};W(Wc,{Queue:()=>qs,QueueNode:()=>Ws,binarySearch:()=>rn,insertEventIntoAscendingList:()=>jc,insertEventIntoDescendingList:()=>qc,normalizeURL:()=>Ge,utf8Decoder:()=>_e,utf8Encoder:()=>me});var _e=new TextDecoder("utf-8"),me=new TextEncoder;function Ge(r){r.indexOf("://")===-1&&(r="wss://"+r);let e=new URL(r);return e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}function qc(r,e){const[t,n]=rn(r,s=>e.id===s.id?0:e.created_at===s.created_at?-1:s.created_at-e.created_at);return n||r.splice(t,0,e),r}function jc(r,e){const[t,n]=rn(r,s=>e.id===s.id?0:e.created_at===s.created_at?-1:e.created_at-s.created_at);return n||r.splice(t,0,e),r}function rn(r,e){let t=0,n=r.length-1;for(;t<=n;){const s=Math.floor((t+n)/2),o=e(r[s]);if(o===0)return[s,!0];o<0?n=s-1:t=s+1}return[t,!1]}var Ws=class{constructor(r){y(this,"value");y(this,"next",null);y(this,"prev",null);this.value=r}},qs=class{constructor(){y(this,"first");y(this,"last");this.first=null,this.last=null}enqueue(r){const e=new Ws(r);return this.last?this.last===this.first?(this.last=e,this.last.prev=this.first,this.first.next=e):(e.prev=this.last,this.last.next=e,this.last=e):(this.first=e,this.last=e),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const e=this.first;return this.first=null,this.last=null,e.value}const r=this.first;return this.first=r.next,r.value}},zc=class{generateSecretKey(){return bt.utils.randomPrivateKey()}getPublicKey(r){return ne(bt.getPublicKey(r))}finalizeEvent(r,e){const t=r;return t.pubkey=ne(bt.getPublicKey(e)),t.id=At(t),t.sig=ne(bt.sign(At(t),e)),t[Ve]=!0,t}verifyEvent(r){if(typeof r[Ve]=="boolean")return r[Ve];const e=At(r);if(e!==r.id)return r[Ve]=!1,!1;try{const t=bt.verify(r.sig,e,r.pubkey);return r[Ve]=t,t}catch{return r[Ve]=!1,!1}}};function Vc(r){if(!Tt(r))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,r.pubkey,r.created_at,r.kind,r.tags,r.content])}function At(r){let e=yt(me.encode(Vc(r)));return ne(e)}var tr=new zc,Zc=tr.generateSecretKey,rr=tr.getPublicKey,we=tr.finalizeEvent,nr=tr.verifyEvent,Gc={};W(Gc,{Application:()=>Gl,BadgeAward:()=>sl,BadgeDefinition:()=>Kl,BlockedRelaysList:()=>Tl,BookmarkList:()=>Al,Bookmarksets:()=>Dl,Calendar:()=>ru,CalendarEventRSVP:()=>nu,ChannelCreation:()=>Js,ChannelHideMessage:()=>Xs,ChannelMessage:()=>Qs,ChannelMetadata:()=>Ys,ChannelMuteUser:()=>eo,ClassifiedListing:()=>Ql,ClientAuth:()=>ro,CommunitiesList:()=>Sl,CommunityDefinition:()=>iu,CommunityPostApproval:()=>fl,Contacts:()=>tl,CreateOrUpdateProduct:()=>jl,CreateOrUpdateStall:()=>ql,Curationsets:()=>Fl,Date:()=>eu,DirectMessageRelaysList:()=>Il,DraftClassifiedListing:()=>Xl,DraftLong:()=>Vl,Emojisets:()=>Zl,EncryptedDirectMessage:()=>rl,EventDeletion:()=>nl,FileMetadata:()=>il,FileServerPreference:()=>Pl,Followsets:()=>Ol,GenericRepost:()=>an,Genericlists:()=>Ul,GiftWrap:()=>to,HTTPAuth:()=>cn,Handlerinformation:()=>ou,Handlerrecommendation:()=>su,Highlights:()=>bl,InterestsList:()=>Ml,Interestsets:()=>Wl,JobFeedback:()=>pl,JobRequest:()=>dl,JobResult:()=>gl,Label:()=>hl,LightningPubRPC:()=>$l,LiveChatMessage:()=>al,LiveEvent:()=>Jl,LongFormArticle:()=>zl,Metadata:()=>Xc,Mutelist:()=>vl,NWCWalletInfo:()=>kl,NWCWalletRequest:()=>no,NWCWalletResponse:()=>Nl,NostrConnect:()=>Ll,OpenTimestamps:()=>ol,Pinlist:()=>El,PrivateDirectMessage:()=>Gs,ProblemTracker:()=>cl,ProfileBadges:()=>Hl,PublicChatsList:()=>Rl,Reaction:()=>on,RecommendRelay:()=>el,RelayList:()=>xl,Relaysets:()=>Bl,Report:()=>ll,Reporting:()=>ul,Repost:()=>sn,Seal:()=>Zs,SearchRelaysList:()=>Cl,ShortTextNote:()=>Vs,Time:()=>tu,UserEmojiList:()=>_l,UserStatuses:()=>Yl,Zap:()=>wl,ZapGoal:()=>yl,ZapRequest:()=>ml,classifyKind:()=>Yc,isAddressableKind:()=>sr,isEphemeralKind:()=>zs,isKind:()=>Qc,isParameterizedReplaceableKind:()=>Jc,isRegularKind:()=>js,isReplaceableKind:()=>nn});function js(r){return 1e3<=r&&r<1e4||[1,2,4,5,6,7,8,16,40,41,42,43,44].includes(r)}function nn(r){return[0,3].includes(r)||1e4<=r&&r<2e4}function zs(r){return 2e4<=r&&r<3e4}function sr(r){return 3e4<=r&&r<4e4}var Jc=sr;function Yc(r){return js(r)?"regular":nn(r)?"replaceable":zs(r)?"ephemeral":sr(r)?"parameterized":"unknown"}function Qc(r,e){const t=e instanceof Array?e:[e];return Tt(r)&&t.includes(r.kind)||!1}var Xc=0,Vs=1,el=2,tl=3,rl=4,nl=5,sn=6,on=7,sl=8,Zs=13,Gs=14,an=16,Js=40,Ys=41,Qs=42,Xs=43,eo=44,ol=1040,to=1059,il=1063,al=1311,cl=1971,ll=1984,ul=1984,hl=1985,fl=4550,dl=5999,gl=6999,pl=7e3,yl=9041,ml=9734,wl=9735,bl=9802,vl=1e4,El=10001,xl=10002,Al=10003,Sl=10004,Rl=10005,Tl=10006,Cl=10007,Ml=10015,_l=10030,Il=10050,Pl=10096,kl=13194,$l=21e3,ro=22242,no=23194,Nl=23195,Ll=24133,cn=27235,Ol=3e4,Ul=30001,Bl=30002,Dl=30003,Fl=30004,Hl=30008,Kl=30009,Wl=30015,ql=30017,jl=30018,zl=30023,Vl=30024,Zl=30030,Gl=30078,Jl=30311,Yl=30315,Ql=30402,Xl=30403,eu=31922,tu=31923,ru=31924,nu=31925,su=31989,ou=31990,iu=34550;function au(r,e){if(r.ids&&r.ids.indexOf(e.id)===-1||r.kinds&&r.kinds.indexOf(e.kind)===-1||r.authors&&r.authors.indexOf(e.pubkey)===-1)return!1;for(let t in r)if(t[0]==="#"){let n=t.slice(1),s=r[`#${n}`];if(s&&!e.tags.find(([o,i])=>o===t.slice(1)&&s.indexOf(i)!==-1))return!1}return!(r.since&&e.created_at<r.since||r.until&&e.created_at>r.until)}function cu(r,e){for(let t=0;t<r.length;t++)if(au(r[t],e))return!0;return!1}var lu={};W(lu,{getHex64:()=>or,getInt:()=>so,getSubscriptionId:()=>oo,matchEventId:()=>uu,matchEventKind:()=>fu,matchEventPubkey:()=>hu});function or(r,e){let t=e.length+3,n=r.indexOf(`"${e}":`)+t,s=r.slice(n).indexOf('"')+n+1;return r.slice(s,s+64)}function so(r,e){let t=e.length,n=r.indexOf(`"${e}":`)+t+3,s=r.slice(n),o=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,o),10)}function oo(r){let e=r.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let t=r.slice(e+7+1).indexOf('"');if(t===-1)return null;let n=e+7+1+t,s=r.slice(n+1,80).indexOf('"');if(s===-1)return null;let o=n+1+s;return r.slice(n+1,o)}function uu(r,e){return e===or(r,"id")}function hu(r,e){return e===or(r,"pubkey")}function fu(r,e){return e===so(r,"kind")}var du={};W(du,{makeAuthEvent:()=>io});function io(r,e){return{kind:ro,created_at:Math.floor(Date.now()/1e3),tags:[["relay",r],["challenge",e]],content:""}}async function gu(){return new Promise(r=>{const e=new MessageChannel,t=()=>{e.port1.removeEventListener("message",t),r()};e.port1.addEventListener("message",t),e.port2.postMessage(0),e.port1.start()})}var pu=r=>(r[Ve]=!0,!0),ao=class{constructor(r,e){y(this,"url");y(this,"_connected",!1);y(this,"onclose",null);y(this,"onnotice",r=>console.debug(`NOTICE from ${this.url}: ${r}`));y(this,"_onauth",null);y(this,"baseEoseTimeout",4400);y(this,"connectionTimeout",4400);y(this,"publishTimeout",4400);y(this,"openSubs",new Map);y(this,"connectionTimeoutHandle");y(this,"connectionPromise");y(this,"openCountRequests",new Map);y(this,"openEventPublishes",new Map);y(this,"ws");y(this,"incomingMessageQueue",new qs);y(this,"queueRunning",!1);y(this,"challenge");y(this,"authPromise");y(this,"serial",0);y(this,"verifyEvent");y(this,"_WebSocket");this.url=Ge(r),this.verifyEvent=e.verifyEvent,this._WebSocket=e.websocketImplementation||WebSocket}static async connect(r,e){const t=new ao(r,e);return await t.connect(),t}closeAllSubscriptions(r){for(let[e,t]of this.openSubs)t.close(r);this.openSubs.clear();for(let[e,t]of this.openEventPublishes)t.reject(new Error(r));this.openEventPublishes.clear();for(let[e,t]of this.openCountRequests)t.reject(new Error(r));this.openCountRequests.clear()}get connected(){return this._connected}async connect(){return this.connectionPromise?this.connectionPromise:(this.challenge=void 0,this.authPromise=void 0,this.connectionPromise=new Promise((r,e)=>{this.connectionTimeoutHandle=setTimeout(()=>{var t;e("connection timed out"),this.connectionPromise=void 0,(t=this.onclose)==null||t.call(this),this.closeAllSubscriptions("relay connection timed out")},this.connectionTimeout);try{this.ws=new this._WebSocket(this.url)}catch(t){e(t);return}this.ws.onopen=()=>{clearTimeout(this.connectionTimeoutHandle),this._connected=!0,r()},this.ws.onerror=t=>{var n;e(t.message||"websocket error"),this._connected&&(this._connected=!1,this.connectionPromise=void 0,(n=this.onclose)==null||n.call(this),this.closeAllSubscriptions("relay connection errored"))},this.ws.onclose=async()=>{var t;this._connected&&(this._connected=!1,this.connectionPromise=void 0,(t=this.onclose)==null||t.call(this),this.closeAllSubscriptions("relay connection closed"))},this.ws.onmessage=this._onmessage.bind(this)}),this.connectionPromise)}async runQueue(){for(this.queueRunning=!0;this.handleNext()!==!1;)await gu();this.queueRunning=!1}handleNext(){var t,n,s;const r=this.incomingMessageQueue.dequeue();if(!r)return!1;const e=oo(r);if(e){const o=this.openSubs.get(e);if(!o)return;const i=or(r,"id"),a=(t=o.alreadyHaveEvent)==null?void 0:t.call(o,i);if((n=o.receivedEvent)==null||n.call(o,this,i),a)return}try{let o=JSON.parse(r);switch(o[0]){case"EVENT":{const i=this.openSubs.get(o[1]),a=o[2];this.verifyEvent(a)&&cu(i.filters,a)&&i.onevent(a);return}case"COUNT":{const i=o[1],a=o[2],c=this.openCountRequests.get(i);c&&(c.resolve(a.count),this.openCountRequests.delete(i));return}case"EOSE":{const i=this.openSubs.get(o[1]);if(!i)return;i.receivedEose();return}case"OK":{const i=o[1],a=o[2],c=o[3],l=this.openEventPublishes.get(i);l&&(clearTimeout(l.timeout),a?l.resolve(c):l.reject(new Error(c)),this.openEventPublishes.delete(i));return}case"CLOSED":{const i=o[1],a=this.openSubs.get(i);if(!a)return;a.closed=!0,a.close(o[2]);return}case"NOTICE":this.onnotice(o[1]);return;case"AUTH":{this.challenge=o[1],this.authPromise=void 0,(s=this._onauth)==null||s.call(this,o[1]);return}}}catch{return}}async send(r){if(!this.connectionPromise)throw new Error("sending on closed connection");this.connectionPromise.then(()=>{var e;(e=this.ws)==null||e.send(r)})}async auth(r){if(!this.challenge)throw new Error("can't perform auth, no challenge was received");if(this.authPromise)return this.authPromise;const e=await r(io(this.url,this.challenge));return this.authPromise=new Promise((t,n)=>{const s=setTimeout(()=>{const o=this.openEventPublishes.get(e.id);o&&(o.reject(new Error("auth timed out")),this.openEventPublishes.delete(e.id))},this.publishTimeout);this.openEventPublishes.set(e.id,{resolve:t,reject:n,timeout:s})}),this.send('["AUTH",'+JSON.stringify(e)+"]"),this.authPromise}async publish(r){const e=new Promise((t,n)=>{const s=setTimeout(()=>{const o=this.openEventPublishes.get(r.id);o&&(o.reject(new Error("publish timed out")),this.openEventPublishes.delete(r.id))},this.publishTimeout);this.openEventPublishes.set(r.id,{resolve:t,reject:n,timeout:s})});return this.send('["EVENT",'+JSON.stringify(r)+"]"),e}async count(r,e){this.serial++;const t=(e==null?void 0:e.id)||"count:"+this.serial,n=new Promise((s,o)=>{this.openCountRequests.set(t,{resolve:s,reject:o})});return this.send('["COUNT","'+t+'",'+JSON.stringify(r).substring(1)),n}subscribe(r,e){const t=this.prepareSubscription(r,e);return t.fire(),t}prepareSubscription(r,e){this.serial++;const t=e.id||(e.label?e.label+":":"sub:")+this.serial,n=new yu(this,t,r,e);return this.openSubs.set(t,n),n}close(){var r;this.closeAllSubscriptions("relay connection closed by us"),this._connected=!1,(r=this.ws)==null||r.close()}_onmessage(r){this.incomingMessageQueue.enqueue(r.data),this.queueRunning||this.runQueue()}},yu=class{constructor(r,e,t,n){y(this,"relay");y(this,"id");y(this,"closed",!1);y(this,"eosed",!1);y(this,"filters");y(this,"alreadyHaveEvent");y(this,"receivedEvent");y(this,"onevent");y(this,"oneose");y(this,"onclose");y(this,"eoseTimeout");y(this,"eoseTimeoutHandle");this.relay=r,this.filters=t,this.id=e,this.alreadyHaveEvent=n.alreadyHaveEvent,this.receivedEvent=n.receivedEvent,this.eoseTimeout=n.eoseTimeout||r.baseEoseTimeout,this.oneose=n.oneose,this.onclose=n.onclose,this.onevent=n.onevent||(s=>{console.warn(`onevent() callback not defined for subscription '${this.id}' in relay ${this.relay.url}. event received:`,s)})}fire(){this.relay.send('["REQ","'+this.id+'",'+JSON.stringify(this.filters).substring(1)),this.eoseTimeoutHandle=setTimeout(this.receivedEose.bind(this),this.eoseTimeout)}receivedEose(){var r;this.eosed||(clearTimeout(this.eoseTimeoutHandle),this.eosed=!0,(r=this.oneose)==null||r.call(this))}close(r="closed by caller"){var e;!this.closed&&this.relay.connected&&(this.relay.send('["CLOSE",'+JSON.stringify(this.id)+"]"),this.closed=!0),this.relay.openSubs.delete(this.id),(e=this.onclose)==null||e.call(this,r)}},mu;try{mu=WebSocket}catch{}var wu=class{constructor(r){y(this,"relays",new Map);y(this,"seenOn",new Map);y(this,"trackRelays",!1);y(this,"verifyEvent");y(this,"trustedRelayURLs",new Set);y(this,"_WebSocket");this.verifyEvent=r.verifyEvent,this._WebSocket=r.websocketImplementation}async ensureRelay(r,e){r=Ge(r);let t=this.relays.get(r);return t||(t=new ao(r,{verifyEvent:this.trustedRelayURLs.has(r)?pu:this.verifyEvent,websocketImplementation:this._WebSocket}),e!=null&&e.connectionTimeout&&(t.connectionTimeout=e.connectionTimeout),this.relays.set(r,t)),await t.connect(),t}close(r){r.map(Ge).forEach(e=>{var t;(t=this.relays.get(e))==null||t.close()})}subscribe(r,e,t){return this.subscribeMap(r.map(n=>({url:n,filter:e})),t)}subscribeMany(r,e,t){return this.subscribeMap(r.flatMap(n=>e.map(s=>({url:n,filter:s}))),t)}subscribeMap(r,e){this.trackRelays&&(e.receivedEvent=(h,u)=>{let f=this.seenOn.get(u);f||(f=new Set,this.seenOn.set(u,f)),f.add(h)});const t=new Set,n=[],s=[];let o=h=>{var u;s[h]||(s[h]=!0,s.filter(f=>f).length===r.length&&((u=e.oneose)==null||u.call(e),o=()=>{}))};const i=[];let a=(h,u)=>{var f;i[h]||(o(h),i[h]=u,i.filter(g=>g).length===r.length&&((f=e.onclose)==null||f.call(e,i),a=()=>{}))};const c=h=>{var f;if((f=e.alreadyHaveEvent)!=null&&f.call(e,h))return!0;const u=t.has(h);return t.add(h),u},l=Promise.all(r.map(async({url:h,filter:u},f)=>{h=Ge(h);let g;try{g=await this.ensureRelay(h,{connectionTimeout:e.maxWait?Math.max(e.maxWait*.8,e.maxWait-1e3):void 0})}catch(d){a(f,(d==null?void 0:d.message)||String(d));return}let m=g.subscribe([u],{...e,oneose:()=>o(f),onclose:d=>{d.startsWith("auth-required:")&&e.doauth?g.auth(e.doauth).then(()=>{g.subscribe([u],{...e,oneose:()=>o(f),onclose:p=>{a(f,p)},alreadyHaveEvent:c,eoseTimeout:e.maxWait})}).catch(p=>{a(f,`auth was required and attempted, but failed with: ${p}`)}):a(f,d)},alreadyHaveEvent:c,eoseTimeout:e.maxWait});n.push(m)}));return{async close(){await l,n.forEach(h=>{h.close()})}}}subscribeManyMap(r,e){this.trackRelays&&(e.receivedEvent=(u,f)=>{let g=this.seenOn.get(f);g||(g=new Set,this.seenOn.set(f,g)),g.add(u)});const t=new Set,n=[],s=Object.keys(r).length,o=[];let i=u=>{var f;o[u]||(o[u]=!0,o.filter(g=>g).length===s&&((f=e.oneose)==null||f.call(e),i=()=>{}))};const a=[];let c=(u,f)=>{var g;a[u]||(i(u),a[u]=f,a.filter(m=>m).length===s&&((g=e.onclose)==null||g.call(e,a),c=()=>{}))};const l=u=>{var g;if((g=e.alreadyHaveEvent)!=null&&g.call(e,u))return!0;const f=t.has(u);return t.add(u),f},h=Promise.all(Object.entries(r).map(async(u,f,g)=>{if(g.indexOf(u)!==f){c(f,"duplicate url");return}let[m,d]=u;m=Ge(m);let p;try{p=await this.ensureRelay(m,{connectionTimeout:e.maxWait?Math.max(e.maxWait*.8,e.maxWait-1e3):void 0})}catch(x){c(f,(x==null?void 0:x.message)||String(x));return}let w=p.subscribe(d,{...e,oneose:()=>i(f),onclose:x=>{x.startsWith("auth-required:")&&e.doauth?p.auth(e.doauth).then(()=>{p.subscribe(d,{...e,oneose:()=>i(f),onclose:T=>{c(f,T)},alreadyHaveEvent:l,eoseTimeout:e.maxWait})}).catch(T=>{c(f,`auth was required and attempted, but failed with: ${T}`)}):c(f,x)},alreadyHaveEvent:l,eoseTimeout:e.maxWait});n.push(w)}));return{async close(){await h,n.forEach(u=>{u.close()})}}}subscribeEose(r,e,t){const n=this.subscribe(r,e,{...t,oneose(){n.close()}});return n}subscribeManyEose(r,e,t){const n=this.subscribeMany(r,e,{...t,oneose(){n.close()}});return n}async querySync(r,e,t){return new Promise(async n=>{const s=[];this.subscribeEose(r,e,{...t,onevent(o){s.push(o)},onclose(o){n(s)}})})}async get(r,e,t){e.limit=1;const n=await this.querySync(r,e,t);return n.sort((s,o)=>o.created_at-s.created_at),n[0]||null}publish(r,e){return r.map(Ge).map(async(t,n,s)=>{if(s.indexOf(t)!==n)return Promise.reject("duplicate url");let o=await this.ensureRelay(t);return o.publish(e).then(i=>{if(this.trackRelays){let a=this.seenOn.get(e.id);a||(a=new Set,this.seenOn.set(e.id,a)),a.add(o)}return i})})}listConnectionStatus(){const r=new Map;return this.relays.forEach((e,t)=>r.set(t,e.connected)),r}destroy(){this.relays.forEach(r=>r.close()),this.relays=new Map}},co;try{co=WebSocket}catch{}var Lt=class extends wu{constructor(){super({verifyEvent:nr,websocketImplementation:co})}},ue={};W(ue,{BECH32_REGEX:()=>lo,Bech32MaxSize:()=>ln,NostrTypeGuard:()=>bu,decode:()=>ir,decodeNostrURI:()=>Eu,encodeBytes:()=>cr,naddrEncode:()=>Cu,neventEncode:()=>Tu,noteEncode:()=>Su,nprofileEncode:()=>Ru,npubEncode:()=>Au,nsecEncode:()=>xu});var bu={isNProfile:r=>/^nprofile1[a-z\d]+$/.test(r||""),isNEvent:r=>/^nevent1[a-z\d]+$/.test(r||""),isNAddr:r=>/^naddr1[a-z\d]+$/.test(r||""),isNSec:r=>/^nsec1[a-z\d]{58}$/.test(r||""),isNPub:r=>/^npub1[a-z\d]{58}$/.test(r||""),isNote:r=>/^note1[a-z\d]+$/.test(r||""),isNcryptsec:r=>/^ncryptsec1[a-z\d]+$/.test(r||"")},ln=5e3,lo=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function vu(r){const e=new Uint8Array(4);return e[0]=r>>24&255,e[1]=r>>16&255,e[2]=r>>8&255,e[3]=r&255,e}function Eu(r){try{return r.startsWith("nostr:")&&(r=r.substring(6)),ir(r)}catch{return{type:"invalid",data:null}}}function ir(r){var s,o,i,a,c,l,h;let{prefix:e,words:t}=dt.decode(r,ln),n=new Uint8Array(dt.fromWords(t));switch(e){case"nprofile":{let u=Er(n);if(!((s=u[0])!=null&&s[0]))throw new Error("missing TLV 0 for nprofile");if(u[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:ne(u[0][0]),relays:u[1]?u[1].map(f=>_e.decode(f)):[]}}}case"nevent":{let u=Er(n);if(!((o=u[0])!=null&&o[0]))throw new Error("missing TLV 0 for nevent");if(u[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(u[2]&&u[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(u[3]&&u[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:ne(u[0][0]),relays:u[1]?u[1].map(f=>_e.decode(f)):[],author:(i=u[2])!=null&&i[0]?ne(u[2][0]):void 0,kind:(a=u[3])!=null&&a[0]?parseInt(ne(u[3][0]),16):void 0}}}case"naddr":{let u=Er(n);if(!((c=u[0])!=null&&c[0]))throw new Error("missing TLV 0 for naddr");if(!((l=u[2])!=null&&l[0]))throw new Error("missing TLV 2 for naddr");if(u[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!((h=u[3])!=null&&h[0]))throw new Error("missing TLV 3 for naddr");if(u[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:_e.decode(u[0][0]),pubkey:ne(u[2][0]),kind:parseInt(ne(u[3][0]),16),relays:u[1]?u[1].map(f=>_e.decode(f)):[]}}}case"nsec":return{type:e,data:n};case"npub":case"note":return{type:e,data:ne(n)};default:throw new Error(`unknown prefix ${e}`)}}function Er(r){let e={},t=r;for(;t.length>0;){let n=t[0],s=t[1],o=t.slice(2,2+s);if(t=t.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${n}`);e[n]=e[n]||[],e[n].push(o)}return e}function xu(r){return cr("nsec",r)}function Au(r){return cr("npub",ft(r))}function Su(r){return cr("note",ft(r))}function ar(r,e){let t=dt.toWords(e);return dt.encode(r,t,ln)}function cr(r,e){return ar(r,e)}function Ru(r){let e=un({0:[ft(r.pubkey)],1:(r.relays||[]).map(t=>me.encode(t))});return ar("nprofile",e)}function Tu(r){let e;r.kind!==void 0&&(e=vu(r.kind));let t=un({0:[ft(r.id)],1:(r.relays||[]).map(n=>me.encode(n)),2:r.author?[ft(r.author)]:[],3:e?[new Uint8Array(e)]:[]});return ar("nevent",t)}function Cu(r){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,r.kind,!1);let t=un({0:[me.encode(r.identifier)],1:(r.relays||[]).map(n=>me.encode(n)),2:[ft(r.pubkey)],3:[new Uint8Array(e)]});return ar("naddr",t)}function un(r){let e=[];return Object.entries(r).reverse().forEach(([t,n])=>{n.forEach(s=>{let o=new Uint8Array(s.length+2);o.set([parseInt(t)],0),o.set([s.length],1),o.set(s,2),e.push(o)})}),Qt(...e)}var Mu={};W(Mu,{decrypt:()=>_u,encrypt:()=>uo});function uo(r,e,t){const n=r instanceof Uint8Array?ne(r):r,s=pt.getSharedSecret(n,"02"+e),o=ho(s);let i=Uint8Array.from(Ts(16)),a=me.encode(t),c=Ds(o,i).encrypt(a),l=Pe.encode(new Uint8Array(c)),h=Pe.encode(new Uint8Array(i.buffer));return`${l}?iv=${h}`}function _u(r,e,t){const n=r instanceof Uint8Array?ne(r):r;let[s,o]=t.split("?iv="),i=pt.getSharedSecret(n,"02"+e),a=ho(i),c=Pe.decode(o),l=Pe.decode(s),h=Ds(a,c).decrypt(l);return _e.decode(h)}function ho(r){return r.slice(1,33)}var Iu={};W(Iu,{NIP05_REGEX:()=>hn,isNip05:()=>Pu,isValid:()=>Nu,queryProfile:()=>fo,searchDomain:()=>$u,useFetchImplementation:()=>ku});var hn=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,Pu=r=>hn.test(r||""),lr;try{lr=fetch}catch{}function ku(r){lr=r}async function $u(r,e=""){try{const t=`https://${r}/.well-known/nostr.json?name=${e}`,n=await lr(t,{redirect:"manual"});if(n.status!==200)throw Error("Wrong response code");return(await n.json()).names}catch{return{}}}async function fo(r){var s;const e=r.match(hn);if(!e)return null;const[,t="_",n]=e;try{const o=`https://${n}/.well-known/nostr.json?name=${t}`,i=await lr(o,{redirect:"manual"});if(i.status!==200)throw Error("Wrong response code");const a=await i.json(),c=a.names[t];return c?{pubkey:c,relays:(s=a.relays)==null?void 0:s[c]}:null}catch{return null}}async function Nu(r,e){const t=await fo(e);return t?t.pubkey===r:!1}var Lu={};W(Lu,{parse:()=>Ou});function Ou(r){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let t,n;for(let s=r.tags.length-1;s>=0;s--){const o=r.tags[s];if(o[0]==="e"&&o[1]){const[i,a,c,l,h]=o,u={id:a,relays:c?[c]:[],author:h};if(l==="root"){e.root=u;continue}if(l==="reply"){e.reply=u;continue}if(l==="mention"){e.mentions.push(u);continue}t?n=u:t=u,e.mentions.push(u);continue}if(o[0]==="q"&&o[1]){const[i,a,c]=o;e.quotes.push({id:a,relays:c?[c]:[]})}if(o[0]==="p"&&o[1]){e.profiles.push({pubkey:o[1],relays:o[2]?[o[2]]:[]});continue}}return e.root||(e.root=n||t||e.reply),e.reply||(e.reply=t||e.root),[e.reply,e.root].forEach(s=>{if(!s)return;let o=e.mentions.indexOf(s);if(o!==-1&&e.mentions.splice(o,1),s.author){let i=e.profiles.find(a=>a.pubkey===s.author);i&&i.relays&&(s.relays||(s.relays=[]),i.relays.forEach(a=>{var c;((c=s.relays)==null?void 0:c.indexOf(a))===-1&&s.relays.push(a)}),i.relays=s.relays)}}),e.mentions.forEach(s=>{if(s.author){let o=e.profiles.find(i=>i.pubkey===s.author);o&&o.relays&&(s.relays||(s.relays=[]),o.relays.forEach(i=>{s.relays.indexOf(i)===-1&&s.relays.push(i)}),o.relays=s.relays)}}),e}var Uu={};W(Uu,{fetchRelayInformation:()=>Du,useFetchImplementation:()=>Bu});var go;try{go=fetch}catch{}function Bu(r){go=r}async function Du(r){return await(await fetch(r.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var Fu={};W(Fu,{fastEventHash:()=>yo,getPow:()=>po,minePow:()=>Hu});function po(r){let e=0;for(let t=0;t<64;t+=8){const n=parseInt(r.substring(t,t+8),16);if(n===0)e+=32;else{e+=Math.clz32(n);break}}return e}function Hu(r,e){let t=0;const n=r,s=["nonce",t.toString(),e.toString()];for(n.tags.push(s);;){const o=Math.floor(new Date().getTime()/1e3);if(o!==n.created_at&&(t=0,n.created_at=o),s[1]=(++t).toString(),n.id=yo(n),po(n.id)>=e)break}return n}function yo(r){return ne(yt(me.encode(JSON.stringify([0,r.pubkey,r.created_at,r.kind,r.tags,r.content]))))}var Ku={};W(Ku,{unwrapEvent:()=>eh,unwrapManyEvents:()=>th,wrapEvent:()=>_o,wrapManyEvents:()=>Xu});var Wu={};W(Wu,{createRumor:()=>Ro,createSeal:()=>To,createWrap:()=>Co,unwrapEvent:()=>yn,unwrapManyEvents:()=>Mo,wrapEvent:()=>zt,wrapManyEvents:()=>Yu});var qu={};W(qu,{decrypt:()=>pn,encrypt:()=>gn,getConversationKey:()=>fn,v2:()=>Gu});var mo=1,wo=65535;function fn(r,e){const t=pt.getSharedSecret(r,"02"+e).subarray(1,33);return Dc(yt,t,"nip44-v2")}function bo(r,e){const t=Fc(yt,r,e,76);return{chacha_key:t.subarray(0,32),chacha_nonce:t.subarray(32,44),hmac_key:t.subarray(44,76)}}function dn(r){if(!Number.isSafeInteger(r)||r<1)throw new Error("expected positive integer");if(r<=32)return 32;const e=1<<Math.floor(Math.log2(r-1))+1,t=e<=256?32:e/8;return t*(Math.floor((r-1)/t)+1)}function ju(r){if(!Number.isSafeInteger(r)||r<mo||r>wo)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,r,!1),e}function zu(r){const e=me.encode(r),t=e.length,n=ju(t),s=new Uint8Array(dn(t)-t);return Qt(n,e,s)}function Vu(r){const e=new DataView(r.buffer).getUint16(0),t=r.subarray(2,2+e);if(e<mo||e>wo||t.length!==e||r.length!==2+dn(e))throw new Error("invalid padding");return _e.decode(t)}function vo(r,e,t){if(t.length!==32)throw new Error("AAD associated data must be 32 bytes");const n=Qt(t,e);return er(yt,r,n)}function Zu(r){if(typeof r!="string")throw new Error("payload must be a valid string");const e=r.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(r[0]==="#")throw new Error("unknown encryption version");let t;try{t=Pe.decode(r)}catch(o){throw new Error("invalid base64: "+o.message)}const n=t.length;if(n<99||n>65603)throw new Error("invalid data length: "+n);const s=t[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:t.subarray(1,33),ciphertext:t.subarray(33,-32),mac:t.subarray(-32)}}function gn(r,e,t=Ts(32)){const{chacha_key:n,chacha_nonce:s,hmac_key:o}=bo(e,t),i=zu(r),a=Hs(n,s,i),c=vo(o,a,t);return Pe.encode(Qt(new Uint8Array([2]),t,a,c))}function pn(r,e){const{nonce:t,ciphertext:n,mac:s}=Zu(r),{chacha_key:o,chacha_nonce:i,hmac_key:a}=bo(e,t),c=vo(a,n,t);if(!fc(c,s))throw new Error("invalid MAC");const l=Hs(o,i,n);return Vu(l)}var Gu={utils:{getConversationKey:fn,calcPaddedLen:dn},encrypt:gn,decrypt:pn},Ju=2*24*60*60,Eo=()=>Math.round(Date.now()/1e3),xo=()=>Math.round(Eo()-Math.random()*Ju),Ao=(r,e)=>fn(r,e),So=(r,e,t)=>gn(JSON.stringify(r),Ao(e,t)),Gn=(r,e)=>JSON.parse(pn(r.content,Ao(e,r.pubkey)));function Ro(r,e){const t={created_at:Eo(),content:"",tags:[],...r,pubkey:rr(e)};return t.id=At(t),t}function To(r,e,t){return we({kind:Zs,content:So(r,e,t),created_at:xo(),tags:[]},e)}function Co(r,e){const t=Zc();return we({kind:to,content:So(r,t,e),created_at:xo(),tags:[["p",e]]},t)}function zt(r,e,t){const n=Ro(r,e),s=To(n,e,t);return Co(s,t)}function Yu(r,e,t){if(!t||t.length===0)throw new Error("At least one recipient is required.");const n=rr(e),s=[zt(r,e,n)];return t.forEach(o=>{s.push(zt(r,e,o))}),s}function yn(r,e){const t=Gn(r,e);return Gn(t,e)}function Mo(r,e){let t=[];return r.forEach(n=>{t.push(yn(n,e))}),t.sort((n,s)=>n.created_at-s.created_at),t}function Qu(r,e,t,n){const s={created_at:Math.ceil(Date.now()/1e3),kind:Gs,tags:[],content:e};return(Array.isArray(r)?r:[r]).forEach(({publicKey:i,relayUrl:a})=>{s.tags.push(a?["p",i,a]:["p",i])}),n&&s.tags.push(["e",n.eventId,n.relayUrl||"","reply"]),t&&s.tags.push(["subject",t]),s}function _o(r,e,t,n,s){const o=Qu(e,t,n,s);return zt(o,r,e.publicKey)}function Xu(r,e,t,n,s){if(!e||e.length===0)throw new Error("At least one recipient is required.");return[{publicKey:rr(r)},...e].map(i=>_o(r,i,t,n,s))}var eh=yn,th=Mo,rh={};W(rh,{finishRepostEvent:()=>nh,getRepostedEvent:()=>sh,getRepostedEventPointer:()=>Io});function nh(r,e,t,n){var i;let s;const o=[...r.tags??[],["e",e.id,t],["p",e.pubkey]];return e.kind===Vs?s=sn:(s=an,o.push(["k",String(e.kind)])),we({kind:s,tags:o,content:r.content===""||(i=e.tags)!=null&&i.find(a=>a[0]==="-")?"":JSON.stringify(e),created_at:r.created_at},n)}function Io(r){if(![sn,an].includes(r.kind))return;let e,t;for(let n=r.tags.length-1;n>=0&&(e===void 0||t===void 0);n--){const s=r.tags[n];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&t===void 0&&(t=s))}if(e!==void 0)return{id:e[1],relays:[e[2],t==null?void 0:t[2]].filter(n=>typeof n=="string"),author:t==null?void 0:t[1]}}function sh(r,{skipVerification:e}={}){const t=Io(r);if(t===void 0||r.content==="")return;let n;try{n=JSON.parse(r.content)}catch{return}if(n.id===t.id&&!(!e&&!nr(n)))return n}var oh={};W(oh,{NOSTR_URI_REGEX:()=>mn,parse:()=>ah,test:()=>ih});var mn=new RegExp(`nostr:(${lo.source})`);function ih(r){return typeof r=="string"&&new RegExp(`^${mn.source}$`).test(r)}function ah(r){const e=r.match(new RegExp(`^${mn.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${r}`);return{uri:e[0],value:e[1],decoded:ir(e[1])}}var ch={};W(ch,{finishReactionEvent:()=>lh,getReactedEventPointer:()=>uh});function lh(r,e,t){const n=e.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return we({...r,kind:on,tags:[...r.tags??[],...n,["e",e.id],["p",e.pubkey]],content:r.content??"+"},t)}function uh(r){if(r.kind!==on)return;let e,t;for(let n=r.tags.length-1;n>=0&&(e===void 0||t===void 0);n--){const s=r.tags[n];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&t===void 0&&(t=s))}if(!(e===void 0||t===void 0))return{id:e[1],relays:[e[2],t[2]].filter(n=>n!==void 0),author:t[1]}}var hh={};W(hh,{parse:()=>dh});var fh=/\W/m,Jn=/\W |\W$|$|,| /m;function*dh(r){const e=r.length;let t=0,n=0;for(;n<e;){let s=r.indexOf(":",n);if(s===-1)break;if(r.substring(s-5,s)==="nostr"){const o=r.substring(s+60).match(fh),i=o?s+60+o.index:e;try{let a,{data:c,type:l}=ir(r.substring(s+1,i));switch(l){case"npub":a={pubkey:c};break;case"nsec":case"note":n=i+1;continue;default:a=c}t!==s-5&&(yield{type:"text",text:r.substring(t,s-5)}),yield{type:"reference",pointer:a},n=i,t=n;continue}catch{n=s+1;continue}}else if(r.substring(s-5,s)==="https"||r.substring(s-4,s)==="http"){const o=r.substring(s+4).match(Jn),i=o?s+4+o.index:e,a=r[s-1]==="s"?5:4;try{let c=new URL(r.substring(s-a,i));if(c.hostname.indexOf(".")===-1)throw new Error("invalid url");if(t!==s-a&&(yield{type:"text",text:r.substring(t,s-a)}),c.pathname.endsWith(".png")||c.pathname.endsWith(".jpg")||c.pathname.endsWith(".jpeg")||c.pathname.endsWith(".gif")||c.pathname.endsWith(".webp")){yield{type:"image",url:c.toString()},n=i,t=n;continue}if(c.pathname.endsWith(".mp4")||c.pathname.endsWith(".avi")||c.pathname.endsWith(".webm")||c.pathname.endsWith(".mkv")){yield{type:"video",url:c.toString()},n=i,t=n;continue}if(c.pathname.endsWith(".mp3")||c.pathname.endsWith(".aac")||c.pathname.endsWith(".ogg")||c.pathname.endsWith(".opus")){yield{type:"audio",url:c.toString()},n=i,t=n;continue}yield{type:"url",url:c.toString()},n=i,t=n;continue}catch{n=i+1;continue}}else if(r.substring(s-3,s)==="wss"||r.substring(s-2,s)==="ws"){const o=r.substring(s+4).match(Jn),i=o?s+4+o.index:e,a=r[s-1]==="s"?3:2;try{let c=new URL(r.substring(s-a,i));if(c.hostname.indexOf(".")===-1)throw new Error("invalid ws url");t!==s-a&&(yield{type:"text",text:r.substring(t,s-a)}),yield{type:"relay",url:c.toString()},n=i,t=n;continue}catch{n=i+1;continue}}else{n=s+1;continue}}t!==e&&(yield{type:"text",text:r.substring(t)})}var gh={};W(gh,{channelCreateEvent:()=>ph,channelHideMessageEvent:()=>wh,channelMessageEvent:()=>mh,channelMetadataEvent:()=>yh,channelMuteUserEvent:()=>bh});var ph=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return we({kind:Js,tags:[...r.tags??[]],content:t,created_at:r.created_at},e)},yh=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return we({kind:Ys,tags:[["e",r.channel_create_event_id],...r.tags??[]],content:t,created_at:r.created_at},e)},mh=(r,e)=>{const t=[["e",r.channel_create_event_id,r.relay_url,"root"]];return r.reply_to_channel_message_event_id&&t.push(["e",r.reply_to_channel_message_event_id,r.relay_url,"reply"]),we({kind:Qs,tags:[...t,...r.tags??[]],content:r.content,created_at:r.created_at},e)},wh=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return we({kind:Xs,tags:[["e",r.channel_message_event_id],...r.tags??[]],content:t,created_at:r.created_at},e)},bh=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return we({kind:eo,tags:[["p",r.pubkey_to_mute],...r.tags??[]],content:t,created_at:r.created_at},e)},vh={};W(vh,{EMOJI_SHORTCODE_REGEX:()=>Po,matchAll:()=>Eh,regex:()=>wn,replaceAll:()=>xh});var Po=/:(\w+):/,wn=()=>new RegExp(`\\B${Po.source}\\B`,"g");function*Eh(r){const e=r.matchAll(wn());for(const t of e)try{const[n,s]=t;yield{shortcode:n,name:s,start:t.index,end:t.index+n.length}}catch{}}function xh(r,e){return r.replaceAll(wn(),(t,n)=>e({shortcode:t,name:n}))}var Ah={};W(Ah,{useFetchImplementation:()=>Sh,validateGithub:()=>Rh});var bn;try{bn=fetch}catch{}function Sh(r){bn=r}async function Rh(r,e,t){try{return await(await bn(`https://gist.github.com/${e}/${t}/raw`)).text()===`Verifying that I control the following Nostr public key: ${r}`}catch{return!1}}var Th={};W(Th,{makeNwcRequestEvent:()=>Mh,parseConnectionString:()=>Ch});function Ch(r){const{pathname:e,searchParams:t}=new URL(r),n=e,s=t.get("relay"),o=t.get("secret");if(!n||!s||!o)throw new Error("invalid connection string");return{pubkey:n,relay:s,secret:o}}async function Mh(r,e,t){const s=await uo(e,r,JSON.stringify({method:"pay_invoice",params:{invoice:t}})),o={kind:no,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",r]]};return we(o,e)}var _h={};W(_h,{normalizeIdentifier:()=>Ih});function Ih(r){return r=r.trim().toLowerCase(),r=r.normalize("NFKC"),Array.from(r).map(e=>new RegExp("\\p{Letter}","u").test(e)||new RegExp("\\p{Number}","u").test(e)?e:"-").join("")}var Ph={};W(Ph,{getZapEndpoint:()=>$h,makeZapReceipt:()=>Oh,makeZapRequest:()=>Nh,useFetchImplementation:()=>kh,validateZapRequest:()=>Lh});var vn;try{vn=fetch}catch{}function kh(r){vn=r}async function $h(r){try{let e="",{lud06:t,lud16:n}=JSON.parse(r.content);if(t){let{words:i}=dt.decode(t,1e3),a=dt.fromWords(i);e=_e.decode(a)}else if(n){let[i,a]=n.split("@");e=new URL(`/.well-known/lnurlp/${i}`,`https://${a}`).toString()}else return null;let o=await(await vn(e)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function Nh({profile:r,event:e,amount:t,relays:n,comment:s=""}){if(!t)throw new Error("amount not given");if(!r)throw new Error("profile not given");let o={kind:9734,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",r],["amount",t.toString()],["relays",...n]]};if(e&&typeof e=="string"&&o.tags.push(["e",e]),e&&typeof e=="object"){if(nn(e.kind)){const i=["a",`${e.kind}:${e.pubkey}:`];o.tags.push(i)}else if(sr(e.kind)){let i=e.tags.find(([c,l])=>c==="d"&&l);if(!i)throw new Error("d tag not found or is empty");const a=["a",`${e.kind}:${e.pubkey}:${i[1]}`];o.tags.push(a)}}return o}function Lh(r){let e;try{e=JSON.parse(r)}catch{return"Invalid zap request JSON."}if(!Tt(e))return"Zap request is not a valid Nostr event.";if(!nr(e))return"Invalid signature on zap request.";let t=e.tags.find(([o,i])=>o==="p"&&i);if(!t)return"Zap request doesn't have a 'p' tag.";if(!t[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let n=e.tags.find(([o,i])=>o==="e"&&i);return n&&!n[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([o,i])=>o==="relays"&&i)?null:"Zap request doesn't have a 'relays' tag."}function Oh({zapRequest:r,preimage:e,bolt11:t,paidAt:n}){let s=JSON.parse(r),o=s.tags.filter(([a])=>a==="e"||a==="p"||a==="a"),i={kind:9735,created_at:Math.round(n.getTime()/1e3),content:"",tags:[...o,["P",s.pubkey],["bolt11",t],["description",r]]};return e&&i.tags.push(["preimage",e]),i}var Uh={};W(Uh,{getToken:()=>Bh,hashPayload:()=>En,unpackEventFromToken:()=>$o,validateEvent:()=>Do,validateEventKind:()=>Lo,validateEventMethodTag:()=>Uo,validateEventPayloadTag:()=>Bo,validateEventTimestamp:()=>No,validateEventUrlTag:()=>Oo,validateToken:()=>Dh});var ko="Nostr ";async function Bh(r,e,t,n=!1,s){const o={kind:cn,tags:[["u",r],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&o.tags.push(["payload",En(s)]);const i=await t(o);return(n?ko:"")+Pe.encode(me.encode(JSON.stringify(i)))}async function Dh(r,e,t){const n=await $o(r).catch(o=>{throw o});return await Do(n,e,t).catch(o=>{throw o})}async function $o(r){if(!r)throw new Error("Missing token");r=r.replace(ko,"");const e=_e.decode(Pe.decode(r));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function No(r){return r.created_at?Math.round(new Date().getTime()/1e3)-r.created_at<60:!1}function Lo(r){return r.kind===cn}function Oo(r,e){const t=r.tags.find(n=>n[0]==="u");return t?t.length>0&&t[1]===e:!1}function Uo(r,e){const t=r.tags.find(n=>n[0]==="method");return t?t.length>0&&t[1].toLowerCase()===e.toLowerCase():!1}function En(r){const e=yt(me.encode(JSON.stringify(r)));return ne(e)}function Bo(r,e){const t=r.tags.find(s=>s[0]==="payload");if(!t)return!1;const n=En(e);return t.length>0&&t[1]===n}async function Do(r,e,t,n){if(!nr(r))throw new Error("Invalid nostr event, signature invalid");if(!Lo(r))throw new Error("Invalid nostr event, kind invalid");if(!No(r))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!Oo(r,e))throw new Error("Invalid nostr event, url tag invalid");if(!Uo(r,t))throw new Error("Invalid nostr event, method tag invalid");if(n&&typeof n=="object"&&Object.keys(n).length>0&&!Bo(r,n))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}class Fh{constructor(){y(this,"events");this.events=new Map}on(e,t){var n;this.events.has(e)||this.events.set(e,[]),(n=this.events.get(e))==null||n.push(t)}off(e,t){const n=this.events.get(e);n&&this.events.set(e,n.filter(s=>s!==t))}emit(e,...t){const n=this.events.get(e);n&&n.forEach(s=>{try{s(...t)}catch(o){console.error(`Error in event handler for ${e}:`,o)}})}removeAllListeners(){this.events.clear()}}const Ot={PROFILE_UPDATED:"profile:updated",POST_CREATED:"post:created",POST_DELETED:"post:deleted",RELAY_CONNECTED:"relay:connected",RELAY_DISCONNECTED:"relay:disconnected",AUTH_CHANGED:"auth:changed"};class Hh{constructor(){y(this,"events");this.events=new Map}on(e,t){var n;this.events.has(e)||this.events.set(e,[]),(n=this.events.get(e))==null||n.push(t)}off(e,t){const n=this.events.get(e);n&&this.events.set(e,n.filter(s=>s!==t))}emit(e,...t){const n=this.events.get(e);n&&n.forEach(s=>{try{s(...t)}catch(o){console.error(`Error in event handler for ${e}:`,o)}})}}const Ut=new Hh;class Kh{constructor(e){y(this,"emitter");y(this,"profileData",{});y(this,"loadingStatus",{});y(this,"currentPubkey",null);this.emitter=e}getPubkeyFromNpub(e){if(!e)return null;try{return e.startsWith("npub")?Z.getHexFromNpub(e):e}catch(t){return console.error("Invalid pubkey format:",t),null}}getOrCreateProfileData(e,t){return this.profileData[e]||(this.profileData[e]=this.getEmptyProfileData(e,t),this.loadingStatus[e]={metadata:"idle",posts:"idle",relations:"idle",relays:"idle",reactions:"idle"}),this.profileData[e]}getEmptyProfileData(e,t){return{pubkey:e||"",npub:e?Z.getNpubFromHex(e):"",metadata:null,posts:[],media:[],reposts:[],replies:[],reactions:[],followers:[],following:[],relays:[],referencedEvents:{},isCurrentUser:t,loadingState:{metadata:"idle",posts:"idle",relations:"idle",relays:"idle",reactions:"idle"}}}getLoadingStatus(e){return this.loadingStatus[e]||null}setCurrentPubkey(e){this.currentPubkey=e}updateProfileMetadata(e,t){this.profileData[e]&&(this.profileData[e].metadata=t,this.emitter.emit("profile-data-changed",e,this.profileData[e]))}addProfilePost(e,t){this.profileData[e]&&(this.profileData[e].posts.some(n=>n.id===t.id)||(this.profileData[e].posts.push(t),this.profileData[e].posts.sort((n,s)=>s.created_at-n.created_at),this.emitter.emit("profile-data-changed",e,this.profileData[e])))}addProfileMediaPost(e,t){this.profileData[e]&&(this.profileData[e].media.some(n=>n.id===t.id)||(this.profileData[e].media.push(t),this.profileData[e].media.sort((n,s)=>s.created_at-n.created_at),this.emitter.emit("profile-data-changed",e,this.profileData[e])))}cleanupCache(){}}class Wh{constructor(){y(this,"cache",new Map);y(this,"defaultTTL",5*60*1e3)}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),null):t.data:null}set(e,t,n=this.defaultTTL){const s=Date.now(),o=s+n;this.cache.set(e,{data:t,timestamp:s,expiresAt:o})}has(e){const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),!1):!0:!1}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}getKeysWithPrefix(e){return Array.from(this.cache.keys()).filter(t=>t.startsWith(e))}deleteKeysWithPrefix(e){let t=0;for(const n of this.getKeysWithPrefix(e))this.cache.delete(n)&&t++;return t}setDefaultTTL(e){this.defaultTTL=e}}const kt=new Wh,xr=new Map,Ar={image:/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)(\?[^\s]*)?)/gi,video:/(https?:\/\/[^\s]+\.(mp4|webm|mov)(\?[^\s]*)?)/gi,audio:/(https?:\/\/[^\s]+\.(mp3|wav|ogg)(\?[^\s]*)?)/gi,url:/(https?:\/\/[^\s]+)/gi},qh=r=>{try{return r.split("?")[0].split("#")[0]}catch{return r}},jh=r=>{if(!r)return[];const e=`media-${r}`;if(xr.has(e))return xr.get(e)||[];const t=[],n=new Set;let s;const o=new RegExp(Ar.image.source+"|"+Ar.video.source+"|"+Ar.audio.source,"gi");try{for(;(s=o.exec(r))!==null;)if(s[0]){const i=qh(s[0]);n.has(i)||(t.push(s[0]),n.add(i))}}catch(i){console.error("Error extracting URLs from content:",i)}return xr.set(e,t),t},zh=r=>{if(!r)return"";if(r=r.trim(),!/^https?:\/\//i.test(r))try{return new URL(`https://${r}`),`https://${r}`}catch{return r}return r},tt=r=>{if(!r||typeof r!="string")return!1;try{const e=zh(r);if(new URL(e),!e.startsWith("http://")&&!e.startsWith("https://"))return!1;const t=["bit.ly","tinyurl.com","t.co","goo.gl"];for(const s of t)if(e.includes(s))return!0;const n=["i.imgur.com","media.nostr.band","void.cat","nostr.build","primal.net","mako.co.il","v.nostr.build"];for(const s of n)if(e.includes(s))return!0;return!0}catch(e){return console.log("Invalid URL:",r,e),!1}},Of=r=>tt(r)?!!r.match(/\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i):!1,Uf=r=>tt(r)?!!r.match(/\.(mp4|webm|mov|m4v|ogv)(\?.*)?$/i):!1,Bf=r=>tt(r)?!!r.match(/\.(mp3|wav|ogg|flac|aac)(\?.*)?$/i):!1,Yn=r=>{const e=(r==null?void 0:r.content)||"",t=Array.isArray(r==null?void 0:r.tags)?r.tags:[],n=new Set;return Array.isArray(t)&&t.forEach(o=>{Array.isArray(o)&&o.length>=2&&(o[0]==="image"||o[0]==="img"||o[0]==="imeta")&&tt(o[1])&&n.add(o[1])}),jh(e).forEach(o=>n.add(o)),Array.from(n)},Ye=class Ye extends Fh{constructor(){super();y(this,"currentPubkey",null);y(this,"isMounted",!0);y(this,"loadingStateDebounceTimers",new Map);y(this,"LOADING_STATE_DEBOUNCE_MS",100);y(this,"dataManager");y(this,"refreshActiveData",()=>{this.currentPubkey&&(this.loadMetadata(this.currentPubkey,this.dataManager.getLoadingStatus(this.currentPubkey)),this.loadPosts(this.currentPubkey,this.dataManager.getLoadingStatus(this.currentPubkey)))});this.dataManager=new Kh(this),this.on("post-received",(t,n)=>{this.dataManager.addProfilePost(t,n)}),this.on("media-received",(t,n)=>{this.dataManager.addProfileMediaPost(t,n)}),window.addEventListener("relay-connected",this.refreshActiveData),window.addEventListener("relay-disconnected",this.refreshActiveData),this.startCacheCleanup(),this.setupEventHandling()}emitLoadingStateChange(t,n){const s=this.loadingStateDebounceTimers.get(t);s&&clearTimeout(s);const o=setTimeout(()=>{this.emit("loading-state-changed",t,n),this.loadingStateDebounceTimers.delete(t)},this.LOADING_STATE_DEBOUNCE_MS);this.loadingStateDebounceTimers.set(t,o)}static getInstance(){return Ye.instance||(Ye.instance=new Ye),Ye.instance}startCacheCleanup(){setInterval(()=>{this.isMounted},6e4)}parseProfileIdentifiers(t,n){let s="",o="",i=!1,a="";try{if(t)s=Z.getHexFromNpub(t),o=t;else if(n)s=n,o=Z.getNpubFromHex(n);else return a="No npub or current user pubkey provided",{error:a};return i=s===n,{pubkeyHex:s,profileNpub:o,isOwnProfile:i}}catch(c){return{error:c.message||"Invalid identifier format"}}}async loadCompleteProfile(t,n){try{const s=this.parseProfileIdentifiers(t,n);if(s.error)return{profile:null,npub:"",pubkeyHex:"",isOwnProfile:!1,error:s.error};const{pubkeyHex:o,profileNpub:i,isOwnProfile:a}=s,c=await this.loadProfileData(t,n);return{profile:c.metadata?{name:c.metadata.name,display_name:c.metadata.display_name,about:c.metadata.about,picture:c.metadata.picture,banner:c.metadata.banner,nip05:c.metadata.nip05,lud16:c.metadata.lud16,website:c.metadata.website,created_at:c.metadata.created_at}:null,npub:i,pubkeyHex:o,isOwnProfile:a}}catch(s){console.error("[ProfileDataService] Error loading complete profile:",s);const o=this.parseProfileIdentifiers(t,n);return{profile:null,npub:o.profileNpub,pubkeyHex:o.pubkeyHex,isOwnProfile:o.isOwnProfile,error:s.message||"Failed to load profile"}}}setupEventHandling(){Ut.on(Ot.PROFILE_UPDATED,(t,n)=>{t===this.currentPubkey&&this.dataManager.updateProfileMetadata(t,n)})}async loadProfileData(t,n){let s=this.dataManager.getPubkeyFromNpub(t);if(!s&&n&&(s=n),!s)return console.warn("No valid pubkey provided"),this.dataManager.getEmptyProfileData(null,!1);this.currentPubkey=s,this.dataManager.setCurrentPubkey(s);const o=s===n,i=this.dataManager.getOrCreateProfileData(s,o);return await this.connectToOptimalRelays(),this.loadMetadata(s,this.dataManager.getLoadingStatus(s)),setTimeout(()=>{const a=this.dataManager.getLoadingStatus(s);a&&Promise.all([this.loadPosts(s,a),this.loadRelations(s,o,a),this.loadRelays(s,o,a),this.loadReactions(s,a)]).catch(c=>console.error("Error in parallel profile data loading:",c))},100),i}async refreshProfileData(t,n){let s=this.dataManager.getPubkeyFromNpub(t);if(!s&&n&&(s=n),!s)return;const o=this.dataManager.getLoadingStatus(s);if(!o)return;Object.assign(o,{metadata:"idle",posts:"idle",relations:"idle",relays:"idle",reactions:"idle"}),this.emitLoadingStateChange(s,o),await this.connectToOptimalRelays(),await this.loadMetadata(s,this.dataManager.getLoadingStatus(s)),Promise.all([this.loadPosts(s,this.dataManager.getLoadingStatus(s)),this.loadRelations(s,s===n,this.dataManager.getLoadingStatus(s)),this.loadRelays(s,s===n,this.dataManager.getLoadingStatus(s)),this.loadReactions(s,this.dataManager.getLoadingStatus(s))]).catch(a=>console.error("Error in parallel profile data refresh:",a))}getLoadingStatus(t){return this.dataManager.getLoadingStatus(t)}async getProfileMetadata(t){if(!t)throw new Error("No pubkey or npub provided");let n;if(t.startsWith("npub"))try{n=Z.getHexFromNpub(t)}catch(a){throw console.error("Invalid npub:",a),new Error("Invalid npub format")}else n=t;const s=`profile:${n}`,o=kt.get(s);if(o)return console.log(`[ProfileDataService] Cache hit for ${n.substring(0,8)}`),o;console.log(`[ProfileDataService] Fetching profile for ${n.substring(0,8)}`),await Z.connectToUserRelays();const i=await Z.getUserProfile(n);return i&&kt.set(s,i,5*60*1e3),i}async connectToOptimalRelays(){await Z.connectToUserRelays()}async loadMetadata(t,n){if(t)try{const s=kt.get(`profile:${t}`);s?(this.emit("metadata-received",t,s),n.metadata="loading",this.emitLoadingStateChange(t,n)):(n.metadata="loading",this.emitLoadingStateChange(t,n));const o=await Z.getUserProfile(t);o&&(kt.set(`profile:${t}`,o,5*60*1e3),this.emit("metadata-received",t,o)),n.metadata="success",this.emitLoadingStateChange(t,n)}catch(s){console.error("Error loading profile metadata:",s),n.metadata="error",this.emitLoadingStateChange(t,n)}}async loadPosts(t,n){if(t)try{n.posts="loading",this.emitLoadingStateChange(t,n);const s=Ft.getEventsByAuthors([t])||[];if(s.length>0){const h=s.filter(g=>g.kind===1),u=h.sort((g,m)=>m.created_at-g.created_at),f=h.filter(g=>Yn(g).filter(p=>tt(p)).length>0);this.emit("posts-received",t,u),this.emit("media-received",t,f.sort((g,m)=>m.created_at-g.created_at))}await Z.connectToUserRelays();const o=[...s],i=[];await new Promise(h=>{const u=Z.subscribe([{kinds:[1],authors:[t],limit:50}],f=>{if(!o.some(g=>g.id===f.id)){o.push(f),Yn(f).filter(d=>tt(d)).length>0&&i.push(f);try{Ft.cacheEvent(f)}catch(d){console.warn("Failed to cache event:",d)}}});setTimeout(()=>{Z.unsubscribe(u),h()},5e3)});const c=o.sort((h,u)=>u.created_at-h.created_at),l=i.sort((h,u)=>u.created_at-h.created_at);this.emit("posts-received",t,c),this.emit("media-received",t,l),n.posts="success",this.emitLoadingStateChange(t,n)}catch(s){console.error("Error loading profile posts:",s),n.posts="error",this.emitLoadingStateChange(t,n)}}async loadRelations(t,n,s){if(t)try{s.relations="loading",this.emitLoadingStateChange(t,s);const o=[],i=[];await Z.connectToUserRelays(),n&&Z.following?i.push(...Z.following):await new Promise(l=>{const h=Z.subscribe([{kinds:[3],authors:[t],limit:5}],u=>{try{const f=u.tags.filter(g=>g.length>=2&&g[0]==="p").map(g=>g[1]);i.push(...f)}catch(f){console.error("Failed to parse contacts:",f)}});setTimeout(()=>{Z.unsubscribe(h),l()},5e3)}),await new Promise(c=>{const l=Z.subscribe([{kinds:[3],"#p":[t],limit:50}],h=>{const u=h.pubkey;o.includes(u)||o.push(u)});setTimeout(()=>{Z.unsubscribe(l),c()},5e3)}),this.emit("followers-received",t,[...new Set(o)]),this.emit("following-received",t,[...new Set(i)]),s.relations="success",this.emitLoadingStateChange(t,s)}catch(o){console.error("Error loading profile relations:",o),s.relations="error",this.emitLoadingStateChange(t,s)}}async loadRelays(t,n,s){if(t)try{s.relays="loading",this.emitLoadingStateChange(t,s);const o=Z.getRelayStatus();this.emit("relays-received",t,o),s.relays="success",this.emitLoadingStateChange(t,s)}catch(o){console.error("Error loading profile relays:",o),s.relays="error",this.emitLoadingStateChange(t,s)}}async loadReactions(t,n){if(t)try{n.reactions="loading",this.emitLoadingStateChange(t,n),this.emit("reactions-received",t,[]),n.reactions="success",this.emitLoadingStateChange(t,n)}catch(s){console.error("Error loading profile reactions:",s),n.reactions="error",this.emitLoadingStateChange(t,n)}}dispose(){this.isMounted=!1,window.removeEventListener("relay-connected",this.refreshActiveData),window.removeEventListener("relay-disconnected",this.refreshActiveData),this.loadingStateDebounceTimers.forEach(t=>clearTimeout(t)),this.loadingStateDebounceTimers.clear(),this.removeAllListeners(),this.currentPubkey=null,this.dataManager.setCurrentPubkey(null)}};y(Ye,"instance");let Fr=Ye;Fr.getInstance();const Vh=/nostr:(npub1[a-z0-9]{6,}|nprofile1[a-z0-9]{6,}|nevent1[a-z0-9]{6,}|note1[a-z0-9]{6,})/gi,Zh=/@([a-zA-Z0-9_]+)/g;function Df(r){if(!r)return[];const e=[],t=r.match(Vh);t&&e.push(...t);const n=r.match(Zh);return n&&e.push(...n),e}function Qn(r){if(!r)return"";const e=r.substring(0,6),t=r.substring(r.length-4);return`${e}...${t}`}function Gh(r){if(!r.startsWith("nostr:"))return null;const e=r.split(":");if(e.length<2)return null;const t=e[1];try{if(t.startsWith("npub1")){const{type:n,data:s}=ue.decode(t);return n!=="npub"?null:s}else if(t.startsWith("note1")){const{type:n,data:s}=ue.decode(t);return n!=="note"?null:s}else if(t.startsWith("nevent1")){const{type:n,data:s}=ue.decode(t);return n!=="nevent"?null:s.id}}catch(n){return console.error("Error converting nostr URL to hex:",n),null}return null}function Jh(r){return r.startsWith("npub1"),"/"}function Yh(r){return`/post/${r}`}const Qh={formatContent:(r,e)=>{if(!r||typeof r!="string")return H.jsx(H.Fragment,{});try{const n=r.split(/(\s+)/).map((s,o)=>{if(!s)return null;try{if(s.startsWith("nostr:")){const i=s.substring(6);if(i.startsWith("npub")||i.startsWith("nprofile"))return H.jsxs("a",{href:Jh(i),className:"text-primary font-medium hover:underline",children:["@",Qn(i)]},o);if(i.startsWith("note")||i.startsWith("nevent"))return H.jsxs("a",{href:Yh(i),className:"text-primary font-medium hover:underline",children:["#",Qn(i)]},o)}if(s.startsWith("@")&&s.length>1)return H.jsx("span",{className:"text-primary font-medium cursor-pointer hover:underline",children:s},o);if(s.startsWith("#")&&s.length>1)return H.jsx("span",{className:"text-primary cursor-pointer hover:underline",children:s},o);if(s.match(/^https?:\/\//i))return H.jsx("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:s},o)}catch(i){return console.error("Error processing content part:",s,i),s}return s});return H.jsx(H.Fragment,{children:n})}catch(t){return console.error("Error formatting content:",t),H.jsx(H.Fragment,{children:r})}},formatEventContent:(r,e)=>{try{return Qh.formatContent(r)}catch(t){return console.error("Error formatting event content:",t),H.jsx(H.Fragment,{children:r})}},processContent:r=>{if(!r||typeof r!="string")return"";try{return r}catch(e){return console.error("Error processing content:",e),r}},parseContent:(r,e)=>{if(!r||typeof r!="string")return[];try{const t=[],n=/(@\w+|nostr:(npub|note|nevent|nprofile)1[a-z0-9]+)/gi;let s,o=0;for(;(s=n.exec(r))!==null;){s.index>o&&t.push({type:"text",content:r.substring(o,s.index)});const i=s[0];i.startsWith("@")?t.push({type:"mention",content:i,data:i.substring(1)}):i.startsWith("nostr:")&&t.push({type:"mention",content:i,data:i}),o=s.index+s[0].length}return o<r.length&&t.push({type:"text",content:r.substring(o)}),t.length>0?t:[{type:"text",content:r}]}catch(t){return console.error("Error parsing content:",t),[{type:"text",content:r}]}},extractMentionedPubkeys:(r,e)=>{const t=[];try{if(e&&Array.isArray(e)&&e.forEach(n=>{Array.isArray(n)&&n[0]==="p"&&n[1]&&t.push(n[1])}),r&&typeof r=="string"){const n=/nostr:npub1[a-z0-9]+/gi,s=r.match(n);s&&s.forEach(o=>{try{const i=Gh(o);i&&!t.includes(i)&&t.push(i)}catch(i){console.error("Error extracting pubkey from nostr URL:",o,i)}})}}catch(n){console.error("Error extracting mentioned pubkeys:",n)}return t}},G={METADATA:0,TEXT_NOTE:1,RECOMMEND_RELAY:2,CONTACT_LIST:3,DM:4,DELETE:5,REPOST:6,REACTION:7,POLL:6001,ARTICLE:30023,PROFILE_BADGES:30008,COMMUNITY_DEFINITION:34550,COMMUNITY_POST:1,BADGE_AWARD:8,PUBLIC_CHAT_MESSAGE:9};class Fo{constructor(){y(this,"_publicKey",null);y(this,"_privateKey",null);y(this,"_following",new Set);y(this,"_profileCache",new Map);y(this,"_extensionDetected",!1)}get publicKey(){return this._publicKey}get following(){return Array.from(this._following)}get hasExtension(){return this._extensionDetected}loadUserKeys(){const e=localStorage.getItem("nostr_pubkey");e&&(this._publicKey=e);const t=localStorage.getItem("nostr_privkey");t&&(this._privateKey=t),this._extensionDetected=!!window.nostr}loadFollowing(){const e=localStorage.getItem("nostr_following");if(e)try{const t=JSON.parse(e);this._following=new Set(t)}catch(t){console.error("Error loading following list:",t)}}saveFollowing(){this._publicKey&&localStorage.setItem("nostr_following",JSON.stringify(Array.from(this._following)))}isFollowing(e){return this._following.has(e)}async login(){try{if(window.nostr)try{const e=await window.nostr.getPublicKey();if(e){this._publicKey=e,localStorage.setItem("nostr_pubkey",e);try{if("getRelays"in window.nostr&&typeof window.nostr.getRelays=="function"){const t=await window.nostr.getRelays();t&&localStorage.setItem("nostr_extension_relays",JSON.stringify(t))}}catch(t){console.warn("Could not get relays from extension:",t)}return ct.success("Successfully connected with extension"),!0}}catch(e){console.error("Failed to get public key from extension:",e),ct.error("Failed to connect with Nostr extension")}else ct.error("No Nostr extension found. Please install one (like nos2x or Alby)");return!1}catch(e){return console.error("Login error:",e),!1}}signOut(){this._publicKey=null,this._privateKey=null,localStorage.removeItem("nostr_pubkey"),localStorage.removeItem("nostr_privkey")}formatPubkey(e,t="npub"){if(!e)return"";try{if(t==="npub"&&e.length===64)return ue.npubEncode(e);if(t==="hex"&&e.startsWith("npub1")){const{data:n}=ue.decode(e);return n}}catch(n){console.error("Error formatting pubkey:",n)}return e}getNpubFromHex(e){try{return ue.npubEncode(e)}catch(t){return console.error("Error encoding pubkey:",t),e}}getHexFromNpub(e){try{const{data:t}=ue.decode(e);return t}catch(t){return console.error("Error decoding npub:",t),e}}setPublicKey(e){this._publicKey=e,e&&localStorage.setItem("nostr_pubkey",e)}addFollowing(e){this._following.add(e),this.saveFollowing()}removeFollowing(e){this._following.delete(e),this.saveFollowing()}setFollowing(e){this._following=new Set(e),this.saveFollowing()}async getUserProfile(e){return e&&this._profileCache.has(e)&&this._profileCache.get(e)||null}}class Xh{constructor(e){y(this,"pool");y(this,"relayInfoCache",new Map);this.pool=e}async getRelayInfo(e){if(this.relayInfoCache.has(e))return this.relayInfoCache.get(e)||null;try{let t=e.endsWith("/")?e.slice(0,-1):e;t.startsWith("wss://")?t=t.replace("wss://","https://"):t.startsWith("ws://")&&(t=t.replace("ws://","http://"));const n=new Headers({Accept:"application/nostr+json"}),s=await fetch(t,{headers:n});if(!s.ok)return console.warn(`Failed to fetch NIP-11 information from ${e}: ${s.status}`),null;const o=await s.json();return this.isValidRelayInfo(o)?(this.relayInfoCache.set(e,o),o):(console.warn(`Invalid NIP-11 information from ${e}`),null)}catch(t){return console.error(`Error fetching relay information for ${e}:`,t),null}}async getSupportedNIPs(e){const t=await this.getRelayInfo(e);return(t==null?void 0:t.supported_nips)||[]}async supportsNIP(e,t){return(await this.getSupportedNIPs(e)).includes(t)}async getRelayLimitations(e){const t=await this.getRelayInfo(e);return(t==null?void 0:t.limitation)||null}isValidRelayInfo(e){return!!e&&typeof e.name=="string"}clearCache(){this.relayInfoCache.clear()}}const ef=r=>{try{return localStorage.getItem(r)}catch(e){return console.warn(`Error reading from localStorage (${r}):`,e),null}},tf=(r,e)=>{try{return localStorage.setItem(r,e),!0}catch(t){return console.warn(`Error writing to localStorage (${r}):`,t),!1}};class rf{constructor(){y(this,"relayData",new Map);y(this,"STORAGE_KEY","nostr_relay_performance");y(this,"MAX_METRICS_PER_RELAY",20);y(this,"saveTimeout",null);this.loadFromStorage()}trackResponseTime(e,t,n){const s={timestamp:Date.now(),success:!0,duration:n,operation:t};this.addMetric(e,s)}recordSuccess(e,t){const n={timestamp:Date.now(),success:!0,operation:t};this.addMetric(e,n)}recordFailure(e,t,n){const s={timestamp:Date.now(),success:!1,operation:t,error:n};this.addMetric(e,s)}addMetric(e,t){if(!e)return;const n=this.relayData.get(e)||{url:e,metrics:[],lastUpdated:Date.now()};n.metrics.unshift(t),n.metrics.length>this.MAX_METRICS_PER_RELAY&&(n.metrics=n.metrics.slice(0,this.MAX_METRICS_PER_RELAY)),this.updateRelayStats(n),this.relayData.set(e,n),this.debouncedSave()}updateRelayStats(e){if(!e.metrics.length)return;const t=e.metrics.filter(c=>c.success&&typeof c.duration=="number").map(c=>c.duration);t.length>0&&(e.avgResponseTime=t.reduce((c,l)=>c+l,0)/t.length);const n=e.metrics.length,s=e.metrics.filter(c=>c.success).length;e.successRate=n>0?s/n:0,e.lastUpdated=Date.now();const o=e.avgResponseTime?Math.min(1,2e3/(e.avgResponseTime+500)):.5,i=e.successRate||0,a=this.calculateRecencyWeight(e.metrics);e.score=Math.round((o*.4+i*.4+a*.2)*100)}calculateRecencyWeight(e){if(!e.length)return 0;const t=Date.now(),n=36e5,s=e.map(c=>{const l=t-c.timestamp;return Math.max(0,1-l/n)}),o=e.filter(c=>c.success).map((c,l)=>c.success?s[l]:0).reduce((c,l)=>c+l,0),i=e.filter(c=>!c.success).map((c,l)=>c.success?0:s[l]).reduce((c,l)=>c+l,0);return s.reduce((c,l)=>c+l,0)>0?o/(o+i):.5}getRelayPerformance(e){return this.relayData.get(e)}getRelayScore(e){const t=this.relayData.get(e);return(t==null?void 0:t.score)||50}getAllRelayPerformance(){return Array.from(this.relayData.values())}updateSupportedNips(e,t){const n=this.relayData.get(e)||{url:e,metrics:[],lastUpdated:Date.now()};n.supportedNips=t,this.relayData.set(e,n),this.debouncedSave()}updateGeolocation(e,t){const n=this.relayData.get(e)||{url:e,metrics:[],lastUpdated:Date.now()};n.geolocation=t,this.relayData.set(e,n),this.debouncedSave()}loadFromStorage(){try{const e=ef(this.STORAGE_KEY);e&&(JSON.parse(e).forEach(n=>{this.relayData.set(n.url,n)}),console.log(`Loaded performance data for ${this.relayData.size} relays`))}catch(e){console.error("Error loading relay performance data:",e)}}saveToStorage(){try{const e=Array.from(this.relayData.values());this.pruneOldData(),tf(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Error saving relay performance data:",e)}}pruneOldData(){const e=Date.now(),t=7*24*60*60*1e3;this.relayData.forEach((n,s)=>{n.metrics=n.metrics.filter(o=>e-o.timestamp<t),n.metrics.length===0&&e-n.lastUpdated>t&&this.relayData.delete(s)})}debouncedSave(){this.saveTimeout&&window.clearTimeout(this.saveTimeout),this.saveTimeout=window.setTimeout(()=>{this.saveToStorage(),this.saveTimeout=null},5e3)}}const le=new rf;class nf{selectBestRelays(e,t){if(!e.length)return[];const{operation:n="both",count:s=3,requireWriteSupport:o=!1,preferredNips:i=[],requireNips:a=[],minScore:c=0}=t,l=u=>{let f=le.getRelayScore(u);const g=le.getRelayPerformance(u);if(g!=null&&g.supportedNips){if(a.length){for(const m of a)if(!g.supportedNips.includes(m))return 0}if(i.length){const d=i.filter(p=>{var w;return(w=g.supportedNips)==null?void 0:w.includes(p)}).length/i.length*20;f+=d}}return g!=null&&g.avgResponseTime&&g.avgResponseTime>2e3&&(f-=20),f};return e.map(u=>({url:u,score:l(u)})).filter(u=>u.score>=c).sort((u,f)=>f.score-u.score).slice(0,s).map(u=>u.url)}selectRelaysByOperationType(e,t=3,n=2){const s=this.selectBestRelays(e,{operation:"write",count:n,requireWriteSupport:!0,minScore:40}),o=e.filter(a=>!s.includes(a));return{read:this.selectBestRelays(o,{operation:"read",count:t,minScore:30}),write:s}}findFastestRelay(e){if(!e.length)return;let t,n=1/0;return e.forEach(s=>{const o=le.getRelayPerformance(s);o!=null&&o.avgResponseTime&&o.avgResponseTime<n&&(n=o.avgResponseTime,t=s)}),t||e[0]}}const Fe=new nf;var Ct=(r=>(r[r.CLOSED=0]="CLOSED",r[r.OPEN=1]="OPEN",r[r.HALF_OPEN=2]="HALF_OPEN",r))(Ct||{});class sf{constructor(e={failureThreshold:3,resetTimeout:6e4,halfOpenRequests:1}){y(this,"circuits",new Map);y(this,"DEFAULT_OPTIONS",{failureThreshold:3,resetTimeout:6e4,halfOpenRequests:1});this.options=e,this.options={...this.DEFAULT_OPTIONS,...e}}isAllowed(e){if(!this.circuits.has(e))return this.circuits.set(e,{state:0,failures:0,successful:0,lastFailure:0,nextAttempt:0}),!0;const t=this.circuits.get(e),n=Date.now();switch(t.state){case 1:return n>=t.nextAttempt?(console.log(`Circuit for ${e} transitioning from OPEN to HALF_OPEN`),t.state=2,t.successful=0,!0):!1;case 2:return t.successful<this.options.halfOpenRequests;case 0:default:return!0}}recordSuccess(e){if(!this.circuits.has(e)){this.circuits.set(e,{state:0,failures:0,successful:0,lastFailure:0,nextAttempt:0});return}const t=this.circuits.get(e);t.state===2?(t.successful++,t.successful>=this.options.halfOpenRequests&&(console.log(`Circuit for ${e} closing - service recovered`),t.state=0,t.failures=0)):t.state===0&&(t.failures=Math.max(0,t.failures-1))}recordFailure(e){if(!this.circuits.has(e)){this.circuits.set(e,{state:0,failures:1,successful:0,lastFailure:Date.now(),nextAttempt:0});return}const t=this.circuits.get(e);t.failures++,t.lastFailure=Date.now(),(t.state===2||t.state===0&&t.failures>=this.options.failureThreshold)&&(console.log(`Circuit for ${e} opening - too many failures`),t.state=1,t.nextAttempt=Date.now()+this.options.resetTimeout)}reset(e){this.circuits.set(e,{state:0,failures:0,successful:0,lastFailure:0,nextAttempt:0})}getState(e){var t;return(t=this.circuits.get(e))==null?void 0:t.state}}const j=new sf;class of{constructor(e){y(this,"discoveredRelays",new Map);y(this,"popularRelays",["wss://relay.damus.io","wss://nos.lol","wss://relay.nostr.band","wss://nostr.wine","wss://relay.nostr.info","wss://relay.snort.social","wss://nostr.mutinywallet.com","wss://purplepag.es","wss://relay.plebstr.com","wss://relay.primal.net"]);this.pool=e,this.popularRelays.forEach(t=>{this.addDiscoveredRelay(t,"popular")})}async discoverFromContacts(e){if(!e.length)return[];const t=[];let n=new Set;try{console.log(`Discovering relays from ${e.length} contacts...`);const s=l=>{if(l.kind===10002)try{l.tags.filter(u=>u.length>=2&&u[0]==="r").map(u=>u[1]).forEach(u=>{n.has(u)||(n.add(u),this.addDiscoveredRelay(u,"nip65"),t.push({url:u,source:"nip65",addedAt:Date.now()}))})}catch(h){console.error("Error processing relay list event:",h)}},o=l=>{if(l.kind===3)try{l.tags.filter(h=>h.length>=3&&h[0]==="p").forEach(h=>{if(h[2]&&typeof h[2]=="string"&&h[2].startsWith("wss://")){const u=h[2];n.has(u)||(n.add(u),this.addDiscoveredRelay(u,"contact-list"),t.push({url:u,source:"contact-list",addedAt:Date.now()}))}})}catch(h){console.error("Error processing contact list event:",h)}},i=Array.from(n);return(await this.fetchEvents(i,{kinds:[10002],authors:e})).forEach(s),(await this.fetchEvents(i,{kinds:[3],authors:e})).forEach(o),t}catch(s){return console.error("Error discovering relays from contacts:",s),[]}}async fetchEvents(e,t,n=5e3){return new Promise(s=>{const o=[],i=setTimeout(()=>{s(o)},n);try{const a=this.pool.subscribeMany(e,[t],{onevent:c=>{o.push(c)},oneose:()=>{clearTimeout(i),s(o),a.close()}})}catch(a){console.error("Error fetching events:",a),clearTimeout(i),s(o)}})}addDiscoveredRelay(e,t){const n=this.normalizeRelayUrl(e);n&&(this.discoveredRelays.has(n)||this.discoveredRelays.set(n,{url:n,source:t,addedAt:Date.now()}))}getDiscoveredRelays(){return Array.from(this.discoveredRelays.values())}normalizeRelayUrl(e){try{return!e.startsWith("wss://")&&!e.startsWith("ws://")?void 0:new URL(e).href}catch{console.warn(`Invalid relay URL: ${e}`);return}}async testRelay(e,t=3e3){try{const n=performance.now();if(j.getState(e)===1)return!1;const s=new WebSocket(e);return new Promise(o=>{const i=setTimeout(()=>{s.close(),le.recordFailure(e,"connect","Timeout"),j.recordFailure(e),o(!1)},t);s.onopen=()=>{clearTimeout(i);const a=performance.now()-n;le.trackResponseTime(e,"connect",a),j.recordSuccess(e),s.close(),o(!0)},s.onerror=()=>{clearTimeout(i),le.recordFailure(e,"connect","Connection error"),j.recordFailure(e),s.close(),o(!1)}})}catch(n){return console.error(`Error testing relay ${e}:`,n),le.recordFailure(e,"connect",String(n)),j.recordFailure(e),!1}}getBestRelaysToTry(e=3,t=[]){const n=new Set(t),s=Array.from(this.discoveredRelays.values()).filter(i=>!n.has(i.url)).filter(i=>j.getState(i.url)!==1);if(s.length===0)return[];const o={nip65:5,contact:4,"contact-list":3,popular:2,meta:1,manual:0};return s.sort((i,a)=>{const c=(o[a.source]||0)-(o[i.source]||0);return c!==0?c:a.addedAt-i.addedAt}),s.slice(0,e).map(i=>i.url)}}class af{constructor(e){y(this,"pool");y(this,"_userRelays",new Map);y(this,"defaultRelays",["wss://relay.damus.io","wss://nos.lol","wss://nostr.bitcoiner.social","wss://relay.nostr.band"]);y(this,"relayInfoService");y(this,"relayDiscoverer");y(this,"performanceTracker",le);y(this,"discoveryRunning",!1);y(this,"relays",new Map);y(this,"connectionStatus",new Map);y(this,"reconnectTimers",new Map);y(this,"healthCheckInterval",null);this.pool=e,this.loadUserRelays(),this.relayInfoService=new Xh(this.pool),this.relayDiscoverer=new of(this.pool),this.startHealthCheck(),setTimeout(()=>this.investigateRelayPerformance(),1e4)}get userRelays(){return new Map(this._userRelays)}loadUserRelays(){const e=localStorage.getItem("nostr_user_relays");if(e)try{const t=JSON.parse(e);this._userRelays=new Map(Object.entries(t))}catch(t){console.error("Error loading user relays:",t)}else this.defaultRelays.forEach(t=>{this._userRelays.set(t,!0)})}saveUserRelays(){const e=Object.fromEntries(this._userRelays);localStorage.setItem("nostr_user_relays",JSON.stringify(e))}async connectToRelay(e,t=0){var o;if(!j.isAllowed(e))return console.log(`Circuit breaker preventing connection to ${e}`),!1;if(this.relays.has(e)&&((o=this.relays.get(e))==null?void 0:o.readyState)===WebSocket.OPEN)return!0;this.connectionStatus.has(e)||this.connectionStatus.set(e,{connected:!1,lastAttempt:Date.now(),failures:0});const n=this.connectionStatus.get(e);n.lastAttempt=Date.now(),this.reconnectTimers.has(e)&&(window.clearTimeout(this.reconnectTimers.get(e)),this.reconnectTimers.delete(e));const s=performance.now();try{const i=new WebSocket(e);return new Promise(a=>{i.onopen=()=>{this.relays.set(e,i),n.connected=!0,n.failures=0;const c=performance.now()-s;this.performanceTracker.trackResponseTime(e,"connect",c),j.recordSuccess(e),this.fetchRelayInfo(e).catch(l=>console.warn(`Failed to fetch relay info for ${e}:`,l)),a(!0)},i.onerror=()=>{n.failures++,this.performanceTracker.recordFailure(e,"connect","Connection failed"),j.recordFailure(e),a(!1)},i.onclose=()=>{if(n.connected=!1,this.relays.delete(e),t<6){const c=Math.min(1e3*Math.pow(2,t),6e4),l=window.setTimeout(()=>{this.connectToRelay(e,t+1)},c);this.reconnectTimers.set(e,l)}},i.onmessage=c=>{try{const l=JSON.parse(c.data)}catch(l){console.error("Error parsing relay message:",l)}},setTimeout(()=>{i.readyState!==WebSocket.OPEN&&(i.close(),this.performanceTracker.recordFailure(e,"connect","Connection timeout"),j.recordFailure(e),a(!1))},5e3)})}catch(i){return console.error(`Failed to connect to relay ${e}:`,i),n.failures++,this.performanceTracker.recordFailure(e,"connect",String(i)),j.recordFailure(e),!1}}async fetchRelayInfo(e){try{const t=await this.relayInfoService.getRelayInfo(e);t!=null&&t.supported_nips&&this.performanceTracker.updateSupportedNips(e,t.supported_nips)}catch(t){console.warn(`Failed to fetch relay info for ${e}:`,t)}}async connectToDefaultRelays(){const e=Fe.selectBestRelays(this.defaultRelays,{operation:"both",count:this.defaultRelays.length});return this.connectToRelays(e)}async connectToUserRelays(){const e=Array.from(this._userRelays.keys());e.length<3&&this.defaultRelays.forEach(n=>{this._userRelays.has(n)||e.push(n)});const t=Fe.selectBestRelays(e,{operation:"both",count:Math.min(e.length,5)});return this.startBackgroundDiscovery(),this.connectToRelays(t)}async addRelay(e,t=!0){try{new URL(e)}catch{return!1}const n=performance.now(),s=await this.connectToRelay(e),o=performance.now()-n;return s?(this.performanceTracker.trackResponseTime(e,"connect",o),j.recordSuccess(e),this._userRelays.set(e,t),this.saveUserRelays(),this.fetchRelayInfo(e).catch(i=>console.warn(`Failed to fetch relay info for ${e}:`,i)),this.relayDiscoverer.addDiscoveredRelay(e,"manual"),!0):(this.performanceTracker.recordFailure(e,"connect","Failed to connect"),j.recordFailure(e),!1)}removeRelay(e){this._userRelays.delete(e),this.saveUserRelays(),this.disconnect(e)}getRelayStatus(){const e=new Map;return Array.from(this._userRelays.keys()).forEach(n=>{const s=this.isConnected(n),o=j.getState(n),i=this.performanceTracker.getRelayPerformance(n);e.set(n,{url:n,status:s?"connected":o===Ct.OPEN?"failed":"disconnected",read:!0,write:!!this._userRelays.get(n),score:i==null?void 0:i.score,avgResponse:i==null?void 0:i.avgResponseTime})}),this.getConnectedRelayUrls().forEach(n=>{if(!e.has(n)){const s=this.performanceTracker.getRelayPerformance(n);e.set(n,{url:n,status:"connected",read:!0,write:!0,score:s==null?void 0:s.score,avgResponse:s==null?void 0:s.avgResponseTime})}}),Array.from(e.values())}async addMultipleRelays(e){if(!e.length)return 0;const t=e.filter(o=>!this._userRelays.has(o));if(t.length===0)return 0;const n=t.filter(o=>j.getState(o)!==Ct.OPEN);let s=0;for(const o of n){try{await this.addRelay(o)&&(s++,this.relayDiscoverer.addDiscoveredRelay(o,"manual"))}catch(i){console.error(`Failed to add relay ${o}:`,i)}await new Promise(i=>setTimeout(i,100))}return s}setUserRelays(e){this._userRelays=e,this.saveUserRelays(),this.connectToUserRelays()}pickBestRelays(e,t=3){const n=this.getRelayStatus().filter(s=>s.status==="connected").map(s=>s.url);return Fe.selectBestRelays(n,{operation:e,count:t,requireWriteSupport:e==="write",minScore:30})}async getRelayInformation(e){const t=await this.relayInfoService.getRelayInfo(e);return t!=null&&t.supported_nips&&this.performanceTracker.updateSupportedNips(e,t.supported_nips),t}async doesRelaySupport(e,t){return this.relayInfoService.supportsNIP(e,t)}async getRelayLimitations(e){return this.relayInfoService.getRelayLimitations(e)}async startBackgroundDiscovery(){if(!this.discoveryRunning){this.discoveryRunning=!0;try{const e=this.getConnectedRelayUrls();if(e.length>0){console.log("Starting background relay discovery...");const t=[];if(t.length>0){const n=await this.relayDiscoverer.discoverFromContacts(t);console.log(`Discovered ${n.length} new relays from contacts`);const s=this.relayDiscoverer.getBestRelaysToTry(3,e);for(const o of s)this.relayDiscoverer.testRelay(o).catch(i=>{console.warn(`Error testing relay ${o}:`,i)})}}}catch(e){console.error("Error in background relay discovery:",e)}finally{this.discoveryRunning=!1,setTimeout(()=>{this.discoveryRunning=!1},3e5)}}}async investigateRelayPerformance(){try{const e=this.getRelayStatus();if(e.filter(n=>n.status==="connected").length<2){console.log("Not enough connected relays, trying discovery...");const n=this.relayDiscoverer.getDiscoveredRelays(),s=this.relayDiscoverer.getBestRelaysToTry(3,e.map(o=>o.url));s.length>0&&(console.log(`Trying ${s.length} new relays from discoveries...`),await this.addMultipleRelays(s))}setTimeout(()=>this.investigateRelayPerformance(),6e4)}catch(e){console.error("Error investigating relay performance:",e),setTimeout(()=>this.investigateRelayPerformance(),6e4)}}cleanup(){this.stopHealthCheck(),this.cleanupConnections()}async connectToRelays(e){const t=e.map(n=>this.connectToRelay(n));await Promise.all(t)}getRelaySocket(e){return this.relays.get(e)}getConnectedRelayUrls(){return Array.from(this.relays.keys()).filter(e=>{var t;return((t=this.relays.get(e))==null?void 0:t.readyState)===WebSocket.OPEN})}isConnected(e){var t;return this.relays.has(e)&&((t=this.relays.get(e))==null?void 0:t.readyState)===WebSocket.OPEN}disconnect(e){const t=this.relays.get(e);t&&(t.readyState===WebSocket.OPEN||t.readyState===WebSocket.CONNECTING)&&(t.close(),this.relays.delete(e)),this.reconnectTimers.has(e)&&(window.clearTimeout(this.reconnectTimers.get(e)),this.reconnectTimers.delete(e))}cleanupConnections(){this.relays.forEach(e=>{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close()}),this.relays.clear(),this.reconnectTimers.forEach(e=>{window.clearTimeout(e)}),this.reconnectTimers.clear()}startHealthCheck(e=3e4){this.healthCheckInterval!==null&&window.clearInterval(this.healthCheckInterval),this.healthCheckInterval=window.setInterval(()=>{this.performHealthCheck()},e)}async performHealthCheck(){for(const e of this._userRelays.keys())this.isConnected(e)||this.connectToRelay(e)}stopHealthCheck(){this.healthCheckInterval!==null&&(window.clearInterval(this.healthCheckInterval),this.healthCheckInterval=null)}}class cf{constructor(e){y(this,"pool");y(this,"subscriptions",new Map);y(this,"nextId",0);y(this,"maxSubscriptions",100);this.pool=e}subscribe(e,t,n,s={}){if(e.length===0)return console.error("No relays provided for subscription"),"";if(t.length===0)return console.error("No filters provided for subscription"),"";this.subscriptions.size>=this.maxSubscriptions&&(console.warn("Maximum subscription limit reached, closing oldest subscription"),this.closeOldestSubscription());const o=`sub_${this.nextId++}`;try{const i=t.map(c=>{try{return this.pool.subscribe(e,c,{onevent:l=>{n(l)}})}catch(l){return console.error("Error creating individual subscription:",l),null}}).filter(Boolean);if(i.length===0)return console.error("All subscriptions failed to create"),"";const a={relays:e,filters:t,subClosers:i};return s.autoClose!==!1&&s.timeoutMs&&(a.timeoutId=window.setTimeout(()=>{console.log(`Auto-closing subscription ${o} after timeout`),this.unsubscribe(o)},s.timeoutMs)),this.subscriptions.set(o,a),o}catch(i){return console.error("Error creating subscription:",i),""}}unsubscribe(e){const t=this.subscriptions.get(e);if(t)try{t.timeoutId&&clearTimeout(t.timeoutId),t.subClosers.forEach(n=>{if(n&&typeof n.close=="function")try{n.close()}catch(s){console.error("Error closing subscription:",s)}}),this.subscriptions.delete(e)}catch(n){console.error(`Error unsubscribing from ${e}:`,n)}}closeOldestSubscription(){if(this.subscriptions.size===0)return;const e=Array.from(this.subscriptions.keys())[0];this.unsubscribe(e)}hasSubscription(e){return this.subscriptions.has(e)}getActiveSubscriptionIds(){return Array.from(this.subscriptions.keys())}unsubscribeAll(){this.getActiveSubscriptionIds().forEach(e=>this.unsubscribe(e))}getActiveSubscriptionCount(){return this.subscriptions.size}}class Ho{async publishEvent(e,t,n,s,o){if(!t)return console.error("Public key not available"),null;const i={pubkey:t,created_at:Math.floor(Date.now()/1e3),kind:s.kind||G.TEXT_NOTE,tags:s.tags||[],content:s.content||""},a=At(i);let c;try{if(window.nostr)try{if(c=await window.nostr.signEvent({kind:i.kind,created_at:i.created_at,content:i.content,tags:i.tags,pubkey:t}),!Tt(c))return console.error("Invalid signature from extension"),null}catch(l){return console.error("Extension signing failed:",l),null}else if(n){let l;try{if(n.match(/^[0-9a-fA-F]{64}$/))l=new Uint8Array(n.match(/.{1,2}/g).map(u=>parseInt(u,16)));else if(n.startsWith("nsec")){const{data:u}=ue.decode(n);l=u}else l=new TextEncoder().encode(n);if(rr(l)!==t)return console.error("Private key doesn't match public key"),null;c=we(i,l)}catch(h){return console.error("Invalid private key format:",h),null}}else return console.error("No signing method available"),null;return Tt(c)?o.length===0?(console.error("No relays available"),null):(e.publish(o,c),a):(console.error("Invalid event signature"),null)}catch(l){return console.error("Error publishing event:",l),null}}async publishProfileMetadata(e,t,n,s,o){if(!t)return!1;try{const i={kind:G.META,content:JSON.stringify(s),tags:[]};return!!await this.publishEvent(e,t,n,i,o)}catch(i){return console.error("Error publishing profile metadata:",i),!1}}async encryptMessage(e,t,n){try{return window.nostr&&window.nostr.nip04?await window.nostr.nip04.encrypt(e,t):(console.error("No encryption method available"),null)}catch(s){return console.error("Encryption error:",s),null}}async decryptMessage(e,t,n){try{return window.nostr&&window.nostr.nip04?await window.nostr.nip04.decrypt(e,t):(console.error("No decryption method available"),null)}catch(s){return console.error("Decryption error:",s),null}}async getEvents(e,t){try{const n=new Lt;if(e.length===0)return[];const s=e[0];return await n.querySync(t,s)}catch(n){return console.error("Error getting events:",n),[]}}async getEventById(e,t){try{const n=new Lt,s={ids:[e]},o=await n.querySync(t,s);return o.length>0?o[0]:null}catch(n){return console.error(`Error fetching event ${e}:`,n),null}}async getProfilesByPubkeys(e,t){try{const n=new Lt,s={kinds:[G.META],authors:e},o=await n.querySync(t,s),i={};for(const a of o)try{const c=JSON.parse(a.content);i[a.pubkey]=c}catch(c){console.error("Error parsing profile content:",c)}return i}catch(n){return console.error("Error getting profiles:",n),{}}}async getUserProfile(e,t=[]){try{return(await this.getProfilesByPubkeys([e],t))[e]||null}catch(n){return console.error(`Error getting profile for ${e}:`,n),null}}async verifyNip05(e,t){var n;try{if(!t||!t.includes("@"))return!1;const[s,o]=t.split("@");if(!s||!o)return!1;const i=await fetch(`https://${o}/.well-known/nostr.json?name=${s}`);return i.ok?((n=(await i.json()).names)==null?void 0:n[s])===e:!1}catch(s){return console.error("Error verifying NIP-05:",s),!1}}}async function lf(r,e,t,n){return new Promise(s=>{let o=0,i=0,a=0,c=0,l=0,h=!1,u=!1,f=!1;const g=[],m=[],d=[],p={kinds:[G.REACTION],"#e":[e],limit:100},w=r.subscribe(t,p,{onevent:M=>{const k=M.content.trim();["+","👍","❤️","🧡","💛","💚","💙","💜","🤎","🖤","🤍","♥️"].includes(k)&&(o++,g.push(M.pubkey),n&&M.pubkey===n&&(h=!0))}}),x={kinds:[G.REPOST],"#e":[e],limit:50},T=r.subscribe(t,x,{onevent:M=>{i++,m.push(M.pubkey),n&&M.pubkey===n&&(u=!0)}});setTimeout(()=>{w.close(),T.close(),s({likes:o,reposts:i,zaps:a,zapAmount:c,replies:l,userHasLiked:h,userHasReposted:u,userHasZapped:f,likers:g,reposters:m,zappers:d})},2e3)})}class uf{constructor(e,t={}){y(this,"pool");y(this,"eventManager");y(this,"userManager");this.pool=e,this.eventManager=t.eventManager,this.userManager=t.userManager}async reactToEvent(e,t,n,s,o,i,a){if(!s||!this.eventManager)return null;try{const c={kind:G.REACTION,content:n,tags:[["e",t]]};return a&&c.tags.push(["p",a]),this.eventManager.publishEvent(e,s,o,c,i)}catch(c){return console.error("Error reacting to event:",c),null}}async repostEvent(e,t,n,s,o,i,a){if(!o||!this.eventManager)return null;try{const c=[["e",t,s||""],["p",n]],l={kind:G.REPOST,content:JSON.stringify({event_id:t,relay:s,pubkey:n,event:{id:t,pubkey:n}}),tags:c};return this.eventManager.publishEvent(e,o,i,l,a)}catch(c){return console.error("Error reposting event:",c),null}}async getReactionCounts(e,t,n){var o;const s=((o=this.userManager)==null?void 0:o.publicKey)||null;return lf(e,t,n,s)}}class Xn{constructor(e,t){y(this,"eventManager");y(this,"userManager");this.eventManager=e,this.userManager=t,console.log("ContactsManager initialized")}async followUser(e,t,n,s){console.log(`ContactsManager.followUser called for: ${t}`);const o=this.userManager.publicKey;if(!o)return console.error("No public key available, cannot follow user"),!1;try{const i=await this.getContactList(e,o,s);if(i.following.includes(t))return console.log(`Already following ${t}`),!0;this.userManager.addFollowing(t);const a=[...i.tags||[],["p",t]],c={kind:G.CONTACTS,content:i.content||"",tags:a};console.log(`Publishing CONTACTS event (kind ${G.CONTACTS}) to ${s.length} relays`);const l=await this.eventManager.publishEvent(e,o,n,c,s);return l?console.log(`Successfully published follow event with ID: ${l}`):console.error("Failed to publish follow event"),!!l}catch(i){return console.error("Error following user:",i),!1}}async unfollowUser(e,t,n,s){console.log(`ContactsManager.unfollowUser called for: ${t}`);const o=this.userManager.publicKey;if(!o)return console.error("No public key available, cannot unfollow user"),!1;try{const i=await this.getContactList(e,o,s);if(!i.following.includes(t))return console.log(`Not following ${t}, nothing to unfollow`),!0;this.userManager.removeFollowing(t);const a=(i.tags||[]).filter(h=>!(h[0]==="p"&&h[1]===t)),c={kind:G.CONTACTS,content:i.content||"",tags:a};console.log(`Publishing CONTACTS event (kind ${G.CONTACTS}) to ${s.length} relays`);const l=await this.eventManager.publishEvent(e,o,n,c,s);return l?console.log(`Successfully published unfollow event with ID: ${l}`):console.error("Failed to publish unfollow event"),!!l}catch(i){return console.error("Error unfollowing user:",i),!1}}async getContactList(e,t,n){return console.log(`Getting contact list for ${t} from ${n.length} relays`),new Promise(s=>{const o={following:[],followers:[],muted:[],blocked:[],pubkeys:[],tags:[],content:""};if(n.length===0){console.warn("No relay URLs provided for getContactList"),s(o);return}const i={kinds:[G.CONTACTS],authors:[t],limit:1};console.log(`Subscribing to CONTACTS events (kind ${G.CONTACTS}) for ${t}`);const a=e.subscribe(n,i,{onevent:c=>{console.log(`Received contact list event for ${t}:`,c);const h=c.tags.filter(u=>u.length>=2&&u[0]==="p").map(u=>u[1]);console.log(`Found ${h.length} contacts for ${t}`),s({following:h,followers:[],muted:[],blocked:[],pubkeys:h,tags:c.tags,content:c.content})}});setTimeout(()=>{a.close(),console.log(`Timeout reached while getting contact list for ${t}`),s(o)},5e3)})}}class hf{constructor(e,t={}){y(this,"pool");y(this,"options");y(this,"interactionsManager");y(this,"contactsManager",null);y(this,"eventManager",null);y(this,"userManager",null);this.pool=e,this.options={cacheExpiration:5*60*1e3,maxCacheSize:1e3,enableMetrics:!1,...t},this.interactionsManager=new uf(e,{}),t.eventManager instanceof Ho&&(this.eventManager=t.eventManager),t.userManager instanceof Fo&&(this.userManager=t.userManager),this.eventManager&&this.userManager&&(this.contactsManager=new Xn(this.eventManager,this.userManager),console.log("ContactsManager initialized in SocialManager"))}initializeManagers(e,t){this.eventManager||(this.eventManager=e),this.userManager||(this.userManager=t),!this.contactsManager&&this.eventManager&&this.userManager&&(this.contactsManager=new Xn(this.eventManager,this.userManager),console.log("ContactsManager initialized after construction in SocialManager"))}async followUser(e,t,n,s){return console.log(`SocialManager.followUser called for pubkey: ${t}`),this.contactsManager?(console.log(`Delegating to ContactsManager.followUser for pubkey: ${t}`),this.contactsManager.followUser(e,t,n,s)):(console.warn(`ContactsManager not available, cannot follow user: ${t}`),!1)}async unfollowUser(e,t,n,s){return console.log(`SocialManager.unfollowUser called for pubkey: ${t}`),this.contactsManager?(console.log(`Delegating to ContactsManager.unfollowUser for pubkey: ${t}`),this.contactsManager.unfollowUser(e,t,n,s)):(console.warn(`ContactsManager not available, cannot unfollow user: ${t}`),!1)}async sendDirectMessage(e,t,n,s,o,i){return console.log(`Sending direct message to: ${t}`),"message-id"}async reactToEvent(e,t,n,s,o,i){return console.log(`Reacting to event ${t} with ${n}`),"reaction-id"}async repostEvent(e,t,n,s,o,i,a){return console.log(`Reposting event ${t}`),"repost-id"}async getReactionCounts(e,t){return{likes:0,reposts:0,replies:0,zaps:0,zapAmount:0}}}class ff{constructor(e){y(this,"eventManager");this.eventManager=e}async createCommunity(e,t,n,s,o,i){if(!s)return null;const a=`community_${Math.random().toString(36).substring(2,10)}`,c={name:t,description:n,creator:s,createdAt:Math.floor(Date.now()/1e3),image:""},l={kind:G.COMMUNITY,content:JSON.stringify(c),tags:[["d",a],["p",s]]};return this.eventManager.publishEvent(e,s,o,l,i)}async createProposal(e,t,n,s,o,i,a,c,l="other",h,u){if(!i||!t)return null;const f=u||Math.floor(Date.now()/1e3)+7*24*60*60,g={title:n,description:s,options:o,category:l,createdAt:Math.floor(Date.now()/1e3),endsAt:f,minQuorum:h||0},m={kind:G.PROPOSAL,content:JSON.stringify(g),tags:[["e",t],["d",`proposal_${Math.random().toString(36).substring(2,10)}`]]};return this.eventManager.publishEvent(e,i,a,m,c)}async voteOnProposal(e,t,n,s,o,i){if(!s||!t)return null;const a={kind:G.VOTE,content:JSON.stringify({optionIndex:n}),tags:[["e",t],["d",`vote_${Math.random().toString(36).substring(2,10)}`]]};return this.eventManager.publishEvent(e,s,o,a,i)}}const lt=new Map,Sr=new Map,xn=r=>!r||typeof r!="string"?!1:r.length===64&&/^[0-9a-f]{64}$/i.test(r),An=r=>!r||typeof r!="string"?!1:r.startsWith("npub1")&&r.length>=60,Ko=r=>{if(!r||typeof r!="string")return"unknown";if(An(r))return r;if(lt.has(r))return lt.get(r)||"unknown";try{if(!xn(r))return r.substring(0,6)+"..."+r.substring(r.length-6);const e=ue.npubEncode(r);return lt.set(r,e),e}catch(e){return console.error("Error formatting pubkey:",e),r.substring(0,6)+"..."+r.substring(r.length-6)}},Wo=r=>{if(!r||typeof r!="string")return"npub1unknown";if(An(r))return r;if(lt.has(r))return lt.get(r)||"npub1unknown";try{if(!xn(r))return console.warn("Invalid hex pubkey format:",r),"npub1invalid";const e=ue.npubEncode(r);return lt.set(r,e),e}catch(e){return console.error("Error encoding npub:",e,"input:",r),"npub1error"}},qo=r=>{if(!r||typeof r!="string")return"";if(!r.startsWith("npub1"))return xn(r)?r:"";if(Sr.has(r))return Sr.get(r)||"";if(!An(r))return console.warn("Invalid npub format:",r),"";try{const{type:e,data:t}=ue.decode(r);if(e!=="npub")return console.warn("Decoded type is not a pubkey:",e),"";const n=t;return Sr.set(r,n),n}catch(e){return console.error("Error decoding npub:",e,"input:",r),""}};class df{constructor(){y(this,"userManager");y(this,"relayManager");y(this,"subscriptionManager");y(this,"eventManager");y(this,"socialManagerInstance");y(this,"communityManager");y(this,"pool");this.pool=new Lt,this.userManager=new Fo,this.relayManager=new af(this.pool),this.subscriptionManager=new cf(this.pool),this.eventManager=new Ho,this.socialManagerInstance=new hf(this.pool,{eventManager:this.eventManager,userManager:this.userManager}),this.communityManager=new ff(this.eventManager),this.userManager.loadUserKeys(),this.userManager.loadFollowing(),this.connectToUserRelays(),this.publicKey&&this.fetchFollowingList()}get socialManager(){return this.socialManagerInstance}get publicKey(){return this.userManager.publicKey}get following(){return this.userManager.following}get userRelays(){return this.relayManager.userRelays}async login(){console.log("[NostrService] Starting login process...");const e=await this.userManager.login();return e?(console.log("[NostrService] UserManager login successful, publicKey:",this.publicKey),await this.fetchFollowingList(),setTimeout(()=>{console.log("[NostrService] Emitting AUTH_CHANGED event with:",{isLoggedIn:!0,publicKey:this.publicKey}),Ut.emit(Ot.AUTH_CHANGED,{isLoggedIn:!0,publicKey:this.publicKey})},100)):console.log("[NostrService] UserManager login failed"),e}signOut(){this.userManager.signOut(),Ut.emit(Ot.AUTH_CHANGED,{isLoggedIn:!1,publicKey:null})}async connectToRelays(e){await this.connectToUserRelays()}async connectToUserRelays(){return await this.relayManager.connectToUserRelays(),this.getRelayUrls()}async connectToDefaultRelays(){return this.connectToUserRelays()}getRelayUrls(){return this.getRelayStatus().filter(e=>e.status==="connected").map(e=>e.url)}async addRelay(e,t=!0){return this.relayManager.addRelay(e,t)}async addMultipleRelays(e){return this.relayManager.addMultipleRelays(e)}removeRelay(e){this.relayManager.removeRelay(e)}getRelayStatus(){return this.relayManager.getRelayStatus()}async getRelaysForUser(e){try{return["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol"]}catch(t){return console.error("Error getting relays for user:",t),[]}}async publishEvent(e){const t=this.getConnectedRelayUrls();return this.eventManager.publishEvent(this.pool,this.publicKey,null,e,t)}async publishProfileMetadata(e){const t=this.getConnectedRelayUrls();return this.eventManager.publishProfileMetadata(this.pool,this.publicKey,null,e,t)}subscribe(e,t,n,s){const o=n||this.getConnectedRelayUrls();return this.subscriptionManager.subscribe(o,e,t)}unsubscribe(e){this.subscriptionManager.unsubscribe(e)}renewSubscription(e,t){return this.subscriptionManager.renewSubscription(e,t)}getSubscriptionDetails(e){return this.subscriptionManager.getSubscriptionDetails(e)}getSubscriptionTimeRemaining(e){return this.subscriptionManager.getSubscriptionTimeRemaining(e)}isFollowing(e){return this.userManager.isFollowing(e)}async followUser(e){console.log(`NostrService.followUser called for: ${e}`),this.getConnectedRelayUrls().length===0&&(console.warn("No connected relays found, attempting to connect to default relays"),await this.connectToDefaultRelays());const n=this.getConnectedRelayUrls();if(n.length===0)return console.error("No relays available for follow operation"),ct.error("Cannot follow user: No relays connected"),!1;console.log(`Using relays for follow operation: ${n.join(", ")}`);const s=await this.socialManagerInstance.followUser(this.pool,e,null,n);return s&&(this.userManager.addFollowing(e),console.log(`User ${e} added to local following list`)),s}async unfollowUser(e){console.log(`NostrService.unfollowUser called for: ${e}`),this.getConnectedRelayUrls().length===0&&(console.warn("No connected relays found, attempting to connect to default relays"),await this.connectToDefaultRelays());const n=this.getConnectedRelayUrls();if(n.length===0)return console.error("No relays available for unfollow operation"),ct.error("Cannot unfollow user: No relays connected"),!1;console.log(`Using relays for unfollow operation: ${n.join(", ")}`);const s=await this.socialManagerInstance.unfollowUser(this.pool,e,null,n);return s&&(this.userManager.removeFollowing(e),console.log(`User ${e} removed from local following list`)),s}async sendDirectMessage(e,t){const n=this.getConnectedRelayUrls();let s=[];try{s=await this.getRelaysForUser(e)}catch(i){console.error("Error finding recipient's relays:",i)}const o=Array.from(new Set([...n,...s]));return this.socialManagerInstance.sendDirectMessage(this.pool,e,t,this.publicKey,null,o.length>0?o:n)}async reactToPost(e,t="+"){const n=this.getConnectedRelayUrls();return this.socialManagerInstance.reactToEvent(this.pool,e,t,this.publicKey,null,n)}async repostNote(e,t){const n=this.getConnectedRelayUrls(),s=n.length>0?n[0]:null;return this.socialManagerInstance.repostEvent(this.pool,e,t,s,this.publicKey,null,n)}formatPubkey(e){return Ko(e)}getNpubFromHex(e){return Wo(e)}getHexFromNpub(e){return qo(e)}async fetchCommunity(e){return this.getConnectedRelayUrls(),{}}async createCommunity(e,t){return this.getConnectedRelayUrls(),null}async createProposal(e,t,n,s,o,i,a){return this.getConnectedRelayUrls(),null}async voteOnProposal(e,t){return this.getConnectedRelayUrls(),null}async getEvents(e){this.getConnectedRelayUrls();try{return await Promise.all(e.map(t=>this.getEventById(t)))}catch(t){return console.error("Error getting events:",t),[]}}async getEventById(e){const t=this.getConnectedRelayUrls();try{return new Promise((n,s)=>{const o=this.subscribe([{kinds:[1],ids:[e]}],i=>{n(i),this.unsubscribe(o)},t);setTimeout(()=>{this.unsubscribe(o),s(new Error(`Timeout fetching event ${e}`))},1e4)})}catch(n){return console.error(`Error getting event ${e}:`,n),null}}async getProfilesByPubkeys(e){const t=this.getConnectedRelayUrls();if(e.length===0)return console.log("[NostrService] No pubkeys provided to getProfilesByPubkeys"),{};console.log(`[NostrService] Fetching ${e.length} profiles from relays:`,t);try{return new Promise(n=>{const s={},o=Date.now(),i=this.subscribe([{kinds:[0],authors:e}],a=>{if(a.kind===0&&a.pubkey)try{const c=JSON.parse(a.content);console.log(`[NostrService] Received profile for ${a.pubkey.slice(0,8)}:`,c.name||c.display_name||"No name"),c._event=a,s[a.pubkey]=c,Ut.emit(Ot.PROFILE_UPDATED,a.pubkey,c)}catch(c){console.error("Error parsing profile:",c)}},t);setTimeout(()=>{this.unsubscribe(i);const a=Date.now()-o;if(console.log(`[NostrService] Profile fetching completed in ${a}ms. Fetched ${Object.keys(s).length}/${e.length} profiles`),Object.keys(s).length<e.length){console.warn(`[NostrService] Some profiles couldn't be fetched in time (${Object.keys(s).length}/${e.length})`);const c=e.filter(l=>!s[l]);c.length>0&&console.warn(`[NostrService] Missing profiles for: ${c.map(l=>l.slice(0,8)).join(", ")}`)}n(s)},1e4)})}catch(n){return console.error("Error getting profiles:",n),{}}}async getUserProfile(e){if(console.log(`[NostrService] Getting profile for user ${(e==null?void 0:e.slice(0,8))||"unknown"}`),!e)return null;const n=(await this.getProfilesByPubkeys([e]))[e];return console.log(`[NostrService] Profile fetch result for ${e.slice(0,8)}:`,n?n.name||n.display_name||"No name":"Not found"),n||null}async verifyNip05(e,t){try{const[n,s]=e.split("@");if(!n||!s)return!1;const o=`https://${s}/.well-known/nostr.json?name=${n}`,a=await(await fetch(o)).json();return!!(a&&a.names&&a.names[n]===t)}catch(n){return console.error("Error verifying NIP-05:",n),!1}}async getAccountCreationDate(e){if(!e)return null;try{const t=this.getConnectedRelayUrls();return new Promise(n=>{const s=[{kinds:[G.META],authors:[e],limit:10,until:Math.floor(Date.now()/1e3)}];let o=null;const i=this.subscribe(s,a=>{(!o||a.created_at<o)&&(o=a.created_at)});setTimeout(()=>{this.unsubscribe(i),n(o)},5e3)})}catch(t){return console.error("Error fetching account creation date:",t),null}}async queryEvents(e){this.getConnectedRelayUrls().length===0&&(console.warn("No connected relays found, attempting to connect to default relays"),await this.connectToDefaultRelays());const n=this.getConnectedRelayUrls();if(n.length===0)return console.error("No relays available for querying events"),[];console.log("Using relays for querying events:",n),console.log("With filters:",e);try{return new Promise((s,o)=>{const i=[];let a="";const c=Date.now(),l=Math.min(5e3,1e3*e.length);try{if(a=this.subscribe(e,u=>{i.push(u)},n),!a){console.error("Failed to create subscription for query"),s([]);return}}catch(u){console.error("Error creating subscription:",u),s([]);return}const h=setTimeout(()=>{if(a){this.unsubscribe(a);const u=Date.now()-c;console.log(`Query completed in ${u}ms. Found ${i.length} events`),s(i)}},l);return()=>{clearTimeout(h),a&&this.unsubscribe(a)}})}catch(s){return console.error("Error querying events:",s),[]}}async fetchFollowingList(){if(this.publicKey)try{await this.connectToRelays(["wss://relay.damus.io","wss://relay.nostr.band","wss://nos.lol"]);const e=[{kinds:[G.CONTACTS],authors:[this.publicKey],limit:1}],t=this.subscribe(e,n=>{const s=n.tags.filter(o=>o.length>=2&&o[0]==="p").map(o=>o[1]);this.userManager.setFollowing(s)});setTimeout(()=>{this.unsubscribe(t)},5e3)}catch(e){console.error("Error fetching following list:",e)}}getConnectedRelayUrls(){return this.getRelayStatus().filter(e=>e.status==="connected").map(e=>e.url)}async muteUser(e){try{const t={kind:1e4,content:"",tags:[["d","mute-list"],["p",e]]};return!!await this.publishEvent(t)}catch(t){return console.error("Error muting user:",t),!1}}async unmuteUser(e){try{const n=(await this.getMutedUsers()).filter(i=>i!==e),s={kind:1e4,content:"",tags:[["d","mute-list"],...n.map(i=>["p",i])]};return!!await this.publishEvent(s)}catch(t){return console.error("Error unmuting user:",t),!1}}async isUserMuted(e){return(await this.getMutedUsers()).includes(e)}async getMutedUsers(){if(!this.publicKey)return[];try{return new Promise(e=>{const t=[],n=[{kinds:[1e4],authors:[this.publicKey],"#d":["mute-list"]}],s=this.subscribe(n,o=>{const i=o.tags.filter(a=>a.length>=2&&a[0]==="p").map(a=>a[1]);t.push(...i)});setTimeout(()=>{this.unsubscribe(s),e([...new Set(t)])},2e3)})}catch(e){return console.error("Error getting muted users:",e),[]}}async blockUser(e){try{const t={kind:1e4,content:"",tags:[["d","block-list"],["p",e]]};return!!await this.publishEvent(t)}catch(t){return console.error("Error blocking user:",t),!1}}async unblockUser(e){try{const n=(await this.getBlockedUsers()).filter(i=>i!==e),s={kind:1e4,content:"",tags:[["d","block-list"],...n.map(i=>["p",i])]};return!!await this.publishEvent(s)}catch(t){return console.error("Error unblocking user:",t),!1}}async isUserBlocked(e){return(await this.getBlockedUsers()).includes(e)}async getBlockedUsers(){if(!this.publicKey)return[];try{return new Promise(e=>{const t=[],n=[{kinds:[1e4],authors:[this.publicKey],"#d":["block-list"]}],s=this.subscribe(n,o=>{const i=o.tags.filter(a=>a.length>=2&&a[0]==="p").map(a=>a[1]);t.push(...i)});setTimeout(()=>{this.unsubscribe(s),e([...new Set(t)])},2e3)})}catch(e){return console.error("Error getting blocked users:",e),[]}}}const gf=new df;class wt{constructor(e){y(this,"service");this.service=e}get publicKey(){return this.service.publicKey}get following(){return this.service.following}async login(){return this.service.login()}signOut(){return this.service.signOut()}formatPubkey(e){return Ko(e)}getNpubFromHex(e){return Wo(e)}getHexFromNpub(e){return qo(e)}async publishEvent(e){return this.service.publishEvent(e)}subscribe(e,t){return this.service.subscribe(e,t)}unsubscribe(e){return this.service.unsubscribe(e)}async getAccountCreationDate(e){return typeof this.service.getAccountCreationDate=="function"?this.service.getAccountCreationDate(e):(console.warn("getAccountCreationDate not implemented in underlying service"),null)}async reactToPost(e,t){return typeof this.service.reactToPost=="function"?!!await this.service.reactToPost(e,t):(console.warn("reactToPost not implemented in underlying service"),!1)}async repostNote(e){return typeof this.service.repostNote=="function"?!!await this.service.repostNote(e,""):(console.warn("repostNote not implemented in underlying service"),!1)}async publishProfileMetadata(e){return typeof this.service.publishProfileMetadata=="function"?this.service.publishProfileMetadata(e):(console.warn("publishProfileMetadata not implemented in underlying service"),!1)}}class pf extends wt{constructor(t){super(t);y(this,"_following",[]);y(this,"socialManager");this.socialManager={likeEvent:async n=>this.reactToEvent(n.id,"+"),repostEvent:async n=>(console.log("Repost event not implemented yet"),null),getReactionCounts:async n=>({likes:0,reposts:0}),reactToEvent:async(n,s)=>this.reactToEvent(n,s||"+")}}async isFollowing(t){return!1}async followUser(t){return!1}async unfollowUser(t){return!1}async reactToEvent(t,n){if(!this.service.publicKey)return console.error("Cannot react to event: User not logged in"),null;try{const s={kind:7,content:n,tags:[["e",t]]},o=await this.service.publishEvent(s);return o?(console.log(`Reaction published with ID: ${o}`),o):(console.warn("Failed to publish reaction"),null)}catch(s){return console.error("Error reacting to event:",s),null}}async hasReactedToEvent(t,n){if(!this.service.publicKey)return!1;try{const s={kinds:[7],authors:[this.service.publicKey],"#e":[t]},o=await this.service.queryEvents([s]);return n?o.some(i=>i.content===n):o.length>0}catch(s){return console.error("Error checking reactions:",s),!1}}async getReactionsToEvent(t){try{const n={kinds:[7],"#e":[t]};return await this.service.queryEvents([n])}catch(n){return console.error("Error getting reactions:",n),[]}}async blockUser(t){return!1}async unblockUser(t){return!1}async muteUser(t){return!1}async unmuteUser(t){return!1}async isUserBlocked(t){return!1}async isUserMuted(t){return!1}async sendDirectMessage(t,n){return!1}async getDirectMessages(){return[]}get following(){return this._following}set following(t){this._following=t}async createCommunity(t,n){return this.service.createCommunity(t,n)}async createProposal(t,n,s,o,i){return this.service.createProposal(t,n,s,o,i)}async voteOnProposal(t,n){return this.service.voteOnProposal(t,n)}get communityManager(){return this.service.communityManager}}const yf=/^([a-zA-Z0-9_.-]+)@([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+)$/,jo=5e3;function mf(r){return r?yf.test(r):!1}function wf(r){if(!mf(r))return null;const[e,t]=r.split("@");return{name:e,domain:t}}function bf(r){return new Promise((e,t)=>{setTimeout(()=>t(new Error(`NIP-05 request timed out after ${r}ms`)),r)})}async function vf(r,e={},t=jo){return Promise.race([fetch(r,e),bf(t)])}async function zo(r,e={}){const t=wf(r);if(!t)return console.error(`Invalid NIP-05 identifier format: ${r}`),null;const{name:n,domain:s}=t;try{const o=`https://${s}/.well-known/nostr.json?name=${encodeURIComponent(n)}`,i=await vf(o,{headers:e.headers||{Accept:"application/json"}},e.timeoutMs||jo);if(!i.ok)return console.error(`NIP-05 HTTP error: ${i.status} for ${o}`),null;const a=await i.json();if(!a.names||typeof a.names!="object")return console.error(`Invalid NIP-05 JSON response: missing names field for ${o}`),null;const c=a.names[n];return c?{pubkey:c,relays:a.relays&&a.relays[c]?a.relays[c]:void 0,nip05_domain:s,nip05_name:n}:(console.error(`NIP-05 name not found: ${n} at ${s}`),null)}catch(o){return console.error(`NIP-05 fetch error for ${r}:`,o),null}}async function Ff(r,e){try{let t=e;if(e.startsWith("npub"))try{const s=ue.decode(e);if(s.type==="npub")t=s.data;else return!1}catch(s){return console.error("Invalid npub format:",s),!1}const n=await zo(r);return!!n&&n.pubkey===t}catch(t){return console.error("Error in verifyNip05:",t),!1}}async function Hf(r){try{const e=await zo(r);return!e||!e.relays?[]:Object.entries(e.relays).filter(([t,n])=>n.read).map(([t,n])=>t)}catch(e){return console.error("Error in discoverNip05Relays:",e),[]}}const $t=(r,e)=>{if(!r.tags||!Array.isArray(r.tags))return;const t=r.tags.find(n=>Array.isArray(n)&&n.length>=2&&n[0]===e);return t?t[1]:void 0};function Ef(r){const e=new Map;return!r||!r.tags||!Array.isArray(r.tags)||r.tags.forEach(t=>{if(Array.isArray(t)&&t[0]==="r"&&t.length>=2){const n=t[1];let s=!0,o=!0;t.length>=3&&(s=t.includes("read"),o=t.includes("write")),e.set(n,{read:s,write:o})}}),e}const Sn=r=>{if(r.kind!==1063)return null;try{const e=JSON.parse(r.content);return!e.url||!e.mime?(console.warn("Invalid NIP-94 event, missing required fields"),null):tt(e.url)?{url:e.url,mimeType:e.mime,hash:e.hash,size:e.size,dimensions:e.dim?{width:e.dim.w,height:e.dim.h}:void 0,alt:e.alt,blurhash:e.blurhash,description:e.description}:(console.warn("Invalid media URL in NIP-94 event:",e.url),null)}catch(e){return console.error("Error parsing NIP-94 file metadata:",e),null}},Kf=r=>r.kind===1063&&!!Sn(r),Wf=r=>{const e=Sn(r);return(e==null?void 0:e.url)||null},qf=r=>{const e=Sn(r);return(e==null?void 0:e.alt)||null};class xf extends wt{async addRelay(e,t=!0){return this.service.addRelay(e,t)}removeRelay(e){return this.service.removeRelay(e)}getRelayStatus(){return this.service.getRelayStatus()}getRelayUrls(){return this.service.getRelayUrls()}async getRelaysForUser(e){try{return new Promise(t=>{let n=!1,s;const o=this.service.subscribe([{kinds:[10002],authors:[e],limit:1}],i=>{if(i.kind===10002){const a=Ef(i),c=Array.from(a.keys());this.service.unsubscribe(o),clearTimeout(s),n=!0,t(c)}});s=setTimeout(()=>{if(!n){this.service.unsubscribe(o);const i=["wss://relay.damus.io","wss://nostr.bitcoiner.social","wss://relay.nostr.band","wss://nos.lol"];console.log(`No relay list found for ${e}, using fallback relays`),t(i)}},5e3)})}catch(t){return console.error("Error fetching user relays:",t),["wss://relay.damus.io","wss://nostr.bitcoiner.social","wss://relay.nostr.band","wss://nos.lol"]}}async connectToDefaultRelays(){return this.service.connectToUserRelays()}async connectToUserRelays(){return this.service.connectToUserRelays()}async addMultipleRelays(e){if(!e||!e.length)return 0;let t=0;const n=[];for(const s of e)try{await this.addRelay(s)?t++:n.push(s)}catch(o){console.error(`Failed to add relay ${s}:`,o),n.push(s)}return n.length>0&&t>0&&console.warn(`Failed to add ${n.length} relays:`,n),t}async publishRelayList(e){try{const t={kind:10002,content:"",tags:e.map(s=>{const o=["r",s.url];return s.read&&o.push("read"),s.write&&o.push("write"),o})};return!!await this.service.publishEvent(t)}catch(t){return console.error("Error publishing relay list:",t),!1}}async getRelayInfos(e){return Promise.all(e.map(async t=>{try{return{url:t,info:await this.relayManager.getRelayInformation(t)}}catch{return{url:t,info:null}}}))}get relayManager(){return this.service.relayManager}}class Af extends wt{constructor(e){super(e)}async getUserProfile(e){return this.service.getUserProfile(e)}async updateProfile(e){try{return await this.service.publishEvent({kind:0,content:JSON.stringify(e),tags:[]}),!0}catch(t){return console.error("Error updating profile:",t),!1}}async getFollowing(e){try{const t=await this.service.queryEvents([{kinds:[3],authors:[e],limit:1}]);return t.length>0?t[0].tags.filter(s=>s[0]==="p").map(s=>s[1]).filter(Boolean):[]}catch(t){return console.error("Error getting following list:",t),[]}}async followUser(e){try{const t=await this.getFollowing(this.service.publicKey);if(t.includes(e))return!0;const n=t.map(s=>["p",s]);return n.push(["p",e]),await this.service.publishEvent({kind:3,content:"",tags:n}),!0}catch(t){return console.error("Error following user:",t),!1}}async unfollowUser(e){try{const s=(await this.getFollowing(this.service.publicKey)).filter(o=>o!==e).map(o=>["p",o]);return await this.service.publishEvent({kind:3,content:"",tags:s}),!0}catch(t){return console.error("Error unfollowing user:",t),!1}}async queryEvents(e){return this.service.queryEvents(e)}async getEventsByIds(e){return this.service.getEvents(e)}async getEvent(e){const t=await this.service.getEvents([e]);return t.length>0?t[0]:null}async getEventsByAuthor(e,t){return this.service.queryEvents([{authors:[e],kinds:[1],limit:t||50}])}}class Sf extends wt{async sendDirectMessage(e,t){var n;try{if(!this.service.publicKey)throw new Error("Not logged in");let o,i=[["p",e]],a=G.ENCRYPTED_DM;if(console.log(`Sending message to ${e}`),(n=window.nostr)!=null&&n.nip04)try{o=await window.nostr.nip04.encrypt(e,t)}catch(l){throw console.error("Error encrypting message with NIP-04:",l),new Error("Failed to encrypt message")}else throw console.error("No encryption available - Nostr extension does not support nip04"),new Error("Encryption not supported by your Nostr extension");const c={kind:a,content:o,tags:i};return this.service.publishEvent(c)}catch(s){throw console.error("Error sending direct message:",s),s}}async decryptDirectMessage(e,t,n=4){var s;try{if((s=window.nostr)!=null&&s.nip04)try{return window.nostr.nip04.decrypt(e,t)}catch(o){throw console.error("Error with NIP-04 decryption:",o),new Error("Failed to decrypt message")}else throw new Error("Decryption not supported by your Nostr extension")}catch(o){throw console.error("Error decrypting direct message:",o),o}}}class Rf extends wt{constructor(t){super(t);y(this,"storagePrefix","blocknoster_article_draft_")}async publishArticle(t,n,s={},o=[],i){if(!this.service.publicKey)return console.error("Cannot publish article: User not logged in"),null;if(!t||!n)return console.error("Cannot publish article: Title and content are required"),null;try{const a={kind:30023,content:n,tags:[["title",t],...o]};s.summary&&a.tags.push(["summary",s.summary]),s.image&&a.tags.push(["image",s.image]),s.published_at&&a.tags.push(["published_at",s.published_at.toString()]),s.hashtags&&s.hashtags.length>0&&s.hashtags.forEach(l=>{a.tags.push(["t",l])}),i&&a.tags.push(["e",i,"","root"]),console.log("Publishing article with event:",a);const c=await this.service.publishEvent(a);return c?(console.log(`Article published successfully with event ID: ${c}`),c):(console.warn("Failed to publish article"),null)}catch(a){return console.error("Error publishing article:",a),null}}async getArticleById(t){try{return await this.service.getEventById(t)}catch(n){return console.error(`Error fetching article with ID ${t}:`,n),null}}async getArticlesByAuthor(t,n=10){try{console.log(`Fetching articles by author ${t}`);const s=[{authors:[t],kinds:[30023],limit:n}],o=await this.service.queryEvents(s);return console.log(`Found ${o.length} articles by author ${t}`),o}catch(s){return console.error(`Error fetching articles by author ${t}:`,s),[]}}async searchArticles(t){try{const{query:n,author:s,hashtag:o,since:i,until:a,limit:c=20}=t;console.log("ArticleAdapter: Searching articles with params:",t);const l={kinds:[30023],limit:c};s&&(l.authors=[s]),i&&(l.since=i),a&&(l.until=a),o&&(l["#t"]=[o]),console.log("Using filter:",l);let h=await this.service.queryEvents([l]);if(console.log(`Query returned ${h.length} articles`),n&&n.trim().length>0){const u=n.toLowerCase();h=h.filter(f=>{var d,p;const g=(d=$t(f,"title"))==null?void 0:d.toLowerCase();if(g&&g.includes(u))return!0;const m=(p=$t(f,"summary"))==null?void 0:p.toLowerCase();return m&&m.includes(u)?!0:f.content.toLowerCase().includes(u)}),console.log(`After text filtering, found ${h.length} articles`)}return h}catch(n){return console.error("Error searching articles:",n),[]}}async getRecommendedArticles(t=10){return await this.searchArticles({limit:t,since:Math.floor(Date.now()/1e3)-604800})}saveDraft(t){const n=t.id||`draft_${Date.now()}`,s={...t,id:n,updatedAt:Date.now()};return localStorage.setItem(`${this.storagePrefix}${n}`,JSON.stringify(s)),n}getDraft(t){const n=localStorage.getItem(`${this.storagePrefix}${t}`);return n?JSON.parse(n):null}getAllDrafts(){const t=[];for(let n=0;n<localStorage.length;n++){const s=localStorage.key(n);if(s&&s.startsWith(this.storagePrefix)){const o=localStorage.getItem(s);o&&t.push(JSON.parse(o))}}return t.sort((n,s)=>s.updatedAt-n.updatedAt)}deleteDraft(t){return localStorage.removeItem(`${this.storagePrefix}${t}`),!0}async getArticleVersions(t){try{const n={kinds:[30023],"#e":[t]};return(await this.service.queryEvents([n])).map(i=>({eventId:i.id,createdAt:i.created_at,title:$t(i,"title")||"Untitled",summary:$t(i,"summary")})).sort((i,a)=>a.createdAt-i.createdAt)}catch(n){return console.error(`Error fetching article versions for ${t}:`,n),[]}}}class Tf extends wt{constructor(t){super(t);y(this,"socialAdapter");y(this,"relayAdapter");y(this,"dataAdapter");y(this,"messagingAdapter");y(this,"articleAdapter");this.socialAdapter=new pf(t),this.relayAdapter=new xf(t),this.dataAdapter=new Af(t),this.articleAdapter=new Rf(t),this.messagingAdapter=new Sf(t)}get social(){return this.socialAdapter}get relay(){return this.relayAdapter}get data(){return this.dataAdapter}get community(){return this.socialAdapter}get messaging(){return this.messagingAdapter}get article(){return this.articleAdapter}isFollowing(t){return this.socialAdapter.isFollowing(t)}async followUser(t){return this.socialAdapter.followUser(t)}async unfollowUser(t){return this.socialAdapter.unfollowUser(t)}async sendDirectMessage(t,n){const s=Fe.selectBestRelays(this.relayAdapter.getRelayUrls(),{operation:"write",count:3,requireWriteSupport:!0,minScore:40});return s.length>0&&await this.relayAdapter.addMultipleRelays(s),this.socialAdapter.sendDirectMessage(t,n)}async muteUser(t){return this.socialAdapter.muteUser(t)}async unmuteUser(t){return this.socialAdapter.unmuteUser(t)}async isUserMuted(t){return this.socialAdapter.isUserMuted(t)}async blockUser(t){return this.socialAdapter.blockUser(t)}async unblockUser(t){return this.socialAdapter.unblockUser(t)}async isUserBlocked(t){return this.socialAdapter.isUserBlocked(t)}async updateProfile(t){if(!this.service.publicKey)return console.error("Cannot update profile: not logged in"),!1;try{if(console.log("Updating profile metadata with:",t),t.nip05){if(!await this.isValidNip05Format(t.nip05))return console.error("Invalid NIP-05 identifier format:",t.nip05),!1;console.log("NIP-05 identifier provided:",t.nip05)}const n={kind:0,content:JSON.stringify(t),tags:[]},s=Fe.selectBestRelays(this.relayAdapter.getRelayUrls(),{operation:"write",count:3,requireWriteSupport:!0,minScore:40});s.length>0&&await this.relayAdapter.addMultipleRelays(s);const o=await this.service.publishEvent(n);return o?(console.log(`Profile updated successfully with event ID: ${o}`),t.nip05&&(console.log(`NIP-05 identifier set to: ${t.nip05}`),console.log("To complete NIP-05 verification, ensure your domain serves .well-known/nostr.json")),!0):(console.warn("Failed to publish profile update event"),!1)}catch(n){return console.error("Error updating profile:",n),!1}}async isValidNip05Format(t){return/^[a-z0-9_.-]+@[a-z0-9.-]+$/.test(t)}async updateProfileWithNip05(t,n=!1){if(!this.service.publicKey)return console.error("Cannot update profile: not logged in"),!1;try{if(n&&t.nip05){if(console.log("Verifying NIP-05 identifier before update..."),!await this.verifyNip05(t.nip05,this.service.publicKey))return console.error(`NIP-05 verification failed for ${t.nip05}`),console.log("Profile update cancelled. Please ensure your domain's .well-known/nostr.json is properly configured."),!1;console.log(`NIP-05 identifier ${t.nip05} verified successfully!`)}return this.updateProfile(t)}catch(s){return console.error("Error updating profile with NIP-05:",s),!1}}async addRelay(t,n=!0){const s=performance.now();if(j.getState(t)===Ct.OPEN)return console.log(`Circuit breaker preventing connection to ${t}`),!1;try{const o=await this.relayAdapter.addRelay(t,n),i=performance.now()-s;return o?(le.trackResponseTime(t,"connect",i),j.recordSuccess(t)):(le.recordFailure(t,"connect","Failed to connect"),j.recordFailure(t)),o}catch(o){return le.recordFailure(t,"connect",String(o)),j.recordFailure(t),!1}}removeRelay(t){return j.reset(t),this.relayAdapter.removeRelay(t)}getRelayStatus(){return this.relayAdapter.getRelayStatus().map(n=>{const s=le.getRelayPerformance(n.url);return{...n,score:(s==null?void 0:s.score)||50,avgResponse:s==null?void 0:s.avgResponseTime}})}getRelayUrls(){return this.relayAdapter.getRelayUrls()}async getRelaysForUser(t){return this.relayAdapter.getRelaysForUser(t)}async connectToDefaultRelays(){const t=this.relayAdapter.getRelayUrls();if(t.length>0){const n=Fe.selectBestRelays(t,{operation:"both",count:Math.min(5,t.length),minScore:0});if(n.length>0)return await this.addMultipleRelays(n),n}return this.relayAdapter.connectToDefaultRelays()}async connectToUserRelays(){const t=this.relayAdapter.getRelayUrls();if(t.length>0){const n=Fe.selectBestRelays(t,{operation:"both",count:Math.min(5,t.length),minScore:0});if(n.length>0){await this.addMultipleRelays(n);return}}return this.relayAdapter.connectToUserRelays()}async addMultipleRelays(t){const n=t.filter(s=>j.getState(s)!==Ct.OPEN);return this.relayAdapter.addMultipleRelays(n)}async publishRelayList(t){const n=t.map(o=>{const i=le.getRelayPerformance(o.url);return{...o,score:(i==null?void 0:i.score)||50}});n.sort((o,i)=>(i.score||50)-(o.score||50));const s=Fe.selectBestRelays(n.filter(o=>o.write).map(o=>o.url),{operation:"write",count:3,requireWriteSupport:!0});return s.length>0&&await this.addMultipleRelays(s),this.relayAdapter.publishRelayList(t)}async getEventById(t){return this.dataAdapter.getEvent(t)}async getEvents(t){return this.dataAdapter.getEventsByIds(t)}async getProfilesByPubkeys(t){return this.service.getProfilesByPubkeys(t)}async getUserProfile(t){return this.dataAdapter.getUserProfile(t)}async verifyNip05(t,n){return this.service.verifyNip05(t,n)}async getEventsByUser(t){return this.dataAdapter.getEventsByAuthor(t)}async createCommunity(t,n){return this.socialAdapter.createCommunity(t,n)}async createProposal(t,n,s,o,i){return this.socialAdapter.createProposal(t,n,s,o,i)}async voteOnProposal(t,n){return this.socialAdapter.voteOnProposal(t,n)}async publishArticle(t,n,s={},o=[]){return this.articleAdapter.publishArticle(t,n,s,o)}async getArticleById(t){return this.articleAdapter.getArticleById(t)}async getArticlesByAuthor(t,n=10){return this.articleAdapter.getArticlesByAuthor(t,n)}async searchArticles(t){return console.log("NostrAdapter.searchArticles called with params:",t),this.articleAdapter.searchArticles(t)}async getRecommendedArticles(t=10){return this.articleAdapter.getRecommendedArticles(t)}saveDraft(t){return this.articleAdapter.saveDraft(t)}getDraft(t){return this.articleAdapter.getDraft(t)}getAllDrafts(){return this.articleAdapter.getAllDrafts()}deleteDraft(t){return this.articleAdapter.deleteDraft(t)}async getArticleVersions(t){return this.articleAdapter.getArticleVersions(t)}get socialManager(){return this.socialAdapter.socialManager}get relayManager(){return this.relayAdapter.relayManager}get communityManager(){return this.socialAdapter.communityManager}}const Z=new Tf(gf);export{Ot as E,df as N,If as O,Fr as P,Lt as S,Z as a,G as b,Ft as c,Hf as d,Ut as e,zo as f,Qh as g,Df as h,mf as i,$t as j,Ko as k,Kf as l,ce as m,Of as n,Uf as o,Bf as p,qf as q,Wf as r,tt as s,ct as t,it as u,Ff as v,jh as w,Fe as x};
